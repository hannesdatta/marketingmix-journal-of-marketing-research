---
title: "GfK Singapore"
output:
  html_document
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(data.table)
require(stargazer)
library(knitr)
require(xtable)
require(texreg)
library(sjstats)

options(xtable.comment = FALSE)

# Load results
  load(file = c('../temp/results_20180302.RData'))

# determine model to analyze
  results_brands <- results_MCI_lev#results_MCI_diffed_onlyFGLS #results_MNLw_quarter#results_MNL_diffed#results_MNL #results_MCI_notrend #results_MCI #results_MNL
  
# identify model crashes
	checks <- unlist(lapply(results_brands, class))
	table(checks)
	last.item = length(analysis_markets)

# load data
	brand_panel=fread('../temp/preclean.csv')
	brand_panel[, ':=' (date = as.Date(date))]
	
	# elasticities
	elast <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$elast))

	# merge some more variables to it
	vars = c('cat_class', 'country_class')
	tmp = brand_panel[, c('market_id', vars), with=F]
	setkey(tmp, market_id)
	tmp = unique(tmp)
	
	elast = merge(elast, tmp, all.x=T, all.y=F, by = c('market_id'))
	
	
new <- c('tablets', 'phones_smart')

wb_lowermidx = c('india','indonesia', 'vietnam', 'philippines')
wb_uppermidx = c('china', 'malaysia','thailand')


elast[, new:=category%in%new]
elast[, wb_lowermid:=country%in%wb_lowermidx]
elast[, wb_uppermid:=country%in%wb_uppermidx]

elast[, low := wb_lowermid+wb_uppermid]

tableno<<-0
figureno<<-0
fig<-function(caption) {figureno<<-figureno+1;paste0('Figure ', figureno, ': ', caption)}
tab<-function(caption) {tableno<<-tableno+1;paste0('Table ', tableno, ': ', caption)}
```

# Estimation sample

## Overview

Number of markets: `r length(unique(elast$market_id))`.
Number of brands: `r nrow(elast[, .N, by = c('market_id', 'brand')])`.
Number of unique brands: `r nrow(elast[, .N, by = c('brand')])`.
Number of markets which could not be estimated due to errors: `r length(which(!checks=='list'))`.

## Elasticities

### Short-term

```{r elast_overall, echo = FALSE, results='asis'}
.vars=c('llen','wpswdst','rwpspr','nov6sh')
	zval=1.64
	tmp=elast[!is.na(coef), list(median_elast = median(elast), 
												  w_elast = sum(elast/elast_se)/sum(1/elast_se), 
												  N_brands= .N, 
												  perc_positive = length(which(z>=(zval)))/.N, 
												  perc_null = length(which(abs(z)<zval))/.N, 
												  perc_negative = length(which(z<=(-zval)))/.N), by=c('variable')]
	kable(tmp[match(.vars, variable)], caption = tab('Short-term elasticities by variable for all brands (significance tested at p<.1 (z >= 1.64).'))
	

	#Copulas
	copulas <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$model@coefficients))
	copulas <- copulas[grepl('cop_', varname)]
	
	tmp=copulas[!is.na(coef), list(median = median(coef), 
											  N_brands= .N, 
											  perc_positive = length(which(z>=(zval)))/.N, 
											  perc_null = length(which(abs(z)<zval))/.N, 
											  perc_negative = length(which(z<=(-zval)))/.N), by=c('varname')]

	kable(tmp, caption = 'Copula terms by variable (used for getting an understanding about significance)')

	# Normality of copula terms
	#Copulas
	copulanormality <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$cop_nonnormal))
	
	tmp=copulanormality[!is.na(shap_pval), list(N_tests = .N,
	                                       perc_normal = length(which(shap_pval>.1))/.N,
	                                       perc_nonnormal = length(which(shap_pval<=.1))/.N),
	                                       by=c('variable')]
	

	kable(tmp, caption = 'Assessing non-normality of marketing mix instruments')
	
	# Assessing carry-over coefficients
	carryover <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$model@coefficients))
	carryover <- carryover[grepl('lagunitsales[_]', varname)]
  benchmark_brands <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) data.table(market_id=unique(x$specs$market_id), benchmarkbrand = x$benchmark_brand)))
	
	# maybe do an MCI instead?!
	
```

# Carry-over coefficients
```{r carryover, echo = FALSE, results='asis'}
kable(data.table(t(summary(carryover$coef)))[, ':=' (V1=NULL, value=N, N=NULL)], caption = "Distribution of carry-over coefficients",col.names = NA)
hist(carryover$coef, main = 'Distribution of carry-over coefficients')
```	
	

# VIFs

```{r vif, echo = FALSE, results='asis'}
vifs <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$vif))
.vars <- table(vifs$variable)[which(table(vifs$variable)>600)]

tmp=vifs[variable%in%names(.vars)][, list(mean=mean(vif), min=min(vif), max=max(vif), median=median(vif), perc_below6=length(which(vif<=6))/.N,perc_below10=length(which(vif<=10))/.N),by=c('variable')]


kable(tmp, caption = "VIFs by variable")

```	



