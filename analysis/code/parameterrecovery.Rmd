---
title: "Parameter recovery w/ Copulas"
author: "Hannes Datta"
date: "2/4/2021"
output: html_document
---

```{r setup, include=TRUE}

# Load required packages
library(data.table)
library(MASS)

# Initialize random number
set.seed(1234)

sim_data <- function(rho=.5, sig=.5) {
  N = 120 # sample size
  
  #
  data = data.table(date=1:N)
  data[, quarter:=floor(((date-1)%%12)/3)+1]
  for (i in 1:3) data[,paste0('quarter',i):=ifelse(quarter==i, 1, 0)]
  
  
  data[, trend:=log(1:.N+1)]
  y_0 = 12
  k = 4
  x = matrix(runif(k*N),ncol=k)
  colnames(x) <- paste0('x', 1:k)
  
  data <- cbind(data,x)
  data[, intercept:=1]
  
  beta = c(
    'intercept' = 0,
    'quarter1' = 1,
    'quarter2' = -1,
    'quarter3' = -.5,
    'trend' = .1,
    'x1' = 1,
    'x2' = -2,
    'x3' = .5,
    'x4' = 2,
    'ly' = .9
  )
  
 # rho = .5
  
  # Correlation matrix
  R = matrix(c(1, rho, rho, rho,
               rho, 1, 0, 0,
               rho, 0, 1, 0,
               rho, 0, 0, 1), ncol = 4)
  # Standard deviations
  
  S <- c(sqrt(sig), sqrt(sig), sqrt(sig), sqrt(sig))
  
  cor2cov <- function(R, S) {
    sweep(sweep(R, 1, S, "*"), 2, S, "*")
  }
  
  Sigma = cor2cov(R, S)
  
  # Draws from the Var-Covar Matrix
  
  error = mvrnorm(n = N,
                  mu = c(0, 0, 0, 0),
                  Sigma = Sigma)
  
  # x1 endog
  F_x=pnorm(error[,2])
  pi_vals=c(-2,2)
  x=qgamma(F_x,.5)
  data[, x1:=x]
  
  # x2 endog
  F_x=pnorm(error[,3])
  pi_vals=c(-2,2)
  x=qgamma(F_x,.5)
  data[, x2:=x]
  # x3 endog
  F_x=pnorm(error[,4])
  pi_vals=c(-2,2)
  x=qgamma(F_x,.5)
  data[, x3:=x]
  
  	  
  data[, ly:=as.numeric(NA)]
  data[1, ly:=0]
  data[, y:=as.numeric(NA)]  
  
  #shapiro.test(data$x1)
 
  data=data.frame(data)
  
  # simulate data 
  for (i in 1:N) {
    ysim <- as.matrix(data[i, names(beta)]) %*% beta + error[i, 1]
    
    data[i, 'y'] <-  ysim
    if (i < N)
      data[i + 1, 'ly'] <- ysim
    
 }
  data=data.table(data)
  
  make_copula <- function(x, increment = .001) {
    if (length(unique(x)) == 1)
      return(as.numeric(rep(NA, length(x))))
    return(ifelse(ecdf(x)(x) == 1, qnorm(1 - increment), qnorm(ecdf(x)(x))))
  }
  
  data[, dy := y - c(NA, y[-.N])]
  
  for (v in grep('x[0-9]', colnames(data), value = T)) {
    data[, paste0(v, '_star') := make_copula(get(v))]
    data[, paste0('l', v) := c(NA, get(v)[-.N])]
    data[, paste0('l', v, '_star') := make_copula(get(paste0('l', v)))]
    data[, paste0('d', v) := get(v) - c(NA, get(v)[-.N])]
  }
  
  return(data)
}

```

# Recovery with Error Correction

```{r}
reps = 100
set.seed(1234)
data <- lapply(1:reps, function(...) sim_data(rho=.5))

out1 = lapply(data, function(dt)
  lm(
    dy ~ 1 + dx1 + dx2 + dx3 + dx4 + trend + ly + quarter1 + quarter2 + quarter3 +
      lx1 + lx2 + lx3 + lx4,
    data = dt
  )$coefficients)

out2 = lapply(data, function(dt)
  lm(
    dy ~ 1 + dx1 + dx2 + dx3 + dx4 + trend + ly + quarter1 + quarter2 + quarter3 +
      lx1 + lx2 + lx3 + lx4 + x1_star + x2_star + x3_star,
    data = dt
  )$coefficients)

# summarize coefficients
for (out in list(out1, out2)) {
  
o = do.call('rbind', out)
res=colMeans(o)

for (i in 1:4) o[,paste0('lx', i)]<- (-o[,paste0('lx', i)])/o[,'ly']
true = c(dx1=1, dx2=-2, dx3=.5, dx4=2, lx1=1/.1, lx2=-2/.1, lx3=.5/.1, lx4=2/.1)

par(mfrow=c(2,4))

vars=grep('^dx[0-9]$|lx[0-9]$', colnames(o), value=T)

for (i in seq(along=vars)) {
  hist(o[,vars[i]], breaks=20, main = vars[i])
  abline(v=true[i], col='red')
}

}

```

# Simulate data

```{r eval=FALSE, include=FALSE, results='asis'}

# Recovery

#print(cor(data$x1, data$x1_star))

library(stargazer)
m1 <- lm(y~1+quarter1+quarter2+quarter3+trend+x1+x2+x3+x4+ly, data = data[[1]])
m2 <- lm(y~1+quarter1+quarter2+quarter3+trend+x1+x2+x3+x4+x1_star+x2_star+x3_star+ly, data = data[[1]])

stargazer(m1,m2, type='html')

```


```{r eval=FALSE, include=FALSE}
# Loop

all_res=rbindlist(lapply(data, function(dt) {
  mcor=lm(y~1+quarter1+quarter2+quarter3+trend+x1+x2+x3+x4+x1_star+x2_star+x3_star+ly, data = dt)
  m=lm(y~1+quarter1+quarter2+quarter3+trend+x1+x2+x3+x4+ly, data = dt)
  return(data.table(biased_x1 = m$coefficients['x1'], corrected_x1 = mcor$coefficients['x1'],
                    biased_x1 = m$coefficients['x2'], corrected_x1 = mcor$coefficients['x2'],
                    biased_x1 = m$coefficients['x3'], corrected_x1 = mcor$coefficients['x3']
                    
                    
                    ))
  
}))

summary(all_res)
#hist(all_res$biased,breaks=20, main = 'Histogram of parameter without Copula correction')
#hist(all_res$corrected,breaks=20, main = 'Histogram of parameter with Copula correction')

# true:  'x1' = 1, 'x2' = -2, 'x3' = .5

```

