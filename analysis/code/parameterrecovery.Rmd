---
title: "Parameter recovery w/ Copulas"
author: "Hannes Datta"
date: "1/18/2021"
output: html_document
---

```{r setup, include=FALSE}
library(data.table)
set.seed(1234)
N = 120
data = data.table(date=1:N)
data[, quarter:=floor(((date-1)%%12)/3)+1]
for (i in 1:3) data[,paste0('quarter',i):=ifelse(quarter==i, 1, 0)]


data[, trend:=log(1:.N+1)]
y_0 = 12
k = 4
x = matrix(runif(k*N),ncol=k)
colnames(x) <- paste0('x', 1:k)

data <- cbind(data,x)
data[, intercept:=1]

beta = c('intercept' = 0, 'quarter1' = 1, 'quarter2' = -1, 'quarter3' = -.5, 'trend' = .1, 'x1' = 1, 'x2' = -2, 'x3' = .5, 'x4'=2, 'ly' = .9)

rho = .5

# Correlation matrix
R = matrix(c(1, rho,
                rho, 1), ncol=2)
# Standard deviations
S <- c(sqrt(.5), sqrt(.5))

cor2cov <- function(R, S) {
 sweep(sweep(R, 1, S, "*"), 2, S, "*")
}

Sigma = cor2cov(R, S)
  
# Draws from the Var-Covar Matrix
  
library(MASS)
set.seed(1234)

error = mvrnorm(n = N, mu = c(0,0), Sigma =Sigma)
  
F_x=pnorm(error[,2])
pi_vals=c(-2,2)
x = F_x*(max(pi_vals)-min(pi_vals))+min(pi_vals)
data[, x1:=x]
	  
data[, ly:=as.numeric(NA)]
data[1, ly:=0]
data[, y:=as.numeric(NA)]  

for (i in 1:N) {
  ysim <- as.matrix(data[i, names(beta),with=F])%*%beta + error[i,1]
  
  data[i, y:=ysim]
  if (i<N) data[i+1, ly:=ysim]

}
  
```

# Simulate data

```{r}

# Recovery
make_copula <- function(x, increment = .001) {
		if (length(unique(x))==1) return(as.numeric(rep(NA, length(x))))
		return(ifelse(ecdf(x)(x)==1, qnorm(1-increment), qnorm(ecdf(x)(x))))
}
data[, x1_star:=make_copula(x1)]

library(stargazer)
m1 <- lm(y~1+quarter1+quarter2+quarter3+trend+x1+x2+x3+x4+ly, data = data)
m2 <- lm(y~1+quarter1+quarter2+quarter3+trend+x1+x2+x3+x4+x1_star+ly, data = data)

stargazer(m1,m2, type='text')

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
