---
title: "Parameter recovery w/ Copulas"
author: "Hannes Datta"
date: "2/4/2021"
output: html_document
---

```{r setup, include=TRUE}

# Load required packages
library(data.table)
library(MASS)

# Initialize random number
set.seed(1234)



sim_data <- function() {
  N =120 # sample size
  
  #
  data = data.table(date=1:N)
  data[, quarter:=floor(((date-1)%%12)/3)+1]
  for (i in 1:3) data[,paste0('quarter',i):=ifelse(quarter==i, 1, 0)]
  
  
  data[, trend:=log(1:.N+1)]
  y_0 = 12
  k = 4
  x = matrix(runif(k*N),ncol=k)
  colnames(x) <- paste0('x', 1:k)
  
  data <- cbind(data,x)
  data[, intercept:=1]
  
  beta = c('intercept' = 0, 'quarter1' = 1, 'quarter2' = -1, 'quarter3' = -.5, 'trend' = .1, 'x1' = 1, 'x2' = -2, 'x3' = .5, 'x4'=2, 'ly' = .9)
  
  rho = .5
  
  # Correlation matrix
  R = matrix(c(1, rho, rho, rho,
               rho, 1, 0, 0,
               rho, 0, 1, 0,
               rho, 0, 0, 1), ncol=4)
  # Standard deviations
  
  S <- c(sqrt(.5), sqrt(.5), sqrt(.5), sqrt(.5))
  
  cor2cov <- function(R, S) {
   sweep(sweep(R, 1, S, "*"), 2, S, "*")
  }
  
  Sigma = cor2cov(R, S)
    
  # Draws from the Var-Covar Matrix
  
  error = mvrnorm(n = N, mu = c(0,0,0,0), Sigma =Sigma)
  
  # x1 endog
  F_x=pnorm(error[,2])
  pi_vals=c(-2,2)
  x=qgamma(F_x,.5)
  data[, x1:=x]
  
  # x2 endog
  F_x=pnorm(error[,3])
  pi_vals=c(-2,2)
  x=qgamma(F_x,.5)
  data[, x2:=x]
  # x3 endog
  F_x=pnorm(error[,4])
  pi_vals=c(-2,2)
  x=qgamma(F_x,.5)
  data[, x3:=x]
  
  
  #x = F_x*(max(pi_vals)-min(pi_vals))+min(pi_vals)
  
  #hist(x)
  #print(shapiro.test(x))
  
  #xx=qunif(F_x,min(pi_vals),max(pi_vals))
  
  # let's take gamma distribution
  # loop e.g., 500 times to rule out influence of seed value
  
  	  
  data[, ly:=as.numeric(NA)]
  data[1, ly:=0]
  data[, y:=as.numeric(NA)]  
  
  
  #hist(data$x1)
  #cor(data$x1, data$x1_star)
  
  shapiro.test(data$x1)
  
  for (i in 1:N) {
    ysim <- as.matrix(data[i, names(beta),with=F])%*%beta + error[i,1]
    
    data[i, y:=ysim]
    if (i<N) data[i+1, ly:=ysim]
  
  
  }
  
  make_copula <- function(x, increment = .001) {
		if (length(unique(x))==1) return(as.numeric(rep(NA, length(x))))
		return(ifelse(ecdf(x)(x)==1, qnorm(1-increment), qnorm(ecdf(x)(x))))
  }
  
  data[, x1_star:=make_copula(x1)]
data[, x2_star:=make_copula(x2)]
data[, x3_star:=make_copula(x3)]

  return(data)
}

```

```{r}


set.seed(1984)

reps = 100

data <- lapply(1:reps, function(...) sim_data())

```


# Simulate data

```{r, results='asis',echo=FALSE}

# Recovery

#print(cor(data$x1, data$x1_star))

library(stargazer)
m1 <- lm(y~1+quarter1+quarter2+quarter3+trend+x1+x2+x3+x4+ly, data = data[[1]])
m2 <- lm(y~1+quarter1+quarter2+quarter3+trend+x1+x2+x3+x4+x1_star+x2_star+x3_star+ly, data = data[[1]])

stargazer(m1,m2, type='html')

```


```{r}
# Loop

all_res=rbindlist(lapply(data, function(dt) {
  mcor=lm(y~1+quarter1+quarter2+quarter3+trend+x1+x2+x3+x4+x1_star+x2_star+x3_star+ly, data = dt)
  m=lm(y~1+quarter1+quarter2+quarter3+trend+x1+x2+x3+x4+ly, data = dt)
  return(data.table(biased_x1 = m$coefficients['x1'], corrected_x1 = mcor$coefficients['x1'],
                    biased_x1 = m$coefficients['x2'], corrected_x1 = mcor$coefficients['x2'],
                    biased_x1 = m$coefficients['x3'], corrected_x1 = mcor$coefficients['x3']
                    
                    
                    ))
  
}))

summary(all_res)
#hist(all_res$biased,breaks=20, main = 'Histogram of parameter without Copula correction')
#hist(all_res$corrected,breaks=20, main = 'Histogram of parameter with Copula correction')

# true:  'x1' = 1, 'x2' = -2, 'x3' = .5

```

