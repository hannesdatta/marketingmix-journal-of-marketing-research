---
title: "Inspection of new elasticities (p = .05, w/ copulas)"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(knitr)
library(kableExtra)
elast <- fread('../output/elast_results_salesresponse_max3_p10_cop_sur.csv')
vars <- grep('elast.*[0-9]{1,2}$', colnames(elast), value=T)

for (.v in vars) {
  elast[, paste0(.v,'_z'):=get(.v)/get(paste0(.v,'_sd'))]
  elast[, paste0(.v,'_w'):=(1/get(paste0(.v,'_sd')))/sum((1/get(paste0(.v,'_sd'))))]
}

sigz = qnorm(1-(.1)/2)

```


# Simulation scheme

- 1000 draws from variance-covariance matrix of parameter estimates
- one-period shock (which is mathematically equivalent to shocks in *any* other period, and hence also the mean of those); this has been empirically verified 

Definition of elasticities:

- "dust settling period": sum of difference of log-level sales on a dataset with shocked mmix instruments, and baseline log-level sales
- "long-term elasticity: difference of log-level sales on a dataset with shocked mmix instruments, and baseline log-level sales in one period (e.g., 12 months after shock)

Measures:

1. elast1: short-term elasticities (difference of log level sales w/ shocked mmix, and baseline log level sales)
2. elast6: sum of (1) over 6 months
3. elast12: sum of (1) over 12 months
4. elast12lt: difference in log-level sales 12 months after shock

Variables:

a. Price (ln rwpspr)
b. Distribution (ln wpswdst)
c. Line length (ln llen)

## Descriptive statistics

Overview includes weighted mean elasticities, and an assessment about significance (percentage positive/negative & significant, percentage not significant).

```{r, echo = FALSE}
suppressWarnings({tmp = melt(elast, id.vars=c('brand_id','modeltype','varname', 'Ndraws', 'Nperiods'))})
#tmp

tmp[, raw_variable:=gsub('[_].*$','', variable)]
tmp[, stat:=gsub('.*[_]','', variable)]
tmp[!stat%in%c('sd','z','w'), stat:='est']

tmp = data.table(dcast(tmp, modeltype+brand_id+varname+raw_variable~stat))

setnames(tmp, 'raw_variable','variable')

tmp2 = tmp[, list(N=.N, mean=mean(est), median=median(est), weightedmean = sum(est*w)/sum(w), min = min(est), max=max(est),
                  perc_positive = length(which(est>0&abs(z)>=sigz))/.N,
                  perc_negative = length(which(est<0&abs(z)>=sigz))/.N,
                  perc_ns = length(which(abs(z)<sigz))/.N), by = c('varname','variable')]

tmp2[, orderv:=match(varname, c('lnrwpspr', 'lnwpswdst','lnllen'))]
setorder(tmp2, orderv, variable)
tmp2[, orderv:=NULL]
kable(tmp2, format = "latex", booktabs = TRUE, digits = 3) %>%
          kable_styling(latex_options = "scale_down")
```

## Descriptive stats by model type

### Models in levels
```{r, echo = FALSE}


tmp2 = tmp[modeltype=='ardl-levels', list(N=.N, mean=mean(est), median=median(est), weightedmean = sum(est*w)/sum(w), min = min(est), max=max(est),
                  perc_positive = length(which(est>0&abs(z)>=sigz))/.N,
                  perc_negative = length(which(est<0&abs(z)>=sigz))/.N,
                  perc_ns = length(which(abs(z)<sigz))/.N), by = c('varname','variable')]

tmp2[, orderv:=match(varname, c('lnrwpspr', 'lnwpswdst','lnllen'))]
setorder(tmp2, orderv, variable)
tmp2[, orderv:=NULL]
kable(tmp2, format = "latex", booktabs = TRUE, digits = 3) %>%
          kable_styling(latex_options = "scale_down")


```

### Models in differences
```{r, echo = FALSE}


tmp2 = tmp[modeltype=='ardl-firstdiff', list(N=.N, mean=mean(est), median=median(est), weightedmean = sum(est*w)/sum(w), min = min(est), max=max(est),
                  perc_positive = length(which(est>0&abs(z)>=sigz))/.N,
                  perc_negative = length(which(est<0&abs(z)>=sigz))/.N,
                  perc_ns = length(which(abs(z)<sigz))/.N), by = c('varname','variable')]

tmp2[, orderv:=match(varname, c('lnrwpspr', 'lnwpswdst','lnllen'))]
setorder(tmp2, orderv, variable)
tmp2[, orderv:=NULL]
kable(tmp2, format = "latex", booktabs = TRUE, digits = 3) %>%
          kable_styling(latex_options = "scale_down")


```


### Models in EC
```{r, echo = FALSE}

tmp2 = tmp[modeltype=='ardl-ec', list(N=.N, mean=mean(est), median=median(est), weightedmean = sum(est*w)/sum(w), min = min(est), max=max(est),
                  perc_positive = length(which(est>0&abs(z)>=sigz))/.N,
                  perc_negative = length(which(est<0&abs(z)>=sigz))/.N,
                  perc_ns = length(which(abs(z)<sigz))/.N), by = c('varname','variable')]

tmp2[, orderv:=match(varname, c('lnrwpspr', 'lnwpswdst','lnllen'))]
setorder(tmp2, orderv, variable)
tmp2[, orderv:=NULL]
kable(tmp2, format = "latex", booktabs = TRUE, digits = 3) %>%
          kable_styling(latex_options = "scale_down")


```


## Plots

- Distribution of mean parameter
- Distribution of standard errors
- Distribution of z values

### Short-term (elast1)

```{r, echo=FALSE}
par(mfrow=c(1,3))
hist(tmp[grepl('elast1$', variable)&grepl('pr', varname)]$est,breaks=100, main = 'Price (mean elast1)', xlab = 'variable')
hist(tmp[grepl('elast1$', variable)&grepl('pr', varname)]$sd,breaks=100, main = 'Price (SD elast1)', xlab = 'variable')
hist(tmp[grepl('elast1$', variable)&grepl('pr', varname)]$z,breaks=100, main = 'Price (Z elast1)', xlab = 'variable')

hist(tmp[grepl('elast1$', variable)&grepl('llen', varname)]$est,breaks=100, main = 'Line length (elast1)', xlab = 'variable')
hist(tmp[grepl('elast1$', variable)&grepl('llen', varname)]$sd,breaks=100, main = 'Line length (SD elast1)', xlab = 'variable')
hist(tmp[grepl('elast1$', variable)&grepl('llen', varname)]$z,breaks=100, main = 'Line length (Z elast1)', xlab = 'variable')

hist(tmp[grepl('elast1$', variable)&grepl('dst', varname)]$est,breaks=100, main = 'Distribution (elast1)', xlab = 'variable')
hist(tmp[grepl('elast1$', variable)&grepl('dst', varname)]$sd,breaks=100, main = 'Distribution (SD elast1)', xlab = 'variable')
hist(tmp[grepl('elast1$', variable)&grepl('dst', varname)]$z,breaks=100, main = 'Distribution (Z elast1)', xlab = 'variable')

```


### Dust-settling (6 months) (elast6)

```{r, echo=FALSE}
par(mfrow=c(1,3))
hist(tmp[grepl('elast6$', variable)&grepl('pr', varname)]$est,breaks=100, main = 'Price (mean elast6)', xlab = 'variable')
hist(tmp[grepl('elast6$', variable)&grepl('pr', varname)]$sd,breaks=100, main = 'Price (SD elast6)', xlab = 'variable')
hist(tmp[grepl('elast6$', variable)&grepl('pr', varname)]$z,breaks=100, main = 'Price (Z elast6)', xlab = 'variable')

hist(tmp[grepl('elast6$', variable)&grepl('llen', varname)]$est,breaks=100, main = 'Line length (elast6)', xlab = 'variable')
hist(tmp[grepl('elast6$', variable)&grepl('llen', varname)]$sd,breaks=100, main = 'Line length (SD elast6)', xlab = 'variable')
hist(tmp[grepl('elast6$', variable)&grepl('llen', varname)]$z,breaks=100, main = 'Line length (Z elast6)', xlab = 'variable')

hist(tmp[grepl('elast6$', variable)&grepl('dst', varname)]$est,breaks=100, main = 'Distribution (elast6)', xlab = 'variable')
hist(tmp[grepl('elast6$', variable)&grepl('dst', varname)]$sd,breaks=100, main = 'Distribution (SD elast6)', xlab = 'variable')
hist(tmp[grepl('elast6$', variable)&grepl('dst', varname)]$z,breaks=100, main = 'Distribution (Z elast6)', xlab = 'variable')

```


### Long-term (12 months) (elast12lt)

```{r, echo=FALSE}
par(mfrow=c(1,3))
hist(tmp[grepl('elastlt12$', variable)&grepl('pr', varname)]$est,breaks=100, main = 'Price (mean elastlt12)', xlab = 'variable')
hist(tmp[grepl('elastlt12$', variable)&grepl('pr', varname)]$sd,breaks=100, main = 'Price (SD elastlt12)', xlab = 'variable')
hist(tmp[grepl('elastlt12$', variable)&grepl('pr', varname)]$z,breaks=100, main = 'Price (Z elastlt12)', xlab = 'variable')

hist(tmp[grepl('elastlt12$', variable)&grepl('llen', varname)]$est,breaks=100, main = 'Line length (elastlt12)', xlab = 'variable')
hist(tmp[grepl('elastlt12$', variable)&grepl('llen', varname)]$sd,breaks=100, main = 'Line length (SD elastlt12)', xlab = 'variable')
hist(tmp[grepl('elastlt12$', variable)&grepl('llen', varname)]$z,breaks=100, main = 'Line length (Z elastlt12)', xlab = 'variable')

hist(tmp[grepl('elastlt12$', variable)&grepl('dst', varname)]$est,breaks=100, main = 'Distribution (elastlt12)', xlab = 'variable')
hist(tmp[grepl('elastlt12$', variable)&grepl('dst', varname)]$sd,breaks=100, main = 'Distribution (SD elastlt12)', xlab = 'variable')
hist(tmp[grepl('elastlt12$', variable)&grepl('dst', varname)]$z,breaks=100, main = 'Distribution (Z elastlt12)', xlab = 'variable')

```
