---
title: "GfK Singapore - Marketshare model audit"
output:
  html_document
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(stargazer)
library(knitr)
library(xtable)
library(texreg)
library(sjstats)
library(metap)

options(xtable.comment = FALSE)

# Load results
load(file = c('../output/results_marketshare.RData'))

# determine model to analyze
  results_brands <-  results_marketshare
  
# identify model crashes
	checks <- unlist(lapply(results_brands, class))
	table(checks)
	last.item = length(analysis_markets)

# obtain elasticities
	elast <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$elast))

# obtain data on the use of copula terms 
	cops <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) data.table(x$model@coefficients)[!grepl('lagunitsales_sh|dum|trend', varname)&!grepl('quarter', brand), c('varname', 'market_id', 'brand', 'coef','z'),with=F]))

	# split brands
	cops[, copula:='main']
	cops[grepl('cop[_]',varname), copula:='copula']
	
	cops[copula=='copula', varname:=sapply(varname, function(x) strsplit(x, '[_]')[[1]][2])]
	cops[, all:='total']
	
# add indicator to copula
	setkey(cops, market_id, brand, varname)
	setkey(elast, market_id, brand, variable)
	
	elast[cops[copula=='copula'], ':=' (cop_coef = i.coef, cop_z = i.z)]
	
	
	## Load panel data
	brand_panel=fread('../temp/preclean_main.csv')
	brand_panel[, ':=' (date = as.Date(date))]

	if(0){
	# verify how often it occurs that only one brand remains in the market
	tmp=brand_panel[, list(.N),by=c('category','country','market_id','date')]
	tmp[1:.N]
	
	tmp2=dcast(tmp, category+country+market_id~date, value.var='N',fill='')
	
	write.table(tmp2, 'clipboard',row.names=F,sep='\t', fill='')
	}
	

# get an idea which brands
tableno<<-0
figureno<<-0
fig<-function(caption) {figureno<<-figureno+1;paste0('Figure ', figureno, ': ', caption)}
tab<-function(caption) {tableno<<-tableno+1;paste0('Table ', tableno, ': ', caption)}
```

# Estimation sample

## Overview

Number of markets: `r length(unique(elast$market_id))`.
Number of brands: `r nrow(elast[, .N, by = c('market_id', 'brand')])`.
Number of unique brands: `r nrow(elast[, .N, by = c('brand')])`.
Number of markets which could not be estimated due to errors: `r length(which(!checks=='list'))`.

```{r elast_overall, echo = FALSE, results='asis'}

.vars=c('llen','wpswdst','rwpspr','nov12sh')

zval=1.64
	
  tmp=elast[!is.na(elast)&!brand%in%c('unbranded','super', 'amazon'), list(w_elast_st = sum(elast/elast_se)/sum(1/elast_se), 
                                w_elast_lt = sum(elastlt/elastlt_se)/sum(1/elastlt_se),
                                N_copula = length(which(!is.na(cop_coef))),
                                N=.N,
                                share_copula=length(which(!is.na(cop_coef)))/.N), by=c('variable')]
  
	kable(tmp[match(.vars, variable)], caption = tab('Short- and long-term elasticities by variable, excluding unbranded, super, and amazon (significance tested at p<.1 (z >= 1.64).'))

	setkey(brand_panel, market_id)
	setkey(elast, market_id)
	elast[brand_panel, country_class:=i.country_class]
	
  tmp=elast[!is.na(elast)&!brand%in%c('unbranded','super', 'amazon'), list(N_effects=.N,
                                                                           N_copula = length(which(!is.na(cop_coef))),
                                share_copula=length(which(!is.na(cop_coef)))/.N), by=c('variable','country_class')]
  
	kable(tmp, caption = tab('Short- and long-term elasticities by variable and a country\'s development status, excluding the brands unbranded, super, and amazon (significance tested at p<.1 (z >= 1.64).'))

	sbbe<-fread('../output/elast_results_marketshare.csv')
	setkey(sbbe, market_id, brand)
	setkey(elast, market_id, brand)
	elast[sbbe, sbbe:=i.sbbe_std]
	elast[, brandequity:=ifelse(sbbe>0, 'high BE', 'low BE')]
	
 tmp=elast[!is.na(elast)&!brand%in%c('unbranded','super', 'amazon'), list(N_effects=.N,
                                                                           N_copula = length(which(!is.na(cop_coef))),
                                share_copula=length(which(!is.na(cop_coef)))/.N), by=c('variable', 'brandequity')]
  
	kable(tmp, caption = tab('Short- and long-term elasticities by variable and brand equity, excluding brands unbranded, super, and amazon (significance tested at p<.1 (z >= 1.64).'))
	  
	#Copulas
	copulas <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$model@coefficients))
	copulas <- copulas[grepl('cop_', varname)]
	

		
	tmp=copulas[!is.na(coef), list(median = median(coef), 
											  N_brands= .N, 
											  perc_positive = length(which(z>=(zval)))/.N, 
											  perc_null = length(which(abs(z)<zval))/.N, 
											  perc_negative = length(which(z<=(-zval)))/.N), by=c('varname')]

	kable(tmp, caption = 'Copula terms by variable (used for getting an understanding about significance)')

			tmp=lapply(c('all', 'varname'), function(bycol) {
	  tmp=cops[, list(total_N=length(which(copula=='main')), total_copula=length(which(copula=='copula'))), by= bycol]
	  tmp[, share:=total_copula/total_N]
	  return(tmp)
	  	})

	kable(tmp[[1]], caption = 'Overall copula share')

	# Normality of potentially endogeneous regressors
	#Copulas
	copulanormality <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$cop_nonnormal))
	
	tmp=copulanormality[!is.na(shap_pval), list(N_tests = .N,
	                                       perc_normal = length(which(shap_pval>.1))/.N,
	                                       perc_nonnormal = length(which(shap_pval<=.1))/.N),
	                                       by=c('variable')]
	
  tmp2=copulanormality[!is.na(shap_pval), list(N_tests = .N,
	                                       perc_normal = length(which(shap_pval>.1))/.N,
	                                       perc_nonnormal = length(which(shap_pval<=.1))/.N)]
	

	kable(tmp, caption = 'Assessing non-normality of marketing mix instruments (by variable)')
	kable(tmp2, caption = 'Assessing non-normality of marketing mix instruments (collapsed)')
	
	# Assessing carry-over coefficients
	tmp <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$model@coefficients))
	tmp <- tmp[grepl('lagunitsales[_]', varname)]
	# check markets
	carryover <- data.table(market_id=unlist(lapply(results_brands[!checks=='try-error'], function(x) x$market_id)))
	setkey(carryover, market_id)
	setkey(tmp, market_id)
	carryover[tmp, coef:=i.coef]
	carryover[is.na(coef), coef:=0]
	
	
  benchmark_brands <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) data.table(market_id=unique(x$specs$market_id), benchmarkbrand = x$benchmark_brand)))
	
```

# Carry-over coefficients
```{r carryover, echo = FALSE, results='asis'}
kable(data.table(t(summary(carryover$coef)))[, ':=' (V1=NULL, value=N, N=NULL)], caption = "Distribution of carry-over coefficients",col.names = NA)
hist(carryover$coef, main = 'Distribution of carry-over coefficients')
```	
	
# Carry-over coefficients
```{r carryover2, echo = FALSE, results='asis'}
mids = unique(carryover[coef==0]$market_id)
kable(unique(brand_panel[market_id%in%mids, c('market_id','category','country'),with=F], by=c('market_id')))
kable(data.table(t(summary(carryover[coef>0]$coef)))[, ':=' (V1=NULL, value=N, N=NULL)], caption = "Distribution of carry-over coefficients conditional on not zero",col.names = NA)

hist(carryover$coef, main = 'Distribution of carry-over coefficients')
```	
	

# Panel unit root tests

```{r unitroot, echo = FALSE}

  
  # obtain elasticities
	ur_raw <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$adf_sur))

  ur_raw <- ur_raw[variable=='y']

 # specify tests
  iter = c('market_id', 'category', 'country', 'individ')
  
  ur_raw[, individ:=1:.N]
  
  ur_by = rbindlist(lapply(iter, function(.byvar) {
    ur_raw[, splitvar := get(.byvar)]
    te= split(ur_raw, ur_raw$splitvar)
      
    out=NULL
      for (j in 1:length(te)) {
        test_data=te[[j]]
        pval = NA
        if (nrow(test_data)==1) {
          plogitp=test_data$p
          pfisher=test_data$p
          pstouffer=test_data$p
          } else {
            tmpX=allmetap(test_data$p, method=c('logitp','sumlog','sumz'))
            plogitp=unlist(tmpX[which(rownames(tmpX)=='logitp'),"p"])
            pfisher=unlist(tmpX[which(rownames(tmpX)=='sumlog'),"p"])
            pstouffer=unlist(tmpX[which(rownames(tmpX)=='sumz'),"p"])
            
          }
        
        splitvar = unique(test_data$splitvar)
        out[[j]]<-data.table(by = .byvar, name=splitvar, variable='y', 
                   test= c('logitp','fisher','stouffer'),
                   pval = c(plogitp, pfisher, pstouffer))
      }
    rbindlist(out)
  }
  ))
  
#  ur_by <- fread('../output/ur_tests.csv')
test_results=ur_by[, list(N=length(which(!is.na(pval))), N_stationary = length(which(pval<=.1)), N_UR = length(which(pval>.1))), by = c('by','test')]

kable(test_results, caption='Summary of UR tests on the log ratio of market shares')
```

```{r plot_distributions, echo=FALSE}

for (var in unique(elast$variable)) {
  par(mfrow=c(1,2))
  hist(elast[variable==var]$elast, main = paste0('Histogram for ', var))
  boxplot(elast[variable==var]$elast, main = paste0('Boxplot for ', var))
}

```


```{r autocorrel, echo=TRUE}

autocorrel= unlist(lapply(results_brands[!checks=='try-error'], function(x) x$model@rho))

summary(autocorrel)
summary(abs(autocorrel))
```

```{r r2, echo=TRUE}

r2s= rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$R2))

summary(r2s$R2)

```


```{r, include=FALSE}
library(data.table)
library(knitr)
library(kableExtra)

vars <- c('elast','elastlt')


for (.v in vars) {
  elast[, paste0(.v,'_z'):=get(.v)/get(paste0(.v,'_se'))]
  elast[, paste0(.v,'_w'):=(1/get(paste0(.v,'_se')))/sum((1/get(paste0(.v,'_se'))))]
}

```



## Descriptive statistics

```{r, echo = FALSE}
void<-capture.output({
  
  suppressWarnings({tmp = melt(elast, id.vars=c('market_id','brand', 'variable'), measure.vars=grep('elast',colnames(elast),value=T))})
})

setnames(tmp, 'variable','varname')
setnames(tmp, c('variable.1'), 'variable')

tmp[, brand_id:=.GRP,by=c('market_id','brand')]

tmp[, raw_variable:=gsub('[_].*$','', variable)]
tmp[, stat:=gsub('.*[_]','', variable)]
tmp[!stat%in%c('se','z','w'), stat:='est']

tmp = data.table(dcast(tmp, brand_id+varname+raw_variable~stat))

setnames(tmp, 'raw_variable','variable')

tmp2 = tmp[, list(N=.N, mean=mean(est), median=median(est), weightedmean = sum(est*w)/sum(w), min = min(est), max=max(est),
                  perc_positive = length(which(est>0&abs(z)>=1.69))/.N,
                  perc_negative = length(which(est<0&abs(z)>=1.69))/.N,
                  perc_ns = length(which(abs(z)<1.69))/.N), by = c('varname','variable')]

tmp2[, orderv:=match(varname, c('rwpspr', 'wpswdst','llen'))]
setorder(tmp2, orderv, variable)
tmp2[, orderv:=NULL]
kable(tmp2, format = "latex", booktabs = TRUE, digits = 3) %>%
          kable_styling(latex_options = "scale_down")

```

## Plots

## Plots

- Distribution of mean parameter
- Distribution of standard errors
- Distribution of z values

### Short-term (elast1)

```{r, echo=FALSE}
par(mfrow=c(1,3))
hist(tmp[grepl('elast$', variable)&grepl('pr', varname)]$est,breaks=100, main = 'Price (mean elast)', xlab = 'variable')
hist(tmp[grepl('elast$', variable)&grepl('pr', varname)]$se,breaks=100, main = 'Price (SD elast)', xlab = 'variable')
hist(tmp[grepl('elast$', variable)&grepl('pr', varname)]$z,breaks=100, main = 'Price (Z elast)', xlab = 'variable')

hist(tmp[grepl('elast$', variable)&grepl('llen', varname)]$est,breaks=100, main = 'Line length (elast)', xlab = 'variable')
hist(tmp[grepl('elast$', variable)&grepl('llen', varname)]$se,breaks=100, main = 'Line length (SD elast)', xlab = 'variable')
hist(tmp[grepl('elast$', variable)&grepl('llen', varname)]$z,breaks=100, main = 'Line length (Z elast)', xlab = 'variable')

hist(tmp[grepl('elast$', variable)&grepl('dst', varname)]$est,breaks=100, main = 'Distribution (elast)', xlab = 'variable')
hist(tmp[grepl('elast$', variable)&grepl('dst', varname)]$se,breaks=100, main = 'Distribution (SD elast)', xlab = 'variable')
hist(tmp[grepl('elast$', variable)&grepl('dst', varname)]$z,breaks=100, main = 'Distribution (Z elast)', xlab = 'variable')

```


### Long-term (elastlt)


```{r, echo=FALSE}
par(mfrow=c(1,3))
hist(tmp[grepl('elastlt$', variable)&grepl('pr', varname)]$est,breaks=100, main = 'Price (mean elastlt)', xlab = 'variable')
hist(tmp[grepl('elastlt$', variable)&grepl('pr', varname)]$se,breaks=100, main = 'Price (SD elastlt)', xlab = 'variable')
hist(tmp[grepl('elastlt$', variable)&grepl('pr', varname)]$z,breaks=100, main = 'Price (Z elastlt)', xlab = 'variable')

hist(tmp[grepl('elastlt$', variable)&grepl('llen', varname)]$est,breaks=100, main = 'Line length (elastlt)', xlab = 'variable')
hist(tmp[grepl('elastlt$', variable)&grepl('llen', varname)]$se,breaks=100, main = 'Line length (SD elastlt)', xlab = 'variable')
hist(tmp[grepl('elastlt$', variable)&grepl('llen', varname)]$z,breaks=100, main = 'Line length (Z elastlt)', xlab = 'variable')

hist(tmp[grepl('elastlt$', variable)&grepl('dst', varname)]$est,breaks=100, main = 'Distribution (elastlt)', xlab = 'variable')
hist(tmp[grepl('elastlt$', variable)&grepl('dst', varname)]$se,breaks=100, main = 'Distribution (SD elastlt)', xlab = 'variable')
hist(tmp[grepl('elastlt$', variable)&grepl('dst', varname)]$z,breaks=100, main = 'Distribution (Z elastlt)', xlab = 'variable')

```