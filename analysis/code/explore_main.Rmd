---
title: "`r markdown_title`" 
#"`r commandArgs(trailingOnly=T)[1]`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(stargazer)
library(knitr)
library(DT)

```

## Model fit

```{r}
r2s = unlist(lapply(results_model, function(x) x$r2_within_dv))
summary(r2s)
```

The mean R2 (within, on the dependent variable) is `r mean(r2s,na.rm=T)*100`.

## Example model specification for one brand

Let us first look at the model results for *one* example brand. I've generated this to illustrate the model configuration (i.e., covariates) and dependent variable.

```{r, results = 'asis', echo = FALSE, include= TRUE}
#ids = unlist(lapply(results_model, function(x) x$elast$brand_id[1]))
#id=ids[1]#which(ids==bid)
id=1
stargazer(results_model[[id]]$model, type='html')
cat(paste0('Dependent variable: ', colnames(results_model[[id]]$model$model)[id]), fill =T)
cat(paste0('Removed variables (due to ns.): ', paste0( results_model[[id]]$kicked_out_coefs, collapse=', ')), fill =T)

```

## Summary of elasticities

### by variable type

```{r, echo = FALSE}


tmp = elast_model[!is.na(elastlt), list(N=.N,mean=mean(elastlt), min=min(elastlt), max = max(elastlt), sd=sd(elastlt), perc_pos_sig = length(which(elastlt>0&abs(z)>=zval_sig))/.N,
                                        perc_neg_sig = length(which(elastlt<0&abs(z)>=zval_sig))/.N,
                                        perc_ns = length(which(abs(z)<zval_sig))/.N),by=c('variable')]
kable(tmp)
```

### by variable type

```{r, echo = FALSE}

tmp = elast_model[!is.na(elastlt), list(N=.N,mean=mean(elastlt), 
                                   q01 = quantile(elastlt,.01),
                                   q025 = quantile(elastlt,.025),
                                   q05 = quantile(elastlt,.05),
                                   q10 = quantile(elastlt,.10),
                                   q50 = quantile(elastlt,.5),
                                   q80 = quantile(elastlt,.8),
                                   q90 = quantile(elastlt,.90),
                                   q95 = quantile(elastlt,.95),
                                   q975 = quantile(elastlt,.975),
                                   q99 = quantile(elastlt,.99)),by=c('variable')]

kable(tmp)
```

### by category and variable type

```{r, echo = FALSE}

tmp = elast_model[!is.na(elastlt), list(N=.N,mean=mean(elastlt), min=min(elastlt), max = max(elastlt), sd=sd(elastlt), perc_pos_sig = length(which(elastlt>0&abs(z)>=zval_sig))/.N,
                                        perc_neg_sig = length(which(elastlt<0&abs(z)>=zval_sig))/.N,
                                        perc_ns = length(which(abs(z)<zval_sig))/.N),by=c('variable', 'category')]
setorder(tmp,variable, category)

kable(tmp)

```

## Summary of VIFs

### by covariate

```{r, echo = FALSE}

tmp = vifs_model[, list(N=.N,mean=mean(vif), median=median(vif),min=min(vif), max = max(vif),
                        vif_under_4=length(which(vif<=4))/.N, 
                        vif_under_10=length(which(vif<=10))/.N,
                        vif_under_20=length(which(vif<=20))/.N,
                        vif_under_100=length(which(vif<=100))/.N
                        ),by=c('variable')]
setorderv(tmp,'mean', order=-1L)

kable(tmp, caption = 'VIFs, ordered in descending order of mean VIFs')

```

### by category

```{r, echo = FALSE}

tmp = vifs_model[, list(N=.N,mean=mean(vif), min=min(vif), max = max(vif)),by=c('category')]
setorderv(tmp,'mean', order=-1L)

kable(tmp, caption = 'VIFs, ordered in descending order of mean VIFs')

```

### for a few example models

```{r, echo  = FALSE, results = 'asis'}
for (bid in c(10,100,1000)) print(kable(vifs_model[brand_id==bid], caption = paste0('VIFs for brand_id ', bid)))
```



```{r, echo = FALSE, include = FALSE}
### VIFs (scrollable table in descending order of VIFs, capped at 1000 entries)
if(0){
tmp=vifs_model
setorderv(tmp, 'vif',order=-1L)
DT::datatable(head(tmp,1000))
### VIFs (scrollable table without product attributes in descending order of VIFs, capped at 1000 entries)

tmp=vifs_model[!grepl('attr[_]', variable)]
setorderv(tmp, 'vif',order=-1L)
DT::datatable(head(tmp,1000))
}
```
