---
title: "GfK Singapore"
output:
  html_document
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(data.table)
require(stargazer)
library(knitr)
require(xtable)
require(texreg)
library(sjstats)

options(xtable.comment = FALSE)

# Load results
 # load(file = c('../temp/results_20180313.RData'))
load(file = c('../output/results14june2018.RData'))

# determine model to analyze
  results_brands <-  results_nov12sh #results_MCI_wlag_wotrend #results_MCI_wolag_trend#results_MCI_wlag_wotrend #results_MCI_wolag_trend# results_MCI_wlag_wotrend #results_MCI_wolag_trend #
  
# identify model crashes
	checks <- unlist(lapply(results_brands, class))
	table(checks)
	last.item = length(analysis_markets)

# obtain elasticities
	elast <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$elast))

	cops <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) data.table(x$model@coefficients)[!grepl('lagunitsales_sh|dum|trend', varname)&!grepl('quarter', brand), c('varname', 'brand', 'market_id'),with=F]))

	# split brands
	cops[, copula:='main']
	cops[grepl('cop[_]',varname), copula:='copula']
	
	cops[copula=='copula', varname:=sapply(varname, function(x) strsplit(x, '[_]')[[1]][2])]

#	tmp=dcast(cops, market_id+brand+varname)
	cops[, all:='total']
	# stats on used copula terms
	# total number of variables
	tmp=lapply(c('all', 'varname'), function(bycol) {
	  tmp=cops[, list(total_N=length(which(copula=='main')), total_copula=length(which(copula=='copula'))), by= bycol]
	  tmp[, share:=total_copula/total_N]
	  return(tmp)
	  	})

	
# get an idea which brands
tableno<<-0
figureno<<-0
fig<-function(caption) {figureno<<-figureno+1;paste0('Figure ', figureno, ': ', caption)}
tab<-function(caption) {tableno<<-tableno+1;paste0('Table ', tableno, ': ', caption)}
```

# Estimation sample

## Overview

Number of markets: `r length(unique(elast$market_id))`.
Number of brands: `r nrow(elast[, .N, by = c('market_id', 'brand')])`.
Number of unique brands: `r nrow(elast[, .N, by = c('brand')])`.
Number of markets which could not be estimated due to errors: `r length(which(!checks=='list'))`.

## Elasticities

### Short-term

```{r elast_overall, echo = FALSE, results='asis'}
  .vars=c('llen','wpswdst','rwpspr','nov6sh')
	
  zval=1.64
	tmp=elast[!is.na(elast), list(median_elast = median(elast), 
												  w_elast = sum(elast/elast_se)/sum(1/elast_se), 
												  N_brands= .N, 
												  N_copulas = length(which(is.na(get(paste0('cop_', variable))))),
												  perc_positive = length(which(elast/elast_se>=(zval)))/.N, 
												  perc_null = length(which(abs(elast/elast_se)<zval))/.N, 
												  perc_negative = length(which(elast/elast_se<=(-zval)))/.N), by=c('variable')]
	kable(tmp[match(.vars, variable)], caption = tab('Short-term elasticities by variable for all brands (significance tested at p<.1 (z >= 1.64).'))
	
  zval=1.64
	tmp=elast[!is.na(elast), list(median_elast = median(elastlt), 
												  w_elast = sum(elastlt/elastlt_se)/sum(1/elastlt_se), 
												  N_brands= .N, 
												  N_copulas = length(which(is.na(get(paste0('cop_', variable))))),
												  perc_positive = length(which(elastlt/elastlt_se>=(zval)))/.N, 
												  perc_null = length(which(abs(elastlt/elastlt_se)<zval))/.N, 
												  perc_negative = length(which(elastlt/elastlt_se<=(-zval)))/.N), by=c('variable')]
	kable(tmp[match(.vars, variable)], caption = tab('Long-term elasticities by variable for all brands (significance tested at p<.1 (z >= 1.64).'))
	
	
	#Copulas
	copulas <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$model@coefficients))
	copulas <- copulas[grepl('cop_', varname)]
	
	tmp=copulas[!is.na(coef), list(median = median(coef), 
											  N_brands= .N, 
											  perc_positive = length(which(z>=(zval)))/.N, 
											  perc_null = length(which(abs(z)<zval))/.N, 
											  perc_negative = length(which(z<=(-zval)))/.N), by=c('varname')]

	kable(tmp, caption = 'Copula terms by variable (used for getting an understanding about significance)')

	
	
	# Normality of potentially endogeneous regressors
	#Copulas
	copulanormality <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$cop_nonnormal))
	
	tmp=copulanormality[!is.na(shap_pval), list(N_tests = .N,
	                                       perc_normal = length(which(shap_pval>.1))/.N,
	                                       perc_nonnormal = length(which(shap_pval<=.1))/.N),
	                                       by=c('variable')]
	
  tmp2=copulanormality[!is.na(shap_pval), list(N_tests = .N,
	                                       perc_normal = length(which(shap_pval>.1))/.N,
	                                       perc_nonnormal = length(which(shap_pval<=.1))/.N)]
	

	kable(tmp, caption = 'Assessing non-normality of marketing mix instruments (by variable)')
	kable(tmp2, caption = 'Assessing non-normality of marketing mix instruments (collapsed)')
	
	# Assessing carry-over coefficients
	tmp <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) x$model@coefficients))
	tmp <- tmp[grepl('lagunitsales[_]', varname)]
	# check markets
	carryover <- data.table(market_id=unlist(lapply(results_brands, function(x) x$market_id)))
	setkey(carryover, market_id)
	setkey(tmp, market_id)
	carryover[tmp, coef:=i.coef]
	carryover[is.na(coef), coef:=0]
	
  benchmark_brands <- rbindlist(lapply(results_brands[!checks=='try-error'], function(x) data.table(market_id=unique(x$specs$market_id), benchmarkbrand = x$benchmark_brand)))
	
```

# Carry-over coefficients
```{r carryover, echo = FALSE, results='asis'}
kable(data.table(t(summary(carryover$coef)))[, ':=' (V1=NULL, value=N, N=NULL)], caption = "Distribution of carry-over coefficients",col.names = NA)
hist(carryover$coef, main = 'Distribution of carry-over coefficients')
```	
	
