---
title: "GfK Singapore - Results"
output:
  html_document: default
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

libs_to_load <- c('data.table', 'stargazer', 'knitr', 'xtable', 'lme4', 'car', 'kableExtra', 'stringi', 'ggplot2', 'ggpubr', 'plyr', 'gridExtra', 'grid')
for (lib in libs_to_load) eval(parse(text=paste('library(', lib, ')')))

options(xtable.comment = FALSE)
options(knitr.kable.NA = '')

# Load data
  elast <- fread('../externals/elast_results_nov12sh.csv') #[globalbrand==T]
  #elast <- fread('../externals/elast_results_nov12sh.csv')#[category%in%c('camera_slr', 'tablets')]

  brand_panel=fread('../../analysis/temp/preclean.csv')

  if (0) {
tmp=brand_panel[, list(avgprice=mean(rwpsprd)),by=c('market_id','category','country','brand')][, list(pricedispersion=(max(avgprice)-min(avgprice))/mean(avgprice)),by=c('market_id','category','country')]
setorder(tmp, pricedispersion)
tmp[, rank:=rank(pricedispersion)/.N]

setkey(tmp, market_id)
setkey(brand_panel, market_id)
setkey(elast, market_id)
brand_panel[tmp, rankquantile:=i.rank]

elast[tmp, rankquantile:=i.rank]


elast <- elast[rankquantile>=.2]
  }


brand_panel[, ':=' (date = as.Date(date))]
  
mean_usd = brand_panel[, lapply(.SD, mean,na.rm=T), .SDcols=c('llen','nov12sh','nwprd','wpswdst'), by = c('market_id','brand')]
mean_usd2 = melt(mean_usd, id.vars=c('market_id','brand'))
mean_usd2[variable=='nwprd',variable:='rwpspr']

setkey(mean_usd2, market_id,brand,variable)
setkey(elast, market_id, brand, variable)
elast[mean_usd2, meanglobalx:=i.value]

# Load auxilary functions
  source('proc_auxilary.R')
  source('proc_rename.R')

# Preclean data
  source('preclean.R')
  
# set order of variables to appear in figures and tables
ordered_vars = c('rwpspr', 'wpswdst','llen','nov12sh')
names(ordered_vars) <- paste0(unlist(sanitize_table(data.frame(ordered_vars))), ' elasticity')

#elast[, cntrymissing:=0]

#elast[is.na(country_of_origin), ':=' (local_to_market=0, cntrymissing=1, country_of_origin='missing')]

# formulas for models
form_main_model = .~1+ (1|brand) + (1|category) + (1|country) + emerging + appliance + ln_market_growth_mc + ln_herf_mc + local_to_market + local_multip_market + ln_overall_prindexavg_mc + gini_mc + meanglobalx + sbbe_std_mc

#local_multip_market +
form_interact = ~1+ (1|brand) + (1|category) + (1|country) + emerging + appliance + I(appliance*emerging) + ln_market_growth_mc + I(ln_market_growth_mc*emerging) + ln_herf_mc + I(ln_herf_mc*emerging) + local_to_market + I(local_to_market*emerging) + ln_overall_prindexavg_mc + I(ln_overall_prindexavg_mc*emerging) + sbbe_std_mc + I(sbbe_std_mc*emerging)


#estimtype = 'winsor-onesided'
#estimtype = 'winsor-twosided'
estimtype = 'weighted'
#estimtype = 'nonweighted'

winsor_p=.01

notes_sig = 'Significance levels: \\* *p*<.1, \\*\\* *p*<.05, \\*\\*\\* *p*<.01 (two-sided).'
  
# 1-sided
if (estimtype=='winsor-onesided') {
  
  for (.var in c('elast', 'elastlt')) {
    elast[!is.na(get(.var)), (.var) := winsor_onesided(get(.var), fraction=winsor_p, ifelse(variable=='rwpspr', 'right','left')), by=c('variable')]
    elast[!is.na(get(.var)), paste0('w_', .var) := 1]
    elast[!is.na(get(.var)), paste0('z_', .var) := get(.var)/get(paste0(.var, '_se'))]
  }
   
      estimnote = paste0('Elasticities have been winsorized at ', winsor_p*100, '%, left-sided for all variables except price.')
  estimnoteshort='' 
}

# 2-sided
if (estimtype=='winsor-twosided') {
  
  for (.var in c('elast', 'elastlt')) {
    elast[!is.na(get(.var)), (.var) := winsor_onesided(get(.var), fraction=winsor_p, side='both'), by=c('variable')]
    elast[!is.na(get(.var)), paste0('w_', .var) := 1]
    elast[!is.na(get(.var)), paste0('z_', .var) := get(.var)/get(paste0(.var, '_se'))]
  }
   
      estimnote = paste0('Elasticities have been winsorized at ', winsor_p*100, '%, two-sided.')
  estimnoteshort=''
}

if (estimtype=='weighted') {
  
  for (.var in c('elast', 'elastlt')) {

    elast[!is.na(get(.var)), paste0('w_', .var) := 1/get(paste0(.var, '_se'))]
    elast[!is.na(get(.var)), paste0('z_', .var) := get(.var)/get(paste0(.var, '_se'))]
  }
   
      estimnote = paste0('Elasticities are weighted by inverse standard errors.')
      estimnoteshort= 'weighted by inverse standard errors'
  
}


if (estimtype=='nonweighted') {
  
  for (.var in c('elast', 'elastlt')) {

    elast[!is.na(get(.var)), paste0('w_', .var) := 1]
    elast[!is.na(get(.var)), paste0('z_', .var) := get(.var)/get(paste0(.var, '_se'))]
  }
   
      estimnote = paste0('Elasticities are unweighted.')
      estimnoteshort= 'unweighted'
  
}


notes_base = paste0("^1^ Regression of long-term elasticities on explanatory variables and three random effects, for brands, categories, and countries, respectively. Estimated using a linear mixed-effects model. ", estimnote, " Standard errors in parentheses.")


# check correlation between llen and nov
#brand_panel=fread('../../analysis/temp/preclean.csv')
#brand_panel[, ':=' (date = as.Date(date))]

vars <- c('nov6sh', 'nov6', 'nov3sh', 'nov3', 'nov12sh','nov12')
tmp=rbindlist(lapply(vars, function(.var) {
  print(.var)
  
  cor1=with(brand_panel, eval(parse(text=paste0('cor(llen,', .var, ')'))))
  cor2=mean(brand_panel[, (cor = cor(llen,get(.var))), by = c('market_id')]$V1)
  cor3=mean(brand_panel[, (cor = cor(llen,get(.var), use='pairwise')), by = c('market_id', 'brand')]$V1,na.rm=T)
  #hist(tmp$V1,xlim=c(-1,1),xlab=c('correlation coefficient'), main = 'correlation between llen and nov6sh')
  data.table(variable=.var, cor_overall=cor1, cor_by_market=cor2, cor_by_brand_market=cor3)
}))

```

# Data

```{r table1_countries, echo = FALSE}
tmp=unique(elast, by='country')[, c('country','gci_00.03_gdppercap_s','gci_overall_s','hdi2010', 'developed'),with=F]
setorderv(tmp, c('developed', 'gci_00.03_gdppercap_s'), order=-1L)
first_emerging=match(0,tmp$developed)
tmp[, developed:=NULL]

tmp=sanitize_table(tmp)
colnames(tmp)[2]<-paste0(colnames(tmp)[2], '^2^')
colnames(tmp)[3]<-paste0(colnames(tmp)[3], '^2^')
colnames(tmp)[4]<-paste0(colnames(tmp)[4], '^3^')

kable(sanitize_table(tmp), format='html', initial.zero = FALSE, caption=tab('Development indicators for countries in sample^1^')) %>%
        kable_styling() %>% footnote(number=c('Countries ranked by GDP per capita.', "GDP per capita is in current USD, based on IMF World Economic Outlook Database (April 2010). Global Competitiveness Index captures microeconomic and macroeconomic foundations of national competitiveness. Both measures are extracted from the World Economic Forum's Global Competitiveness Report (2010/2011, available at https://www.weforum.org/reports/global-competitiveness-report-2010-2011).", "Human Development Index (HDI), 2010 data, obtained from UN Development Programme (http://hdr.undp.org/en/content/human-development-index-hdi). Taiwan's HDI has been imputed as the mean HDI of Thailand and China.")) %>%
  group_rows("Developed economies", 1, first_emerging-1) %>%
  group_rows("Emerging economies", first_emerging, 14)

```

```{r table2_category_overview, echo = FALSE}
tmp=data.table(elast)
tmp[, ncountries:=length(unique(country)),by=c('category')]

tmp=tmp[, list(overall_ms=mean(overall_ms), ncountries=mean(ncountries)), by = c('category', 'appliance', 'brand')]

setorderv(tmp, c('category', 'appliance', 'overall_ms'), order=-1L)
tmp[!brand%in%c('unbranded','local'), rank:=1:.N, by = c('category')]
tmp[, brand_include:= rank%in%1:5]

tmp=tmp[, list(cattype=ifelse(unique(appliance)==1, 'Appliance', 'Electronics'), ncountries=unique(ncountries), nbrands=length(unique(brand)), exemplary_brand_names=paste0((unique(brand[brand_include==T])), collapse=', ')), by='category']
tmp=sanitize_table(tmp)
setnames(tmp, 'Top 5 brands', 'Top 5 brands^2^')

try(setorder(tmp, Category),silent=T)

kable(tmp, format='html', caption=tab('Category overview^1^')) %>%
        kable_styling() %>% footnote(number=c('Categories shown in alphabetical order.', 'Top 5 brands are determined on the basis of their average volume share across countries, and are listed in decreasing order of their market shares.'))

```

`r tab('Variable operationalization for market share attraction model')`


Variable             | Operationalization
-------------------- | ------------------------------------------------------------------
Market share         | Unit sales for brand *i* in period *t*, devided by total unit sales in period *t* in a market (category/country combination).
Price                | Average price of brand *i*, computed as a sales-weighted^1^ average across its SKUs sold in period *t*, expressed in local currency and adjusted by a country's consumer price index^2^.
Distribution         | Sales-weighted^1^ distribution of each of brand *i*'s SKUs' store-weighted distribution in period *t* (0 = no market coverage, 100 = full market coverage).
Line length          | Number of unique SKUs sold by brand *i* in period *t*.
New product activity | Number of SKUs introduced by brand *i* in a rolling window of one year (*t-11*, *t-10*, *...*, *t*), expressed as a share of the total number of unique SKUs sold by brand *i* over the same period.

^1^ Weights equal to a SKU's unit sales in the most recent quarter (months *t*-2, *t*-1, *t*).

^2^ Consumer price index obtained from Thomson Reuters Datastream.

# Results

```{r continue_with_selection, echo=FALSE}
elast_all=data.table(elast)
elast=elast[!is.na(country_of_origin)&!tolower(brand)%in%c('unbranded')]
excluded_brands=setdiff(unique(elast_all$brand), unique(elast$brand))

```

Reported for a sample of `r length(unique(elast$brand))` unique brands (excluding `r paste0(my_capitalize(excluded_brands), collapse=', ')`).

```{r elasticities_overview, echo = FALSE, results='asis'}
  sigvalue = .1 # .1-level of significance
  
  zval = qnorm(1-sigvalue/2)

  out= NULL
  for (i in 1:2) {
    if (i==1) obj=c('elast', 'w_elast', 'z_elast')
    if (i==2) obj=c('elastlt','w_elastlt', 'z_elastlt')
    
    tmp = elast[!is.na(get(obj[1]))][, ':=' (val=get(obj[1]), 
                                             val_w=get(obj[2]),
                                             val_z=get(obj[3]))]
 
    # different t-tests
  
    diff_tests=lapply(c(ttest='ttest', wls='wls',re='re'), function(tvalrep) {
      if (tvalrep=='wls') {
      # OLS-based p values   
      diff_tests=rbindlist(lapply(unique(elast$variable), function(.var) {
        data.table(variable=.var, effect=c('constant', 'emerging'), summary(lm(val~1+emerging, weights=val_w,data=tmp[variable==.var]))$coefficients)
      }))
            taddition = paste0('Test on differences carried out by regressing elasticities (', estimnoteshort, ') on an intercept and an emerging country indicator variable. Reported t-value is obtained from the estimate of the emerging country indicator.')
  
            }
    
      if (tvalrep=='re') {
      # random effects based p values
        diff_tests=rbindlist(lapply(unique(tmp$variable), function(.var) {
        data.table(variable=.var, effect=c('constant', 'emerging'), summary(lmer(val~1+(1|category) + (1|country) + (1|brand) + emerging, weights=val_w,data=tmp[variable==.var]))$coefficients)[, p:=2*(1-pnorm(abs(get('t value'))))]
      }))
        taddition = paste0('Test on differences carried out by regressing elasticities (', estimnoteshort, ') on an intercept, an emerging country indicator variable and three random effects, for brands, categories, and countries, respectively. Reported t-value is obtained from the estimate of the emerging country indicator.')
  
            }
    
     if (tvalrep=='ttest') {
       
    # random effects based p values
      diff_tests=rbindlist(lapply(unique(tmp$variable), function(.var) {
        xemerg=tmp[variable==.var&emerging==1]$val
        xdevel=tmp[variable==.var&emerging==0]$val
        
        tout = t.test(xemerg,xdevel)
        
      data.table(variable=.var, effect=c('emerging'), NA, NA, tout$statistic, tout$p.value)
      }))
      
      taddition = paste0('Test on differences carried out using a two-sided t-test.')
     }
  
    setnames(diff_tests, c('variable', 'effect', 'diff_est', 'diff_se', 'diff_t','diff_p'))
    diff_tests=diff_tests[effect=='emerging'][, effect:=NULL]
    diff_tests[,testtype:=tvalrep]
    return(list(diff_tests=diff_tests, notes=taddition))
    })
    
    
    ttests=melt(rbindlist(lapply(diff_tests, function(x) x$diff_tests))[, ':=' (var=variable,variable=NULL)], id.vars=c('var','testtype'))
    
    ttests=dcast(ttests, var~testtype+variable)
    setnames(ttests, 'var', 'variable')
    
    notes<-lapply(diff_tests, function(x) x$notes)
    
    
    tmp = merge(tmp, ttests, by = c('variable'))

    
    tmp=tmp[, list(Neffects= .N, 
                   all_melast = sum(val*val_w)/sum(val_w),
						 		   all_z = sum(val_z,na.rm=T)/sqrt(.N),
									 #all_sig = signstars(sum(val_z,na.rm=T)/sqrt(.N)),
												  
									 dev_Neffects= length(which(!is.na(val[developed==1]))),
				           dev_melast = sum(val[developed==1]*val_w[developed==1])/sum(val_w[developed==1]),
									 dev_z = sum(val_z[developed==1])/sqrt(length(which(!is.na(val[developed==1])))),
									 #dev_sig = signstars(sum(val_z[developed==1])/sqrt(length(which(!is.na(val[developed==1]))))),
									 
									 em_Neffects= length(which(!is.na(val[developed==0]))),
				           em_melast = sum(val[developed==0]*val_w[developed==0])/sum(val_w[developed==0]),
									 em_z = sum(val_z[developed==0])/sqrt(length(which(!is.na(val[developed==0])))),
									 #em_sig = signstars(sum(val_z[developed==0])/sqrt(length(which(!is.na(val[developed==0]))))),
									 ttest_t = unique(ttest_diff_t), ttest_sig = psignstars(unique(ttest_diff_p)),
									 wls_t = unique(wls_diff_t), wls_sig = psignstars(unique(wls_diff_p)),
									 re_t = unique(re_diff_t), res_sig = psignstars(unique(re_diff_p))
									                    ), by=c('variable')]

  tmp=tmp[match(ordered_vars, variable)]
  setnames(tmp, 'variable', 'mmixinstr')

  out[[i]]<-tmp
  }
  
names(out)<-c('st','lt')

iters = list(st=c('st', 'Short-term'), lt=c('lt', 'Long-term'))
for (iter in iters) {
  print(kable(sanitize_table(out[[iter[1]]]), digits=3, format='html', 
        caption=tab(paste0(iter[2], ' elasticities by marketing mix instrument^1^'))) %>% kable_styling() %>% 
        footnote(number=c(paste0(notes_sig, ' ', estimnote, ' The number of observations differs slightly across marketing mix instruments because some brands in some markets (category/country combinations) do not have variation in these variables.'),notes[1],notes[2],notes[3])) %>% add_header_above(c(" " = 1, "All countries" = 3, "Developed countries" = 3, "Emerging countries" = 3, 'Tests on differences' =6)))
}
  
```

# Second-stage analysis

`r tab("Variable operationalization^1^")`

Construct                  | Operationalization                                     | References
------------------------- | --------------------------------------------------------|----------
Appliance (versus electronics)| Dummy, equaling 1 for appliances (washing machines, microwaves and refrigerators), 0 for all other categories.
Category growth       | Average geometric growth rate in a market (category/country combination).^2^
Category concentration     | Herfindahl index in a market (category/country combination).
Domestic versus foreign brand | Dummy, equaling 1 if a brand's headquarter is located in the focal country, 0 if not.
Price index | Brand's average price (deflated sales value divided by the brand's sales volume over the observation period), indexed by the average price in a given category and country.
Brand equity               | Sales-based brand equity, derived from the market share attraction model, standardized by category. | Datta, Ailawadi, and van Heerde (2017)

^1^ All continuous variables are first logged and then mean-centered before model estimation (except brand equity, which is only mean-centered as this variable can take on negative values). 

^2^ Geometric growth rate is the n-th's square root of the ratio of the total number of unit sales in a market in the last year over total number of unit sales in the first year (both years having 12 months of data), where n is equal to the number of years in the observation window.

```{r summarystats, echo=FALSE, results='asis'}

covars <- c('appliance', 'market_growth', 'herf', 'local_to_market', 'overall_prindexavg', 'sbbe_std', 'brandz')

tmp=data.table(elast)
nbrands=length(unique(tmp$brand))
nmarkets=length(unique(tmp$market_id))
tmp = unique(tmp, by = c('market_id','brand', 'emerging'))
nobs=nrow(tmp)

# test for differences in means
diff_tests=rbindlist(lapply(covars, function(.var) {
      tmp[, val:=get(.var)]
      data.table(variable=.var, effect=c('constant', 'emerging'), summary(lm(val~1+emerging,data=tmp))$coefficients)
    }))

setnames(diff_tests, c('variable', 'effect', 'diff_est', 'diff_se', 'diff_t','diff_p'))
diff_tests=diff_tests[effect=='emerging'][, effect:=NULL]


tmp=tmp[, lapply(.SD, function(x) c(min=min(x,na.rm=T), max=max(x,na.rm=T), mean=mean(x,na.rm=T),sd=sd(x,na.rm=T))), by = c('emerging'), .SDcols=c(covars)]
tmp[, var:=rep(c('min', 'max','mean', 'sd'),2)]
tmp=melt(tmp, id.var=c('emerging', 'var'))
tmp[, emerging_label:=ifelse(emerging==1, 'emerging', 'developed')]

dtf=dcast(tmp, variable~emerging_label+var)
setcolorder(dtf, c('variable', paste0(rep(c('emerging_', 'developed_'), each=4), rep(c('min', 'max', 'mean', 'sd'),2))))

setnames(dtf, gsub('emerging_', '', colnames(dtf)))
setnames(dtf, gsub('developed_', '', colnames(dtf)))

setkey(diff_tests, variable)
setkey(dtf, variable)

dtf[diff_tests, ':=' (comb_t=i.diff_t, comb_sig=gsub('[*]', '\\*', psignstars(i.diff_p)))]

dtf=sanitize_table(dtf)

print(kable(dtf, format='html', initial.zero = FALSE, digits=3,caption = tab(paste0('Summary statistics for covariates in second-stage analysis, split by a country\'s development status^1^'))
      ) %>% kable_styling() %>% footnote(number=c(paste0('Summary statistics for variables (unlogged and not mean-centered), computed across ', nobs, ' observations in our sample.'),'Test on differences carried out by regressing variables on an intercept and an emerging country indicator variable. Reported t-value is obtained from the estimate of the emerging country indicator.')) %>% add_header_above(c(" " = 1, "Emerging countries" = 4, "Developed countries" = 4, "Test on differences^2^"=2)))


```

```{r main_regs, echo = FALSE, results='asis'}


# formulas for models
#form_main_model = .~ 1 + (1|brand) + (1|category) + (1|country) + emerging + appliance + ln_market_growth_mc + #ln_herf_mc + local_to_market + ln_overall_prindexavg_mc #+ sbbe_std_mc
#

out1=regmodel(formula=c(main=form_main_model), dat=elast, model='lmer')

# keep only models that belong to one type (so that each table only features the rows that were actually estimated)

main = lapply(out1, function(x) {x$lt <- list(x$lt$main); x$st <- list(x$st$main); x})

# assemble all variables
#sink('../temp/secondstage.html')

# MAIN MODEL
cat("<P style='page-break-before: always'>")
printout(main, 'stlt', title = tab('Regression with short- and long-term elasticities in a pooled sample of developed and emerging countries'), vars=ordered_vars,  notes=gsub('long[-]term', 'short- and long-term', notes_base))

#sink()

```

```{r main_regs_both, echo = FALSE, results='asis'}

interactions=grep('I[(]', unlist(strsplit(as.character(form_interact), ' [+] ')),value=T)

test_interact=sapply(interactions, function(x) update.formula(form_main_model, as.formula(paste0('.~.+',x))))

       
out1=regmodel(formula=test_interact, dat=elast, model='lmer')

# assess significance
for (elasttype in c('st', 'lt')) {
  
  if (elasttype=='st') res=lapply(out1, function(m) lapply(m$st, function(n) data.table(mmix=m$variable,variable=rownames(summary(n)$coefficients),summary(n)$coefficients)))
   if (elasttype=='lt') res=lapply(out1, function(m) lapply(m$lt, function(n) data.table(mmix=m$variable,variable=rownames(summary(n)$coefficients),summary(n)$coefficients)))
  
  # assess significance
  res=rbindlist(do.call('c', res))
  res=res[grepl('I[(]', variable)]
  res[, z:=Estimate/get('Std. Error')]
  res[, abs_z:=abs(z)]
  setorder(res, abs_z)
  #res[, z:=NULL]
  
  summary_sig=dcast.data.table(res, variable ~ mmix, value.var='z')
  summary_sig[,variable:=gsub('I[(]', '', variable)]
  summary_sig[,variable:=gsub(' [*] emerging[)]', '', variable)]
  setcolorder(summary_sig, c('variable', ordered_vars))
  
  # order:
  tmporder <- gsub('I[(]', '', interactions)
  tmporder <- gsub(' [*] emerging[)]', '', tmporder)
  
  summary_sig = summary_sig[match(tmporder, variable),]
  
  #setnames(summary_sig, 'variable', 'Interaction term with emerging country indicator')
  
  if(0){              
  print(kable(sanitize_table(summary_sig), format='html', initial.zero = FALSE, digits=3, caption=tab(paste0('Assessing the significance of adding interaction terms with an emerging country indicator to a main-effects only model for ', ifelse(elasttype=='st', 'short-term', 'long-term'), ' elasticities^1^'))) %>%
          kable_styling() %>% footnote(number='Table reports t-values for a single interaction term between the focal variable and an emerging country indicator added to a regression of marketing mix elasticities on main effects only.'))
  }
  
  update_forms=res[abs_z>=zval, list(interactions=unique(variable)),by=c('mmix')]
  
  run_interact=sapply(unique(elast$variable), function(x) {
    keep_terms = update_forms[mmix==x]$interactions
    remove_terms = setdiff(interactions, keep_terms)
    update_terms=paste(remove_terms, collapse=' - ')
    if (update_terms=='') return(form_interact)
    
    update.formula(form_interact, as.formula(paste0('.~.-',update_terms)))
  })
  
  
  out1b=regmodel(formula=c(form_main_model, form_interact, run_interact), dat=elast, model='lmer')
  
  # reassemble to keep only the ones with terms we selected
  mod_out<-lapply(seq(along=out1b), function(i) {
    x=out1b[[i]]
    # retain first two models, and pick selected interaction model (2+i)
    x$lt<-list(x$lt[[1]], x$lt[[2]], x$lt[[2+i]])
    x$st<-list(x$st[[1]], x$st[[2]], x$st[[2+i]])
    return(x)
  })
  
  names(mod_out) <- names(out1b)
  
  # MAIN MODEL
  #sink('../temp/test.html')
  cat("<P style='page-break-before: always'>")
  printout(mod_out, elasttype, title = tab(paste('Regression with ', ifelse(elasttype=='st', 'short-term', 'long-term'), ' elasticities in a pooled sample of developed and emerging countries: main model, model with full interaction terms, and model with selected interaction terms')), vars=ordered_vars, notes=paste0(ifelse(elasttype=='st', gsub('long[-]term', 'short-term', notes_base), notes_base),  ' For each variable, the first column reports a model without interactions (our main model); the second column reports a model with full interactions; the third column reports a model in which only interactions are added that were significant in an auxilary regression with all main effects, and only one of the relevant interaction terms each.'))
  #sink()

}
  

```

# Robustness checks

```{r robustness_regs, echo = FALSE, results='asis'}

modellist = lapply(c('developed', 'ln_gci_00.03_gdppercap_s_mc', 'ln_gci_overall_s_mc', 'ln_hdi2010_mc', 'gcifactor_mc'), 
                   function(x) update.formula(update.formula(form_main_model, .~.-emerging), as.formula(paste0('.~. +', x))))

out1=regmodel(formula=modellist, dat=elast, model='lmer')

#sink('../temp/test.html')

notes=paste0(notes_base, ' Alternative indicators for a country\'s state of development are: (1) Developed country indicator (=1-Emerging country indicator, used in main specifications), (2) Log of GDP per capita, (3) Log of Global Competitiveness Index, (4) Log of Human Development Index, and (5) Socio-economic develop of a country (score from PCA on selected items from the Global Competitiveness Report, not logged because this score takes on negative values)')

cat("<P style='page-break-before: always'>")
printout(out1, 'lt', vars=ordered_vars[1:2], title = tab('Regression with long-term elasticities on covariates and different indicators for a country\'s state of development'),  notes=notes)

cat("<P style='page-break-before: always'>")
printout(out1, 'lt', vars=ordered_vars[3:4], title = tab('Regression with long-term elasticities on covariates and different indicators for a country\'s state of development'),  notes=notes)
#sink()

```


# Appendix

```{r reset, echo=FALSE,results='asis'}
tableno<<-0
figureno<<-0
cat("<P style='page-break-before: always'>")
  
```

```{r robustness_regs_equity, echo = FALSE, results='asis'}

modellist = lapply(c('sbbe_std_mc', 'ln_overall_ms_mc', 'brandz'), 
                   function(x) update.formula(update.formula(form_main_model, .~.-sbbe_std_mc), as.formula(paste0('.~. +', x))))

out1=regmodel(formula=modellist, dat=elast, model='lmer')

notes = paste0(notes_base, ' The three measures for brand equity are: (1) Brand equity (SBBE, as in the main model), (2) Log of brand-level market share, and (3) an indicator variable, equaling 1 if a brand is listed in the BrandZ\'s Top 100 Most Valuable Global Brands (2010), or BrandZ\'s Top 50 Most Valuable Chinese Brands (2011).')

#sink('../temp/test.html')

cat("<P style='page-break-before: always'>")
printout(out1, 'lt', title = tab('Regression with long-term elasticities on covariates and different measures for brand equity', prefix='A'), vars=ordered_vars[1:2], notes=notes)

cat("<P style='page-break-before: always'>")
printout(out1, 'lt', omit=NULL, title = tab('Regression with long-term elasticities on covariates and different measures for brand equity', prefix='A'), vars=ordered_vars[3:4], notes=notes)
#sink()
```


```{r sample_origin, echo=FALSE, results='asis'}

cols =  c('country_of_origin')
tmp = elast[, list(.N), by = c('brand',cols)]
tmp = tmp[, list(nbrands=length(unique(brand)), all_brands=paste(brand[order(brand)], collapse=', ')), by = cols]
tmp[country_of_origin==''|is.na(country_of_origin), country_of_origin := 'Country not available']
tmp[, country_of_origin:=my_capitalize(country_of_origin)]

setorderv(tmp, 'nbrands', order=-1L)
setcolorder(tmp, c('country_of_origin', 'nbrands', 'all_brands'))

tmp=sanitize_table(tmp)

kable(tmp, caption = tab('Country-of-origins for brands in sample, ordered by the number of brands from a given country^1^', prefix ='A'),format='html') %>%
        kable_styling() %>% footnote(number=paste0('Brand names per country listed alphabetically.'))

```


```{r elast_by_cc, echo=F,results='asis', include=TRUE}
#sink('cc.html')
for (byvar in c('country','category')) {
  tmp=elast[!is.na(elastlt), list(elast = sum(elastlt*w_elastlt)/sum(w_elastlt)), by=c('variable', byvar)]
  setnames(tmp, byvar, 'byvar')
  
  tmp=dcast(tmp,byvar~variable,value.var='elast')
  setnames(tmp, 'byvar', byvar)
  setcolorder(tmp, c(byvar, ordered_vars))
  
  tmp=sanitize_table(tmp)
  setorderv(tmp, colnames(tmp)[1])
  
  cat("<P style='page-break-before: always'>")
  {print(kable(tmp, digits=3, caption = tab(paste0('Long-term elasticities (means by ', byvar, ')^1^'), prefix='A'), format='html', initial.zero = FALSE) %>%
        kable_styling() %>% footnote(number=paste0(estimnote, ' Reported by ', ifelse(byvar=='country', 'countries', 'categories'), ' in alphabetical order.')))
  }
}
#sink() 

```	


```{r rq4_growth, echo=FALSE,results='asis'}
tmp=unique(elast, by = c('market_id')) # t-tests on growth rates

t_tests <- lapply(unique(elast$category), function(var) {
    tmpdat = tmp[category == var]
    teststat=t.test(tmpdat[country_class=='hinc']$market_growth, tmpdat[country_class=='linc']$market_growth)
    
    tabl = data.frame(category=var, mean1=teststat$estimate[1], mean2=teststat$estimate[2], tval=teststat$statistic, pval=teststat$p.value)
                
    return(list(summary=tabl))
})

out=rbindlist(lapply(t_tests, function(x) x$summary))

percent <- function(x, digits = 1, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}

out[, ':=' (mean1=percent(mean1-1), mean2=percent(mean2-1))]
out[, category:=as.character(category)]
out=sanitize_table(out)
setorder(out, Category)
setnames(out, 'mean1', 'developed countries')
setnames(out, 'mean2', 'emerging countries')
cat("<P style='page-break-before: always'>")
kable(out, format='html',caption = tab('Average category growth rates for developed and emerging countries^1^',prefix='A'),digits=3) %>% kable_styling() %>% footnote(number=paste0('Table reports average category growth rates, and the results of a t-test of statistical significance of the difference in growth rates between developed and emerging countries. Categories are ordered alphabetically.'))
  
```

```{r VIFS, echo=FALSE,results='asis', include=FALSE}

m1 = ~1+ appliance + ln_market_growth_mc + ln_herf_mc + local_to_market  + ln_overall_prindexavg_mc + sbbe_std_mc

m<-lm(update(elast~., m1), data=elast[variable=='llen'])

frame1=data.frame(vif(m))
colnames(frame1) <- c('VIF')
frame1$variable=rownames(frame1)
rownames(frame1)<-NULL
frame1=frame1[, c('variable','VIF')]
frame1=sanitize_table(frame1)
cat("<P style='page-break-before: always'>")

if(0){
kable(frame1,format='html', caption = tab('Assessing multicollinearity^1^', prefix='A'))%>% kable_styling() %>% footnote(number=paste0('Table reports VIFs values calculated in regression models using main effects for all variables listed above (i.e., excluding brand, category, and country effects).'))
}
```

```{r elasts_full, echo=F,results='asis'}

cat("<P style='page-break-before: always'>")

  sigvalue = .1 # .1-level of significance
  zval = qnorm(1-sigvalue/2)

  out = lapply(list(st=c('elast', 'z_elast', 'w_elast'), lt = c('elastlt','z_elastlt','w_elastlt')), function(obj) {
               
    tmp = elast[!is.na(get(obj[1]))][, ':=' (val=get(obj[1]), val_z=get(obj[2]), val_w=get(obj[3]))]
    
    tmp=tmp[, list(Neffects=.N, median_elast = median(val), 
												  melast = sum(val*val_w)/sum(val_w),
												  perc_positive = length(which(val_z>=(zval)))/.N, 
												  perc_null = length(which(abs(val_z)<zval))/.N, 
												  perc_negative = length(which(val_z<=(-zval)))/.N), by=c('variable')]
    
  tmp=tmp[match(ordered_vars, variable)]
  setnames(tmp, 'variable', 'mmixinstr')
  return(tmp)
  })
  
iters = list(st=c('st', 'Short-term'), lt=c('lt', 'Long-term'))
for (iter in iters) {
  print(kable(sanitize_table(out[[iter[1]]]), digits=3, format='html', 
        caption=tab(paste0(iter[2], ' elasticities by marketing mix instrument^1^'),prefix='A')) %>% kable_styling() %>% 
        footnote(number=paste0('Table reports ', tolower(iter[2]), ' elasticities. ', estimnote, ' Significance tested at *p*<',sigvalue, '.')))
}

```


```{r report_pca, echo=FALSE,results='asis'} 

scores = fread('../output/pca_1comp_loadings.csv')
setnames(scores, c('variable', 'stdloading'))

scores[, variable_renamed:=sapply(variable, rename.fkt, dictionary='renaming_gci.txt')]
setcolorder(scores, c('variable_renamed', 'stdloading', 'variable'))
scores[, variable:=NULL]
setnames(scores, 'variable_renamed', 'Variable')
setnames(scores, 'stdloading', 'Standardized loading')

print(kable(scores, caption = tab(paste0('Standardized loadings on principal component for GCI metrics',prefix='A')),
      format='html', initial.zero = FALSE, digits = 3)%>%
        kable_styling())

```

```{r overview2, echo=FALSE, results='asis'}
tmp = elast_all[, list(Nbrands = length(unique(brand))), by = c('market_id', 'category','country')]

tabl = dcast(tmp, category~country, value.var=c('Nbrands'))

tabl=sanitize_table(tabl)
setorder(tabl, Category)
kable(tabl, caption = tab('Overview of markets (category/country combination) in sample (with number of selected brands indicated per cell)', prefix='A'))

```

```{r sample_overview, echo=FALSE, results='asis'}
#, headquarter_region=unique(country_of_origin)
tmp=elast[, list(active_in_countries=length(unique(country)), active_in_categories=length(unique(category)), headquarter_location=unique(country_of_origin)), by = c('brand')]
setorderv(tmp, c('active_in_countries','active_in_categories', 'brand'),order=-1L)

tmp[, ':=' (headquarter_location=stri_trans_totitle(headquarter_location))]#, #headquarter_region=stri_trans_totitle(headquarter_region))]
tmp=sanitize_table(tmp)


kable(tmp, caption = tab('Overview of selected brands, ordered by the number of countries and categories they are included in estimation data', prefix ='A'))
```

```{r correl, echo=FALSE, results = 'asis'}

tmp = dcast(elast,market_id+brand~variable, value.var=c('elast', 'elastlt'))

for (var in grep('elast', colnames(tmp),value=T)) {
  tmp[, (paste0('mc_', var)):=get(var)-mean(get(var),na.rm=T), by = c('market_id')]
  }


printtmp=tmp[, grep('mc[_]elast[_]', colnames(tmp),value=T) ,with=F]
setnames(printtmp, gsub('mc[_]elast[_]','',colnames(printtmp)))
setcolorder(printtmp, ordered_vars)
setnames(printtmp, paste0(rename.fkt(colnames(printtmp)), ' elasticity'))


corstars(printtmp, method=c("pearson"),result='html', caption = tab('Correlation among short-term marketing mix elasticities (mean-centered by market)'))

printtmp=tmp[, grep('mc[_]elastlt[_]', colnames(tmp),value=T) ,with=F]
setnames(printtmp, gsub('mc[_]elastlt[_]','',colnames(printtmp)))
setcolorder(printtmp, ordered_vars)
setnames(printtmp, paste0(rename.fkt(colnames(printtmp)), ' elasticity'))

corstars(printtmp, method=c("pearson"),result='html', caption = tab('Correlation among long-term marketing mix elasticities (mean-centered by market)'))

#stargazer(cor(printtmp))


```


# plot variables

```{r plotvars,echo=FALSE}
vars=c('nov12sh','nwprd','llen','wpswdst')

cats = unique(brand_panel$category)
#dir.create('../audit')

for (cat in cats) {
  tmp=brand_panel[category==cat][, lapply(.SD,mean,na.rm=T), .SDcols=vars,by=c('country','brand')]

  gdp = elast[, c('country','gdppercap2010'),with=F]
  gdp = unique(gdp, key=c('country'))
  
  tmp$country <- factor(tmp$country, levels=gdp$country[order(gdp$gdppercap2010)])
  

pl<-lapply(vars, function(v) {
  #print(v)
  tmp2=data.table(tmp)
  tmp2[, min:=min(get(v)),by=c('country')]
  tmp2[, max:=max(get(v)),by=c('country')]
  tmp2[, val:=get(v),by=c('country')]
 
  return(ggplot(tmp2, aes(x=country))+
  geom_point(aes(y=val),size=2,color="grey")+
  geom_linerange(aes(ymin=min,ymax=max),linetype=2,color='blue')+
  geom_point(aes(y=min),size=3,color="red")+
  geom_point(aes(y=max),size=3,color="red")+
  theme_bw()+ ylab(v) + 
  theme(axis.text.x=element_text(angle=90, hjust=1, size=8)))
})


grid.arrange(pl[[1]], pl[[2]], pl[[3]], pl[[4]], top = cat, bottom = textGrob("Note: Plot shows variable means for each brand in a given country and category; countries ranked by GDP per capita (2010).", gp=gpar(fontsize=8)))

}

```

```{r plot_2x2, echo=FALSE}

out1=regmodel(formula=c(main=form_main_model), dat=elast, model='lmer')

# keep only models that belong to one type (so that each table only features the rows that were actually estimated)

main = lapply(out1, function(x) x$lt$main)

# example data
main$llen

modvarq=quantile(elast$sbbe_std_mc,c(.2,.8))

emerging = c(0,1)
local=c(0,1)

simdata=data.table(expand.grid(modvar=modvarq, emerging=emerging,local_to_market=local))
require(car)

simdata[, form:=paste0('emerging*', emerging,'+local_to_market*', local_to_market,'+sbbe_std_mc*', modvar)]

sims=rbindlist(lapply(names(main), function(mod) {
  rbindlist(lapply(1:nrow(simdata), function(r) {
    tmp=deltaMethod(main[[mod]], simdata[r]$form)
    cbind(model=mod, simdata[r], est=tmp$Estimate, se=tmp$SE)
  }))
}))


```

```{r outputbar, echo=F}

#ggplot(sims, aes(x=emerging, y=est, fill=local_to_market)) + geom_bar(stat="identity", position=position_dodge())
sims[, ':=' (l_emerging=ifelse(emerging==1,'EM','DM'),
             l_brandequity=ifelse(modvar==max(modvar), 'high brand equity','low brand equity'),
             l_local=ifelse(local_to_market==1,'domestic brand','foreign brand'))]
dir.create('../audit')

for (mod in unique(sims$model)) {
simtmp=sims[model==mod]

png(paste0('../audit/plot_', mod, '.png'), res=150, units='in', height=4, width=4)
p<-ggplot(simtmp, aes(x=l_emerging,y=est))+geom_bar(stat="identity")+facet_grid(l_brandequity~l_local, switch='y') + ggtitle(paste0(rename.fkt(unique(simtmp$model)), ' elasticities')) + xlab('Development status') + ylab('Change in mean elasticity')
#+  geom_errorbar(aes(ymin=est-1.69*se,ymax=est+1.69*se),width=.1)
p
dev.off()

}


       


```

