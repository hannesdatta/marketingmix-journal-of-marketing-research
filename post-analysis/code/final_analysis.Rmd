---
title: "GfK Singapore - Results"
output:
  html_document: default
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggpubr)
library(plyr)
#library(psych)

libs_to_load <- c('data.table', 'stargazer', 'knitr', 'xtable', 'lme4', 'car', 'kableExtra', 'stringi', 'ggplot2')
for (lib in libs_to_load) eval(parse(text=paste('library(', lib, ')')))

options(xtable.comment = FALSE)
options(knitr.kable.NA = '')

# Load data
  #elast <- fread('../externals/elast_results_MCI_wlag_wotrend.csv')
  elast <- fread('../externals/elast_results_MCI_wolag_trend.csv')

# Load auxilary functions
  source('proc_auxilary.R')
  source('proc_rename.R')

# Preclean data
  source('preclean.R')
  
### brand selection for analysis
#elast=elast[globalbrand==T] # global brands (active in >=3 countries) only
#elast=elast[ncountries>=2]

# set order of variables to appear in figures and tables
ordered_vars = c('rwpspr', 'wpswdst','llen','nov6sh')


# fix 'standard' covariates
form_random_component = .~1+ (1|brand) + (1|category) + (1|country)
form_random_component_FE = .~1+ (1|brand) + (1|category) + as.factor(country)
form_std = .~. + appliance + ln_market_growth_mc + ln_herf_mc + local_to_market + western_brand + ln_overall_prindex_mc

form_interact = ~1+ (1|brand) + (1|category) + (1|country) + emerging + appliance + I(appliance*emerging) + ln_market_growth_mc + I(ln_market_growth_mc*emerging) + ln_herf_mc + I(ln_herf_mc*emerging) + local_to_market + I(local_to_market*emerging) + western_brand + I(western_brand*emerging) + ln_overall_prindex_mc + I(ln_overall_prindex_mc*emerging) + sbbe_std_mc + I(sbbe_std_mc*emerging)

form_interact_gci = ~1+ (1|brand) + (1|category) + (1|country) + gcifactor_mc + appliance + I(appliance*gcifactor_mc) + ln_market_growth_mc + I(ln_market_growth_mc*gcifactor_mc) + ln_herf_mc + I(ln_herf_mc*gcifactor_mc) + local_to_market + I(local_to_market*gcifactor_mc) + western_brand + I(western_brand*gcifactor_mc) + ln_overall_prindex_mc + I(ln_overall_prindex_mc*gcifactor_mc) + sbbe_std_mc + I(sbbe_std_mc*gcifactor_mc)


# choice for main 'brand strength' variable
form_modelbasis = update.formula(form_random_component, form_std)
form_extraregressor = .~. + sbbe_std_mc

winsor_p=.05
```

# Data

```{r table1_countries, echo = FALSE}
tmp=unique(elast, by='country')[, c('country','gdppercap2010','hdi2010','developed'),with=F]
setorderv(tmp, c('developed', 'gdppercap2010'), order=-1L)
first_emerging=match(0,tmp$developed)
tmp[, developed:=NULL]
tmp[country=='taiwan', gdppercap2010:=NA]

kable(sanitize_table(tmp), format='html', initial.zero = FALSE, caption=tab('Development indicators for countries in sample')) %>%
        kable_styling() %>% footnote(general='Countries ranked by GDP per capita.', alphabet=c("GDP per capita in current USD, 2010 data, provided by World Bank (https://data.worldbank.org/indicator/NY.GDP.PCAP.CD) for all countries except Taiwan. Data for Taiwan is pending.", "Human Development Index (HDI), 2010 data, obtained from UN Development Programme (http://hdr.undp.org/en/content/human-development-index-hdi). Taiwan's HDI has been imputed as the mean HDI of Thailand and China.")) %>%
  group_rows("Developed economies", 1, first_emerging-1) %>%
  group_rows("Emerging economies", first_emerging, 14)

```

```{r table2_category_overview, echo = FALSE}
tmp=data.table(elast)
tmp[, ncountries:=length(unique(country)),by=c('category')]

tmp=tmp[, list(overall_ms=mean(overall_ms), ncountries=mean(ncountries)), by = c('category', 'appliance', 'brand')]

setorderv(tmp, c('category', 'appliance', 'overall_ms'), order=-1L)
tmp[!brand%in%c('unbranded','local'), rank:=1:.N, by = c('category')]
tmp[, brand_include:= rank%in%1:5]

my_capitalize <- function(x) {
  sapply(stri_trans_totitle(x), function(y) {
    if (nchar(y)<=3) return(toupper(y)) else return(y)
    
  })
}

tmp=tmp[, list(cattype=ifelse(unique(appliance)==1, 'Appliance', 'Electronics'), ncountries=unique(ncountries), nbrands=length(unique(brand)), exemplary_brand_names=paste0(sort_alpha(my_capitalize(unique(brand[brand_include==T]))), collapse=', ')), by='category']
tmp=sanitize_table(tmp)

try(setorder(tmp, Category),silent=T)

kable(tmp, format='html', caption=tab('Category overview')) %>%
        kable_styling() %>% footnote(general='Categories shown in alphabetical order. Exemplary brand names are given for the top 5 brands in terms of average volume share across countries.')

```

# Market share model

`r tab('Variable operationalization for market share attraction model')`


Variable             | Operationalization
-------------------- | ------------------------------------------------------------------
Market share         | Unit sales for brand *i* in period *t*, devided by total unit sales in period *t* in a market
Price                | Sales-weighted^1^ average of each SKU's price sold by brand *i* in period *t*, expressed in local currency and adjusted by a country's consumer price index^2^
Distribution         | Sales-weighted^1^ distribution of each of brand *i*'s SKUs' store-weighted distribution in period *t* (0 = no market coverage, 100 = full market coverage)
Line length          | Number of unique SKUs sold by brand *i* in period *t*
New product activity | Number of SKUs introduced by brand *i* in a rolling window of 6 months (*t-5*, *t-4*, *...*, *t*), expressed as a share of total unique SKUs sold by brand *i* over the same period

Notes:

^1^ Weights equal to a SKU's unit sales in the most recent quarter (t-2, t-1, t).

^2^ Consumer price index obtained from Thomson Reuters Datastream.

```{r elasticities_overview, echo = FALSE, results='asis'}
  sigvalue = .1 # .1-level of significance
  zval = qnorm(1-sigvalue/2)

  out = lapply(list(st=c('elast', 'elast_se'), lt = c('elastlt','elastlt_se')), function(obj) {
               
    tmp = elast[!is.na(get(obj[1]))][, ':=' (val=get(obj[1]), val_se=get(obj[2]))]
    
    tmp=tmp[, list(Neffects= .N, 
                   all_welast = sum(val/val_se)/sum(1/val_se),
						 		   all_z = sum(val/val_se,na.rm=T)/sqrt(.N),
									 all_sig = signstars(sum(val/val_se,na.rm=T)/sqrt(.N)),
												  
									 dev_Neffects= length(which(!is.na(val[developed==1]))),
				           dev_welast = sum(val[developed==1]/val_se[developed==1])/sum(1/val_se[developed==1]),
									 dev_z = sum(val[developed==1]/val_se[developed==1])/sqrt(length(which(!is.na(val[developed==1])))),
									 dev_sig = signstars(sum(val[developed==1]/val_se[developed==1])/sqrt(length(which(!is.na(val[developed==1]))))),
									 
									 em_Neffects= length(which(!is.na(val[developed==0]))),
				           em_welast = sum(val[developed==0]/val_se[developed==0])/sum(1/val_se[developed==0]),
									 em_z = sum(val[developed==0]/val_se[developed==0])/sqrt(length(which(!is.na(val[developed==0])))),
									 em_sig = signstars(sum(val[developed==0]/val_se[developed==0])/sqrt(length(which(!is.na(val[developed==0])))))
									 ), by=c('variable')]

  tmp=tmp[match(ordered_vars, variable)]
  setnames(tmp, 'variable', 'mmixinstr')
  return(tmp)
  })
  
iters = list(st=c('st', 'Short-term'), lt=c('lt', 'Long-term'))
for (iter in iters) {
  print(kable(sanitize_table(out[[iter[1]]]), digits=3, format='html', 
        caption=tab(paste0(iter[2], ' elasticities by marketing mix instrument'))) %>% kable_styling() %>% 
        footnote(general='*p*<.001 (two-sided).') %>% add_header_above(c(" " = 1, "All countries" = 4, "Developed countries" = 4, "Emerging countries" = 4)))
}

```

```{r elast_hist, echo=F}

# calculate quartiles for elasticities for each variable
elast[, obs_rank:=rank(elastlt), by = c('variable', 'developed')]
setorder(elast,variable, developed, obs_rank)
elast[, ptile := obs_rank/max(obs_rank), by = c('variable', 'developed')]
elast[, group:=cut(ptile, breaks=c(0,.25, .5, .75,1), labels=c('Q1', 'Q2', 'Q3', 'Q4'))]

# calculate means and weighted means, per group
#  out = lapply(list(st=c('elast', 'elast_se'), lt = c('elastlt','elastlt_se')), function(obj) {
tmp=elast[, list(qmeans=mean(elastlt),
                 qwmeans=sum(elastlt/elastlt_se)/sum(1/elastlt_se)),
          by=c('variable', 'developed','group')]

tmp2=elast[, list(qmeans=mean(elastlt),
                  qwmeans=sum(elastlt/elastlt_se)/sum(1/elastlt_se)),
          by=c('variable', 'developed')]

tmp2[, group:='Total']
setcolorder(tmp2, colnames(tmp))

tmp=rbind(tmp,tmp2)

pl<-lapply(c(qmeans='qmeans'), function(varplot) {
  lapply(ordered_vars, function(.var) {
  tmp[, pltv:=get(varplot)]
  ggplot(tmp[variable==.var], aes(x=group, y=pltv, fill=ifelse(developed==1, 'developed', 'emerging'))) + 
    theme_bw() + 
    geom_bar(position=position_dodge(), stat="identity") + 
    scale_fill_grey() + 
    #labs(title = fig(paste0("Mean long-term ", rename.fkt(.var), " elasticities per quartile"))) + 
    labs(title = fig(paste0("", rename.fkt(.var), ifelse(varplot=='qwmeans', ' (weighted)', ''), " elasticity"))) + 
    guides(fill=guide_legend("Development status")) +
    xlab("Quartiles") + 
    ylab("Elasticity")+ theme(plot.title = element_text(size=10))
  })
})

```

```{r elast_plot1, echo=F}
ggarrange(plotlist=pl$qmeans, common.legend=TRUE, legend='bottom')
```

Notes: Figures show mean long-term elasticities per quartile.

# Second-stage analysis

`r tab("Variable operationalization")`

Construct                  | Operationalization                                     | References
------------------------- | --------------------------------------------------------|----------
Appliance (versus electronics)| Dummy, equaling 1 for appliances (washing machines, microwaves and refrigerators), 0 for all other categories.
Category growth       | Log of a market's average growth rate in the observation period
Category concentration     | Log of Herfindahl index in a market
Domestic versus foreign brand | Dummy, equaling 1 if a brand's headquarter is located in the focal country; 0 if not.
Western brand | Dummy variable, equaling 1 if brand is headquartered in Western countries, 0 if not.
Brand equity               | Sales-based brand equity, obtained as a transformation of the brand-specific intercept from the market share attraction model; (a) short-term, (b) long-term, (c) standardized by category    | Datta, Ailawadi, and van Heerde (2017)
Brand-level market share  | Log of a brand's average market share in a market over the observation period
Price index | Log of a brand's average price (deflated sales value devided by the brand's sales volume over the observation period, indexed by the maximum price in a given category and country)
Global brand (BrandZ) | Dummy, equaling 1 if a brand is listed in BrandZ's *Top 100 Most Valuable global brands (2010)*, or *Top 50 Most Valuable Chinese Brands (2011)* | ...
Global competitiveness index | Overall score for a country's competitiveness^1^ | Global Competitiveness Report^1^
Subindex basic requirements | Score based on a country's development status determined by institutions, infrastructure, macroeconomic environment, and health & primary education^1^ | ...
Subindex efficiency enhancers | Score based on a country's development status determined by higher education & training, goods market efficiency, labor market efficiency, financial market development, technological readiness and market size^1^ | ...
Subindex innovation and sophistication factors | Score based on a country's development status determined by business sophistication and innovation^1^ | ...

*Note:* All continuous variables are logged and mean-centered before model estimation (except brand equity, which is only mean-centered as this variable can take on negative values). 

^1^ Based on the World Economic Forum's Global Competitiveness Report (2010/2011, available at https://www.weforum.org/reports/global-competitiveness-report-2010-2011)

```{r summarystats, echo=FALSE}

covars <- c('appliance', 'market_growth', 'herf', 'local_to_market', 'western_brand', 'sbbe_std', 'sbbe', 'sbbelt', 'overall_ms', 'overall_prindex', 'brandz', 'gci_overall_s', 'gci_sub_basicrequire_s', 'gci_sub_efficiencyenhance_s', 'gci_sub_innovation_s')

tmp=data.table(elast)
tmp = unique(tmp, by = c('market_id','brand', 'emerging'))

tmp=tmp[, lapply(.SD, function(x) c(min=min(x), max=max(x), mean=mean(x),sd=sd(x))), by = c('emerging'), .SDcols=c(covars)]
tmp[, var:=rep(c('min', 'max','mean', 'sd'),2)]
tmp=melt(tmp, id.var=c('emerging', 'var'))
tmp[, emerging_label:=ifelse(emerging==1, 'emerging', 'developed')]

dtf=dcast(tmp, variable~emerging_label+var)
setcolorder(dtf, c('variable', paste0(rep(c('emerging_', 'developed_'), each=4), rep(c('min', 'max', 'mean', 'sd'),2))))

setnames(dtf, gsub('emerging_', '', colnames(dtf)))
setnames(dtf, gsub('developed_', '', colnames(dtf)))

# to b de done.

dtf=sanitize_table(dtf)

kable(dtf, digits=3,caption = tab(paste0('Summary statistics for covariates in second-stage analysis, split by a country\'s development status')),
      format='html', initial.zero = FALSE) %>%
        kable_styling() %>% footnote(general=paste0('Note: Summary statistics computed on a sample of ', nrow(tmp), ' category-country-brand observations.')) %>%
  add_header_above(c(" " = 1, "Emerging countries" = 4, "Developed countries" = 4))
#c("striped", 'bordered')
```

# Analysis

```{r continue_with_selection, echo=FALSE}
elast_all=data.table(elast)
elast=elast[!is.na(country_of_origin)&!brand%in%c('unbranded')]
excluded_brands=setdiff(unique(elast_all$brand), unique(elast$brand))

```

On sample of `r length(unique(elast$brand))` unique brands (excluding `r paste0(my_capitalize(excluded_brands), collapse=', ')`).

## Plots

```{r elast_hist_by_emerging, echo=F}

# define median split variables
covars <- c('appliance', 'market_growth', 'herf', 'local_to_market', 'western_brand', 'sbbe_std', 'sbbe', 'sbbelt', 'overall_ms', 'overall_prindex', 'brandz')

# calculate split levels (if binary, take 0 and 1)
out=lapply(covars, function(.var) {
  is_binary = all(elast[, get(.var)]%in%c(0,1))
  
  if (is_binary==T) elast[!is.na(get(.var)), splitvar := ifelse(get(.var)==1, 'yes', 'no')]
  if (is_binary==F) {
    # calculate median
    median = median(elast[, get(.var)])
    elast[!is.na(get(.var)), splitvar := ifelse(get(.var)>=median, 'high', 'low')]
  }
  tmp=elast[!is.na(elastlt), list(meanelast = mean(elastlt)), by = c('variable','emerging','splitvar')]
  tmp[, ordered_rank:=match(variable, ordered_vars)]
  setorder(tmp, ordered_rank)
  tmp[, splitname:=.var]
  tmp[, emerging_label:=ifelse(emerging==1, 'emerging country', 'developed country')]
  tmp[, variable_label:=gsub(' activity', ' \nactivity', as.factor(rename.fkt(variable)))]
  return(tmp)
})

for (iter in seq(along=out)) {
  tmp=out[[iter]]#[splitname==.var]

tmp[, splitlabel := paste0(rename.fkt(splitname), ':\n', splitvar)]
titlecall=fig(paste0('Marketing mix elasticities for different values of ', rename.fkt(unique(tmp$splitname))))
              
tmp$variable_label <- reorder(tmp$variable_label, match(tmp$variable, ordered_vars))


 sp<- ggplot(tmp, aes(x=variable_label, y=meanelast))+ geom_bar(position=position_dodge(), stat="identity") +  theme_bw() + scale_fill_grey() +ylab("Elasticity") +  xlab("Marketing mix instrument") +labs(title = titlecall)+ theme(plot.title = element_text(size=10))

 pl2=sp + facet_grid(splitlabel ~ emerging_label, switch='y')  
  print(pl2)
} 
  
```


## Model selection 

```{r modelselection, echo = FALSE, results='asis'}

modellist = lapply(c('sbbe_std_mc', 'sbbe_mc', 'sbbelt_mc', 'ln_overall_ms_mc', 'brandz'), 
                   function(x) update.formula(update.formula(form_modelbasis, .~.+emerging), as.formula(paste0('.~. +', x))))

out1=regmodel(formula=modellist, dat=elast, model='lmer')

# assemble all variables
covlabels=unlist(sanitize_table(data.frame(unique(unlist(lapply(out1[[1]]$lt, function(x) colnames(x@pp$X)))))))
covlabels=c(covlabels[-which(covlabels=='(Intercept)')], 'Constant')

varsord = rep(ordered_vars,each=1)
names(varsord) <- paste0(unlist(sanitize_table(data.frame(varsord))), ' elasticity')

notes_base = "Regression of long-term elasticities on explanatory variables and three random effects, for brands, categories, and countries, respectively. Estimated using a linear mixed-effects model, with weights equal to the inverse of the elasticities' standard error, normalized to sum up to 1. Two-sided significance levels reported. Standard errors in parentheses."

#sink('../temp/test.html')
names(ordered_vars)=rename.fkt(ordered_vars)

cat("<P style='page-break-before: always'>")
printout(out1, 'lt', omit=NULL, title = tab('Model selection: regression with long-term elasticities in a pooled sample of developed and emerging countries'), vars=ordered_vars[1:2], notes=notes_base, covlabels=covlabels, column.separate=unlist(lapply(out1[ordered_vars[1:2]], function(x) length(x$lt))))

cat("<P style='page-break-before: always'>")
printout(out1, 'lt', omit=NULL, title = tab('Model selection: regression with long-term elasticities in a pooled sample of developed and emerging countries'), vars=ordered_vars[3:4], notes=notes_base, covlabels=covlabels, column.separate=unlist(lapply(out1[ordered_vars[3:4]], function(x) length(x$lt))))

#sink()
```

```{r randomcombined1, echo = FALSE, results='asis'}
m1 = update.formula(form_modelbasis, form_extraregressor)
m1b = update.formula(m1, .~.+emerging)

names(ordered_vars) <- paste0(unlist(sanitize_table(data.frame(ordered_vars))), ' elasticity')

out1=regmodel(formula=list(m1b), dat=elast, model='lmer')
carry_forward_model_for_plotting = out1

notes_base = "Regression of long-term elasticities on explanatory variables and three random effects, for brands, categories, and countries, respectively. Estimated using a linear mixed-effects model, with weights equal to the inverse of the elasticities' standard error, normalized to sum up to 1. Two-sided significance levels reported. Standard errors in parentheses."

cat("<P style='page-break-before: always'>")

covlabels=unlist(sanitize_table(data.frame(unique(unlist(lapply(out1[[1]]$lt, function(x) colnames(x@pp$X)))))))
covlabels=c(covlabels[-which(covlabels=='(Intercept)')], 'Constant')

printout(out1, 'st', omit=NULL, title = tab('DV: short-term elasticities, pooled sample of developed and emerging countries'), vars=ordered_vars,notes=gsub('long[-]term', 'short-term', notes_base), covlabels=covlabels,
         column.separate=unlist(lapply(out1, function(x) length(x$lt))))


cat("<P style='page-break-before: always'>")

printout(out1, 'lt', omit=NULL, title = tab('DV: long-term elasticities, pooled sample of developed and emerging countries'), vars=ordered_vars,notes=notes_base, covlabels=covlabels,
         column.separate=unlist(lapply(out1, function(x) length(x$lt))))

# interaction model
m2 = form_interact

cat("<P style='page-break-before: always'>")
out4=regmodel(formula=m2, dat=elast, model='lmer')

covlabels=unlist(sanitize_table(data.frame(colnames(out4[[1]]$lt[[1]]@pp$X))))
covlabels=c(covlabels[-which(covlabels=='(Intercept)')], 'Constant')

printout(out4, 'lt', omit=NULL, title = tab('DV: long-term elasticities, pooled sample of developed and emerging countries with interactions'), vars=ordered_vars, notes=paste0(notes_base), covlabels=covlabels)

```

```{r ploteffects, echo = FALSE, include = FALSE}
names(carry_forward_model_for_plotting)
j=1

outmod=lapply(seq(along=carry_forward_model_for_plotting), function(mod) {
  
  predmodel = carry_forward_model_for_plotting[[mod]]$lt[[j]]
  preddat = data.table(predmodel@frame)
  preddat[, predicted:=predict(predmodel)]
  tmp=preddat[, list(meanpred=mean(predicted), sd=sd(predicted)),by=c('emerging')]
  tmp[, variable:=names(carry_forward_model_for_plotting)[mod]]
  return(tmp)
})

outmod=rbindlist(outmod)

pl<-lapply(ordered_vars, function(.var) {
  tmp=outmod[variable==.var]
  ggplot(tmp, aes(x=ifelse(emerging==1, 'developed', 'emerging'), y=meanpred, fill=ifelse(emerging==1, 'developed', 'emerging'))) + 
    theme_bw() + 
    geom_bar(position=position_dodge(), stat="identity") + 
    scale_fill_grey() + 
    labs(title = fig(paste0("", rename.fkt(.var)," elasticity"))) + 
    guides(fill=guide_legend("Development status")) +
    xlab("Development status") + 
    ylab("Elasticity")+ theme(plot.title = element_text(size=10)) +
    geom_errorbar(aes(ymin=meanpred-sd, ymax=meanpred+sd),
                  width=.2,                    # Width of the error bars
                  position=position_dodge(.9))

  })

ggarrange(plotlist=pl, common.legend=TRUE, legend='bottom')


```


```{r randomcombined4, echo = FALSE, results='asis'}

m1 = update.formula(update.formula(form_random_component_FE, form_std), form_extraregressor)

cat("<P style='page-break-before: always'>")
out5=regmodel(formula=m1, dat=elast, model='lmer')
covlabels=unlist(sanitize_table(data.frame(colnames(out5[[1]]$lt[[1]]@pp$X))))
covlabels=c(covlabels[-which(covlabels=='(Intercept)')], 'Constant')
printout(out5, 'lt', omit=NULL, title = tab('DV: long-term elasticities, with country-fixed effects'),vars=ordered_vars, notes="Regression of long-term elasticities on country fixed-effects (baseline: Australia), explanatory variables and two random effects for brands and categories. Estimated using a linear mixed-effects model, with weights equal to the inverse of the elasticities' standard error, normalized to sum up to 1. Two-sided signifiance levels reported. Standard errors in parentheses.", covlabels=covlabels)

```

```{r correltabinfra, echo=FALSE, results='asis'}

m1 = update.formula(update.formula(form_random_component_FE, form_std), form_extraregressor)

out5=regmodel(formula=m1, dat=elast, model='lmer')

# collect fixed effects
res=rbindlist(lapply(seq(along=out5), function(x) {
 varname=names(out5)[x]
 coefs=data.frame(coef(summary(out5[[x]]$lt[[1]])))
 coefs$country=gsub('as.factor[(]country[)]', '', rownames(coefs))
 coefs=data.table(coefs)[country%in%unique(elast$country)]
 coefs=rbindlist(list(coefs, data.table(0,0,0,'australia')))
 setnames(coefs, c('fe','se','t','country'))
 return(coefs[, ':=' (se=NULL,t=NULL, varname=varname)])
}))

fixedeffects=dcast(res,country~varname, value.var='fe')

tmp <- merge(fixedeffects, gci, by = c('country'))
tmp[, ':=' (country=NULL)]

out=corstars(as.matrix(tmp))

out=data.frame(corstars(as.matrix(tmp)))
out=out[-c(1:4),c(1:4)]


tmp = out
tmp$variable<-rownames(tmp)
tmp$variable_renamed=sapply(rownames(tmp), rename.fkt, dictionary='renaming_gci.txt')
tmp = tmp[, c('variable', 'variable_renamed', ordered_vars)]
rownames(tmp)<-NULL
colnames(tmp)<-sapply(colnames(tmp), rename.fkt)
colnames(tmp)[3:6]<-paste0(colnames(tmp)[3:6], c(' fixed-effect'))
tmp=data.table(tmp)[grepl('[_]s$', variable)]

filters <- list(c(regex='overall[_]|sub[_]', name='summarized pillars in global competitiveness report'),
                c(regex='gci[_]p[0-9]', name='12 pillars in global competitiveness report'))#,
                #c(regex='gci[_][0-9]', name='individual items in global competitiveness report'))

tableno_fixed = tableno-1
for (filt in filters) {                
  cat("<P style='page-break-before: always'>")

print(kable(tmp[grepl(filt["regex"], variable),][, variable:=NULL], caption = tab(paste0('Correlations of ', filt["name"], ' (scores) with marketing-mix elasticities')),
      format='html', initial.zero = FALSE) %>%
        kable_styling() %>% footnote(general=paste0('Note: Table reports, for each marketing mix instrument, the correlations between the scores of ', filt["name"], ' (2010/2011 data, see https://www.weforum.org/reports/global-competitiveness-report-2010-2011), and the country-fixed effects reported in Table ', tableno_fixed, '. N = ', nrow(fixedeffects), '. Significance levels: *p<.1, **p<.05, ***p<.01, ****p<.001.')))
}

```

```{r report_pca, echo=FALSE,results='asis'} 

scores = fread('../output/pca_1comp_loadings.csv')
setnames(scores, c('variable', 'stdloading'))

scores[, variable_renamed:=sapply(variable, rename.fkt, dictionary='renaming_gci.txt')]
setcolorder(scores, c('variable_renamed', 'stdloading', 'variable'))
scores[, variable:=NULL]
setnames(scores, 'variable_renamed', 'Variable')
setnames(scores, 'stdloading', 'Standardized loading')

print(kable(scores, caption = tab(paste0('Standardized loadings on principal component for GCI metrics')),
      format='html', initial.zero = FALSE, digits = 3)%>%
        kable_styling())

```


```{r randomcombined_factorscore, echo = FALSE, results='asis'}
m1 = update.formula(form_modelbasis, form_extraregressor)
m1b = update.formula(m1, .~.+gcifactor_mc)

names(ordered_vars) <- paste0(unlist(sanitize_table(data.frame(ordered_vars))), ' elasticity')

out1=regmodel(formula=list(m1b), dat=elast, model='lmer')
carry_forward_model_for_plotting = out1

notes_base = "Regression of long-term elasticities on explanatory variables and three random effects, for brands, categories, and countries, respectively. Estimated using a linear mixed-effects model, with weights equal to the inverse of the elasticities' standard error, normalized to sum up to 1. Two-sided significance levels reported. Standard errors in parentheses."

cat("<P style='page-break-before: always'>")

covlabels=unlist(sanitize_table(data.frame(unique(unlist(lapply(out1[[1]]$lt, function(x) colnames(x@pp$X)))))))
covlabels=c(covlabels[-which(covlabels=='(Intercept)')], 'Constant')

printout(out1, 'lt', omit=NULL, title = tab('DV: long-term elasticities, pooled sample of developed and emerging countries, with GCI component score'), vars=ordered_vars,notes=notes_base, covlabels=covlabels,
         column.separate=unlist(lapply(out1, function(x) length(x$lt))))

# interaction model
cat("<P style='page-break-before: always'>")
out4=regmodel(formula=form_interact_gci, dat=elast, model='lmer')

covlabels=unlist(sanitize_table(data.frame(colnames(out4[[1]]$lt[[1]]@pp$X))))
covlabels=c(covlabels[-which(covlabels=='(Intercept)')], 'Constant')

printout(out4, 'lt', omit=NULL, title = tab('DV: long-term elasticities, pooled sample of developed and emerging countries, using interactions with the GCI component score'), vars=ordered_vars, notes=paste0(notes_base), covlabels=covlabels)

```


# Appendix

```{r reset, echo=FALSE,results='asis'}
tableno<<-0
figureno<<-0
cat("<P style='page-break-before: always'>")
  
```

```{r sample_overview, echo=FALSE, results='asis'}
#, headquarter_region=unique(country_of_origin)
tmp=elast[, list(active_in_countries=length(unique(country)), active_in_categories=length(unique(category)), headquarter_location=unique(country_of_origin)), by = c('brand')]
setorderv(tmp, c('active_in_countries','active_in_categories', 'brand'),order=-1L)

tmp[, ':=' (brand=stri_trans_totitle(brand), headquarter_location=stri_trans_totitle(headquarter_location))]#, #headquarter_region=stri_trans_totitle(headquarter_region))]
tmp=sanitize_table(tmp)


kable(tmp, caption = tab('Overview of selected brands, ordered by the number of countries and categories it is active in', prefix ='A'))
```

```{r sample_origin, echo=FALSE, results='asis'}

cols =  c('country_of_origin', 'western_brand', 'asian_brand', 'other_brand', 'brandz')
tmp = elast[, list(.N), by = c('brand',cols)]
tmp = tmp[, list(nbrands=length(unique(brand)), all_brands=paste(stri_trans_totitle(brand[order(brand)]), collapse=', ')), by = cols]
tmp[country_of_origin==''|is.na(country_of_origin), country_of_origin := 'Country not available']
tmp[, country_of_origin:=stri_trans_totitle(country_of_origin)]
tmp[, other_brand:=as.character(ifelse(other_brand==1, 'yes', NA))]
tmp[, western_brand:=as.character(ifelse(western_brand==1, 'yes', NA))]
tmp[, asian_brand:=as.character(ifelse(asian_brand==1, 'yes', NA))]
tmp[, brandz:=as.character(ifelse(brandz==1, 'yes', NA))]

setorderv(tmp, 'nbrands', order=-1L)
setcolorder(tmp, c('country_of_origin', 'nbrands', 'western_brand', 'asian_brand', 'other_brand', 'brandz', 'all_brands'))

tmp=sanitize_table(tmp)

kable(tmp, caption = tab('Country-of-origins for brands in sample, ordered by the number of brands from a given country', prefix ='A'),format='html') %>%
        kable_styling() %>% footnote(general=paste0('Note: Brand names listed alphabetically.'))

```





```{r elast_by_win, echo=F,results='asis'}

# apply winsorization
elast[!is.na(elastlt), winsorized := winsor_onesided(elastlt, fraction=winsor_p, ifelse(variable=='rwpspr', 'right','left')), by=c('variable')]

for (byvar in c('category', 'country')) {
  tmp=elast[!is.na(elastlt), list(nowin=mean(elastlt), elast = mean(winsorized)), by=c('variable', byvar)]
  setnames(tmp, byvar, 'byvar')
  
  tmp=dcast(tmp,byvar~variable,value.var='elast')
  setnames(tmp, 'byvar', byvar)
  setcolorder(tmp, c(byvar, ordered_vars))
  
  tmp=sanitize_table(tmp)
  setorderv(tmp, colnames(tmp)[1])
  
  cat("<P style='page-break-before: always'>")
  print(kable(tmp, digits=3, caption = tab(paste0('Long-term elasticities (by ', byvar, ', winsorized)'), prefix='A'), format='html', initial.zero = FALSE) %>%
        kable_styling() %>% footnote(general=paste0('Note: Table reports winsorized long-term elasticities (winsorization at ', winsor_p*100, '%, left-sided for all variables except price). ', ifelse(byvar=='country', 'Countries', 'Categories'), ' ordered alphabetically.')))
}
  
```	


```{r rq4_growth, echo=FALSE,results='asis'}
tmp=unique(elast, by = c('market_id')) # t-tests on growth rates

t_tests <- lapply(unique(elast$category), function(var) {
    tmpdat = tmp[category == var]
    teststat=t.test(tmpdat[country_class=='hinc']$market_growth, tmpdat[country_class=='linc']$market_growth)
    
    tabl = data.frame(category=var, mean1=teststat$estimate[1], mean2=teststat$estimate[2], t=teststat$statistic, p=teststat$p.value)
                
    return(list(summary=tabl))
})

out=rbindlist(lapply(t_tests, function(x) x$summary))

percent <- function(x, digits = 1, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}

out[, ':=' (mean1=percent(mean1-1), mean2=percent(mean2-1))]
out[, category:=as.character(category)]
out=sanitize_table(out)
setorder(out, Category)
setnames(out, 'mean1', 'developed countries')
setnames(out, 'mean2', 'emerging countries')
cat("<P style='page-break-before: always'>")
kable(out, format='html',caption = tab('Average category growth rates for developed and emerging countries',prefix='A'),digits=3) %>% kable_styling() %>% footnote(general=paste0('Note: Table reports average category growth rates, and the results of a t-test of statistical significance of the difference in growth rates between developed and emerging countries. Categories are ordered alphabetically.'))
  
```

```{r VIFS, echo=FALSE,results='asis'}

m1 = ~1+ appliance + ln_market_growth_mc + ln_herf_mc + local_to_market + western_brand + ln_overall_prindex_mc 

m<-lm(update(elast~., m1), data=elast[variable=='llen'])

frame1=data.frame(vif(m))
colnames(frame1) <- c('VIF')
frame1$variable=rownames(frame1)
rownames(frame1)<-NULL
frame1=frame1[, c('variable','VIF')]
frame1=sanitize_table(frame1)
cat("<P style='page-break-before: always'>")
kable(frame1,format='html', caption = tab('VIFs in a model without interactions', prefix='A'))%>% kable_styling() %>% footnote(general=paste0('Note: VIFs calculated in regression models using the variables listed above (i.e., excluding brand, category, and country effects).'))

```

```{r elasts_full, echo=F,results='asis'}

cat("<P style='page-break-before: always'>")

  sigvalue = .1 # .1-level of significance
  zval = qnorm(1-sigvalue/2)

  out = lapply(list(st=c('elast', 'elast_se'), lt = c('elastlt','elastlt_se')), function(obj) {
               
    tmp = elast[!is.na(get(obj[1]))][, ':=' (val=get(obj[1]), val_se=get(obj[2]))]
    
    tmp[, winsorizedval := winsor_onesided(val, fraction=winsor_p, ifelse(variable=='rwpspr', 'right','left')), by=c('variable')]

    tmp=tmp[, list(Neffects=.N, median_elast = median(val), 
												  w_elast = sum(val/val_se)/sum(1/val_se),
												  win_elast = mean(winsorizedval),
												  perc_positive = length(which(val/val_se>=(zval)))/.N, 
												  perc_null = length(which(abs(val/val_se)<zval))/.N, 
												  perc_negative = length(which(val/val_se<=(-zval)))/.N), by=c('variable')]
    
  tmp=tmp[match(ordered_vars, variable)]
  setnames(tmp, 'variable', 'mmixinstr')
  return(tmp)
  })
  
iters = list(st=c('st', 'Short-term'), lt=c('lt', 'Long-term'))
for (iter in iters) {
  print(kable(sanitize_table(out[[iter[1]]]), digits=3, format='html', 
        caption=tab(paste0(iter[2], ' elasticities by marketing mix instrument'),prefix='A')) %>% kable_styling() %>% 
        footnote(general=paste0('Note: Table reports ', tolower(iter[2]), ' elasticities. Weights, if used, are equal to inverse standard errors of estimated elasticities. Winsorization at ', winsor_p*100, '%, left-sided for all variables except price. Significance tested at p<',sigvalue, '.')))
}

```

# Estimation details

## Market share attraction model

Elasticities estimated using a market share attraction model (MCI), with

* four marketing mix instruments:
     + llen = line length (number of SKUs)
     + wpswdst = distribution (weighted using past sales in previous three periods)
     + price = rwpspr (deflated using a country's CPI, weighted using past sales in previous three periods)
     + novelty = nov6sh (number of SKUs introduced in past six periods, expressed as a share of total SKUs sold in a given period)
  
* endogeneity controls using Gaussian Copulas (tested at p<.1; removed if n.s.)
* lagged market share to model dynamics
* brand-specific trend
* brand-specific quarterly dummies

Elasticities and corresponding standard errors calculated using the Delta rule.

## Estimation data set

- Number of markets: `r length(unique(elast_all$market_id))`.
- Number of brands: `r nrow(elast_all[, .N, by = c('market_id', 'brand')])`.
- Number of unique brands: `r nrow(elast_all[, .N, by = c('brand')])`.
- Included countries (`r length(unique(elast_all$country))`): `r paste0(unique(elast_all$country),collapse = ', ')`.
- Included categories (`r length(unique(elast_all$category))`): `r paste0(unique(elast_all$category),collapse = ', ')`.

```{r overview2, echo=FALSE, results='asis'}
tmp = elast_all[, list(Nbrands = length(unique(brand))), by = c('market_id', 'category','country')]

tabl = dcast(tmp, category~country, value.var=c('Nbrands'))
#print(xtable(tabl, caption = tab('Overview of categories and countries (with number of brands indicated for each market), in estimation data')), scalebox='0.6',type='html',caption.placement='top')
tabl=sanitize_table(tabl)
setorder(tabl, Category)
kable(tabl, caption = tab('Overview of categories and countries (with number of brands indicated for each market), in estimation data', prefix='A'))

```


