---
title: "GfK Singapore - WLS"
output:
  html_document: default
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(stargazer)
library(knitr)
require(xtable)
#require(texreg)
library(lme4)
library(car)

options(xtable.comment = FALSE)

# Load data
  #elast <- fread('../externals/elast_results_MCI_wlag_wotrend.csv')
  elast <- fread('../externals/elast_results_MCI_wolag_trend.csv')

# Load auxilary functions
  source('proc_auxilary.R')

# load extra variables
  hdi <- fread('../temp/hdi.csv')
# change taiwan (reported value from China is not reliable)
  hdi[, hdi2010:=ifelse(country=='taiwan', mean(hdi2010[country%in%c('thailand', 'china')]), hdi2010)]
# Load GDP
  gdp <- fread('../temp/gdp.csv')
# Merge
  setkey(hdi, country)
  setkey(elast, country)
  elast[hdi, hdi2010:=i.hdi2010]
  setkey(gdp, country)
  elast[gdp, gdppercap2010:=i.gdppercap2010]

  elast[, country_of_origin_recode := ifelse(country_of_origin%in%c('local','asian_other'), 'asian', country_of_origin)]
  
  # elast asian devel vs. not
  elast[, region_of_origin:=country_of_origin_recode]
  elast[region_of_origin=='asian'& country_class=='hinc', region_of_origin := 'asian-high']
  elast[region_of_origin=='asian'& country_class=='linc', region_of_origin := 'asian-low']
  
  
# take natural log of variables
vars=c('herf','c3','c5','market_growth','hdi2010','gdppercap2010', 'ncat_in_country', 'ncountry_in_category')

for (var in vars) {
  elast[, (paste0('ln_', var)):=log(get(var))]
  
}

# grand-mean centering by variable (llen, etc.) for all explanatory (continuous) variables
for (var in unique(drop(unlist(lapply(vars, grep, colnames(elast), value=T))))) {
  elast[, (paste0(var, '_mc')):=get(var)-mean(get(var)), by = c('variable')]
  }
  
# focal dummies: local_to_market, western (versus asian)

#
elast[, worldbank := '']
elast[country%in%c('india','indonesia', 'vietnam', 'philippines'), worldbank:='lowermid']
elast[country%in%c('china', 'malaysia','thailand'), worldbank:='uppermid']
elast[worldbank=='', worldbank:='high']


### brand selection for analysis
elast=elast[globalbrand==T] # global brands (active in >=3 countries) only

#elast=elast[ncountries>=2]

```

# Sample

## Selected brands

```{r sample_overview, echo=FALSE, results='asis'}

tmp=elast[, list(ncountries=length(unique(country)), ncategories=length(unique(category))), by = c('brand')]
setorderv(tmp, c('ncountries','ncategories'),order=-1L)
print(xtable(tmp, caption=tab('Overview of selected brands')), type='html',caption.placement='top')

```

## Elasticities for selected brands

Significance tested at p<.1 (|z| >= 1.64)

```{r elast_ov, echo = FALSE, results='asis'}
  .vars=c('llen','wpswdst','rwpspr','nov6sh')
	
  zval=qnorm(.95)
  
	tmp=elast[!is.na(elast), list(median_elast = median(elast), 
												  w_elast = sum(elast/elast_se)/sum(1/elast_se), 
												  N_brands= .N, 
												  perc_positive = length(which(elast/elast_se>=(zval)))/.N, 
												  perc_null = length(which(abs(elast/elast_se)<zval))/.N, 
												  perc_negative = length(which(elast/elast_se<=(-zval)))/.N), by=c('variable')]
	kable(tmp[match(.vars, variable)], caption = tab('Short-term elasticities by variable'))
	
  tmp=elast[!is.na(elastlt), list(median_elast = median(elastlt), 
												  w_elast = sum(elastlt/elastlt_se)/sum(1/elastlt_se), 
												  N_brands= .N, 
												  perc_positive = length(which(elastlt/elastlt_se>=(zval)))/.N, 
												  perc_null = length(which(abs(elastlt/elastlt_se)<zval))/.N, 
												  perc_negative = length(which(elastlt/elastlt_se<=(-zval)))/.N), by=c('variable')]
	kable(tmp[match(.vars, variable)], caption = tab('Long-term elasticities by variable'))

```


# degree of development

- GDP per capita in 2010, in USD
- Human Development Index in 2010 (imputed for Taiwan as mean of China and Thailand)

```{r devel, echo = FALSE}
tmp=unique(elast, by='country')[, c('country','gdppercap2010','hdi2010'),with=F]
setorderv(tmp, c('gdppercap2010'), order=-1L)
kable(tmp, caption=tab('Development indicators for countries in sample'))
```

# Descriptives

(to be done)


## random effects for countries, categories, and brands.

### with Western brand

```{r randomcombined1, echo = FALSE, results='asis'}

m1 = ~1+ln_gdppercap2010_mc + (1|brand) + (1|category) + (1|country)+ necessity + ln_market_growth_mc + ln_herf_mc + local_to_market + western_brand + ln_ncat_in_country_mc + ln_ncountry_in_category_mc

interact1 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc +
  local_to_market*ln_gdppercap2010_mc + western_brand*ln_gdppercap2010_mc

m2=update(m1, interact1)

out1=regmodel(formula=m1, dat=elast, model='lmer')

printout(out1, 'lt', omit=NULL, title = tab('long-term'), vars=NULL)

cat("<P style='page-break-before: always'>")
out2=regmodel(formula=m2, dat=elast, model='lmer')
printout(out2, 'lt', omit=NULL, title = tab('long-term, with interactions'), vars=NULL)


```

### with North America/Europe split

```{r randomcombined2, echo = FALSE, results='asis'}

m1 = ~1+ln_gdppercap2010_mc + (1|brand) + (1|category) + (1|country)+ necessity + ln_market_growth_mc + ln_herf_mc + local_to_market + country_of_origin_recode + ln_ncat_in_country_mc + ln_ncountry_in_category_mc

interact1 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc +
  local_to_market*ln_gdppercap2010_mc + country_of_origin_recode*ln_gdppercap2010_mc

m2=update(m1, interact1)

out1=regmodel(formula=m1, dat=elast, model='lmer')

cat("<P style='page-break-before: always'>")
printout(out1, 'lt', omit=NULL, title = tab('long-term'), vars=NULL)

cat("<P style='page-break-before: always'>")
out2=regmodel(formula=m2, dat=elast, model='lmer')
printout(out2, 'lt', omit=NULL, title = tab('long-term, with interactions'), vars=NULL)


```

### with North America/Europe/Asian high-low split

```{r randomcombined3, echo = FALSE, results='asis'}

m1 = ~1+ln_gdppercap2010_mc + (1|brand) + (1|category) + (1|country)+ necessity + ln_market_growth_mc + ln_herf_mc + local_to_market + region_of_origin + ln_ncat_in_country_mc + ln_ncountry_in_category_mc

interact1 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc +
  local_to_market*ln_gdppercap2010_mc + region_of_origin*ln_gdppercap2010_mc

m2=update(m1, interact1)

out1=regmodel(formula=m1, dat=elast, model='lmer')

cat("<P style='page-break-before: always'>")
printout(out1, 'lt', omit=NULL, title = tab('long-term'), vars=NULL)

cat("<P style='page-break-before: always'>")
out2=regmodel(formula=m2, dat=elast, model='lmer')
printout(out2, 'lt', omit=NULL, title = tab('long-term, with interactions'), vars=NULL)

```

# VIFs

estimating an auxilary regression (elast for llen on variables, without brand/category/country effects), then computing VIFs.

```{r VIFS, echo=FALSE}
m1 = ~1+ln_gdppercap2010_mc + necessity + ln_market_growth_mc + ln_herf_mc + local_to_market + western_brand + ln_ncat_in_country_mc + ln_ncountry_in_category_mc

interact1 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc +
  local_to_market*ln_gdppercap2010_mc + western_brand*ln_gdppercap2010_mc

m2=update(m1, interact1)

m<-lm(update(elast~., m1), data=elast[variable=='llen'])
m2<-lm(update(elast~., m2), data=elast[variable=='llen'])

kable(data.frame(vif(m)), caption = 'VIFs without interactions')
kable(data.frame(vif(m2)), caption = 'VIFs with interactions')


```


## RQ2: country differences

random effects for brand/category, fixed effects for countries.

### with Western brand

```{r randomcombined4, echo = FALSE, results='asis'}

m1 = ~1+ (1|brand) + (1|category) + as.factor(country) + necessity + ln_market_growth_mc + ln_herf_mc + local_to_market + western_brand + ln_ncat_in_country_mc + ln_ncountry_in_category_mc

out1=regmodel(formula=m1, dat=elast, model='lmer')

cat("<P style='page-break-before: always'>")
printout(out1, 'lt', omit=NULL, title = tab('long-term'), vars=NULL)


```
