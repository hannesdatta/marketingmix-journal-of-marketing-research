---
title: "GfK Singapore - Results"
output:
  html_document: default
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(stargazer)
library(knitr)
require(xtable)
library(lme4)
library(car)
library(kableExtra)
library(stringi)
library(ggplot2)

options(xtable.comment = FALSE)

# Load data
  #elast <- fread('../externals/elast_results_MCI_wlag_wotrend.csv')
  elast <- fread('../externals/elast_results_MCI_wolag_trend.csv')

# Load auxilary functions
  source('proc_auxilary.R')
  source('proc_rename.R')
  
# load data for extra variables
  hdi <- fread('../temp/hdi.csv')

# change taiwan (reported value from China is not reliable)
  hdi[, hdi2010:=ifelse(country=='taiwan', mean(hdi2010[country%in%c('thailand', 'china')]), hdi2010)]

# Load GDP
  gdp <- fread('../temp/gdp.csv')

# Merge
  setkey(hdi, country)
  setkey(elast, country)
  elast[hdi, hdi2010:=i.hdi2010]
  setkey(gdp, country)
  elast[gdp, gdppercap2010:=i.gdppercap2010]

  # elast asian devel vs. not
  elast[, region_of_origin:=country_of_origin_recode]
  elast[region_of_origin=='asian'& country_class=='hinc', region_of_origin := 'asian-high']
  elast[region_of_origin=='asian'& country_class=='linc', region_of_origin := 'asian-low']
  
  elast[, developed:=0]
  elast[country%in%c('australia', 'singapore', 'japan', 'new zealand', 'hong kong', 'south korea', 'taiwan'), developed := 1]


# take natural log of variables
vars=c('herf','c3','c5','market_growth','hdi2010','gdppercap2010', 'ncat_in_country', 'ncountry_in_category', 'sbbe_std')

for (var in vars) {
  elast[, (paste0('ln_', var)):=log(get(var))]
  
}

# grand-mean centering by variable (llen, etc.) for all explanatory (continuous) variables
for (var in unique(drop(unlist(lapply(vars, grep, colnames(elast), value=T))))) {
  elast[, (paste0(var, '_mc')):=get(var)-mean(get(var)), by = c('variable')]
  }
  
# focal dummies: local_to_market, western (versus asian)

#
elast[, worldbank := '']
elast[country%in%c('india','indonesia', 'vietnam', 'philippines'), worldbank:='lowermid']
elast[country%in%c('china', 'malaysia','thailand'), worldbank:='uppermid']
elast[worldbank=='', worldbank:='high']

options(knitr.kable.NA = '')

### brand selection for analysis
#elast=elast[globalbrand==T] # global brands (active in >=3 countries) only

#elast=elast[ncountries>=2]

source('proc_rename.R')

# Load GCI infrastructure data
gci <- fread('../temp/gci.csv')

elast=merge(elast, gci, by = c('country'),all.x=T)

ordered_vars = c('rwpspr', 'wpswdst','llen','nov6sh')

elast[!is.na(elast), weightsst := (1/elast_se)/sum(1/elast_se), by = c('variable')]
elast[!is.na(elastlt), weightslt := (1/elastlt_se)/sum(1/elastlt_se), by = c('variable')]

```

# Data

```{r devel, echo = FALSE}
tmp=unique(elast, by='country')[, c('country','gdppercap2010','hdi2010'),with=F]
setorderv(tmp, c('gdppercap2010'), order=-1L)
kable(sanitize_table(tmp), format='html', initial.zero = FALSE, caption=tab('Development indicators for countries in sample')) %>%
        kable_styling() %>% footnote(general='Countries ranked by GDP per capita.', alphabet=c("GDP per capita in current USD, 2010 data, provided by World Bank (https://data.worldbank.org/indicator/NY.GDP.PCAP.CD) for all countries except Taiwan. Data for Taiwan obtained from Thomson Reuters Datastream (symbol: TWGDPPEAA).", "Human Development Index (HDI), 2010 data, obtained from UN Development Programme (http://hdr.undp.org/en/content/human-development-index-hdi). Taiwan's HDI has been imputed as the mean HDI of Thailand and China.")) %>%
  group_rows("Developed economies", 1, 6) %>%
  group_rows("Emerging economies", 7, 14)

```

```{r table2_category_overview, echo = FALSE}
tmp=data.table(elast)
tmp[, ncountries:=length(unique(country)),by=c('category')]

tmp=tmp[, list(overall_ms=mean(overall_ms), ncountries=mean(ncountries)), by = c('category', 'appliance', 'brand')]

setorderv(tmp, c('category', 'appliance', 'overall_ms'), order=-1L)
tmp[!brand%in%c('unbranded','local'), rank:=1:.N, by = c('category')]
tmp[, brand_include:= rank%in%1:5]

sort_alpha <- function(x) return(x[order(x)])

tmp=tmp[, list(cattype=ifelse(unique(appliance)==1, 'Appliance', 'Electronics'), ncountries=unique(ncountries), nbrands=length(unique(brand)), exemplary_brand_names=paste0(sort_alpha(stri_trans_totitle(unique(brand[brand_include==T]))), collapse=', ')), by='category']
tmp=sanitize_table(tmp)

try(setorder(tmp, Category),silent=T)


kable(tmp, format='html', caption=tab('Category overview')) %>%
        kable_styling() %>% footnote(general='Categories shown in alphabetical order. Exemplary brand names are given for the top 5 brands in terms of average volume share across countries.')

```

# Market share model

`r tab('Variable operationalization for market share attraction model')`


Variable             | Operationalization
-------------------- | ------------------------------------------------------------------
Market share         | Unit sales for brand *i* in period *t*, devided by total unit sales in period *t* in a market
Price                | Sales-weighted^1^ average of each SKU's price sold by brand *i* in period *t*, expressed in local currency and adjusted by a country's consumer price index^2^
Distribution         | Sales-weighted^1^ distribution of each of brand *i*'s SKUs' weighted distribution in period *t* (0 = no market coverage, 100 = full market coverage)
Line length          | Number of unique SKUs sold by brand *i* in period *t*
New product activity | Number of SKUs introduced by brand *i* in a rolling window of 6 months (*t-5*, *t-4*, *...*, *t*), expressed as a share of total unique SKUs sold by brand *i* over the same period

Notes:

^1^ Weights equal to a SKU's unit sales in the most recent quarter (t-2, t-1, t).

^2^ Consumer price index obtained from [...].

```{r elast_ov, echo = FALSE, results='asis'}
  .vars=c('llen','wpswdst','rwpspr','nov6sh')
	
  zval=qnorm(.95) # zval for .1-level of significance

  sigvalue = .1
  sigtest = qnorm(1-sigvalue/2)

	signstars <- function(zscore) { # converts a z-score into a signifance asteriks
	  if (length(zscore)==0) return("   ")
	  if (is.nan(zscore) | !is.numeric(zscore) | is.na(zscore)) return("   ")
	  ret <- "ns."
	  #if (abs(zscore)>qnorm(1-(0.1))) ret <- c(paste("  ", rawToChar(as.raw(134)), sep=''))
	  
	  if (abs(zscore)>qnorm(1-(0.1/2))) ret <- c("  *")
	  if (abs(zscore)>qnorm(1-(0.05/2))) ret <- c(" **")
	  if (abs(zscore)>qnorm(1-(0.01/2))) ret <- c("***")
	  return(ret)
	  }

#	all_p = signstars(sum(elast/elast_se,na.rm=T)/sqrt(length(unique(id[!is.na(elast)])))),

	
  tmp=elast[!is.na(elastlt), list(Neffects= .N, 
                          all_welast = sum(elastlt/elastlt_se)/sum(1/elastlt_se),
												  all_z = sum(elastlt/elastlt_se,na.rm=T)/sqrt(length(which(!is.na(elastlt)))),
												  all_sig = signstars(sum(elastlt/elastlt_se,na.rm=T)/sqrt(length(which(!is.na(elastlt))))),
												  
												  dev_Neffects= length(which(!is.na(elastlt[developed==1]))),
				                  dev_welast =sum(elastlt[developed==1]/elastlt_se[developed==1])/sum(1/elastlt_se[developed==1]),
												  dev_z = sum(elastlt[developed==1]/elastlt_se[developed==1],na.rm=T)/sqrt(length(which(!is.na(elastlt[developed==1])))),
												  dev_sig = signstars(sum(elastlt[developed==1]/elastlt_se[developed==1],na.rm=T)/sqrt(length(which(!is.na(elastlt[developed==1]))))),
												  em_Neffects= length(which(!is.na(elastlt[developed==0]))),
				                  em_welast =sum(elastlt[developed==0]/elastlt_se[developed==0])/sum(1/elastlt_se[developed==0]),
												  em_z = sum(elastlt[developed==0]/elastlt_se[developed==0],na.rm=T)/sqrt(length(which(!is.na(elastlt[developed==0])))),
												  all_sig = signstars(sum(elastlt[developed==0]/elastlt_se[developed==0],na.rm=T)/sqrt(length(which(!is.na(elastlt[developed==0])))))), by=c('variable')]

#	kable(tmp, digits=3, caption = tab('Long-term elasticities by variable'))
#stargazer(tmp,type='html')
tmp=tmp[match(ordered_vars, variable)]
setnames(tmp, 'variable', 'mmixinstr')

kable(sanitize_table(tmp), digits=3,format='html', caption=tab('Long-term elasticities by marketing mix instrument')) %>% kable_styling() %>% footnote(general='*p*<.001 (two-sided).') %>% add_header_above(c(" " = 1, "All countries" = 4, "Developed countries" = 4, "Emerging countries" = 4))

```

```{r elast_hist, echo=F}

elast[, obs_rank:=rank(elastlt), by = c('variable', 'developed')]
setorder(elast,variable, developed, obs_rank)
elast[, ptile := obs_rank/max(obs_rank), by = c('variable', 'developed')]
elast[, group:=cut(ptile, breaks=c(0,.25, .5, .75,1), labels=c('Q1', 'Q2', 'Q3', 'Q4'))]

tmp=elast[, list(qmeans=mean(elastlt)),by=c('variable', 'developed','group')]
tmp2=elast[, list(qmeans=mean(elastlt)),by=c('variable', 'developed')]
tmp2[, group:='Total']
setcolorder(tmp2, colnames(tmp))
tmp=rbind(tmp,tmp2)

for (.var in ordered_vars){
p<-ggplot(tmp[variable==.var], aes(x=group, y=qmeans, fill=ifelse(developed==1, 'developed', 'emerging'))) + theme_bw() + geom_bar(position=position_dodge(), stat="identity") +ggtitle(fig('.var')) +scale_fill_grey() + labs(title = fig(paste0("Mean long-term ", rename.fkt(.var), " elasticities per quartile")))+guides(fill=guide_legend("Development status")) +xlab("Quartiles") + 
           ylab("Elasticity")
print(p)
}

```

# Second-stage analysis

`r tab("Variable operationalization")`

Construct                  | Operationalization                                     | References
------------------------- | --------------------------------------------------------|----------
Appliance (vs. electronics)| Dummy, equaling 1 for appliances (washing machines, microwaves and refridgerators), 0 if not.
Category growth rate       | Log of a market's average growth rate in the observation period (geometric average)
Category concentration     | Log of Herfindahl index
Domestic versus foreign brand | Dummy, equaling 1 if a brand's headquarter is located in the focal country; 0 if not.
Western versus Asian brand | Dummy variable, equaling 1 if brand is headquartered in North America or Europe (0 for Asia).
Brand equity               | Sales-based brand equity, obtained as a transformation of the brand-specific intercept from the market share attraction model, standardized by category    | Datta, Ailawadi, and van Heerde (2017)

*Note:* All continuous variables are logged and mean-centered before model estimation (except brand equity, which is only mean-centered as this variable can take on negative values).

# Analysis

```{r continue_with_selection, echo=FALSE}
elast_all=data.table(elast)
elast=elast[globalbrand==T]
```

On sample of global brands (`r length(unique(elast$brand))` unique brands), active in at least three countries (to be revisited once country-of-origin coding is complete)


```{r randomcombined1, echo = FALSE, results='asis'}
m1 = ~1+ (1|brand) + (1|category) + (1|country) + necessity + ln_market_growth_mc + ln_herf_mc + local_to_market + western_brand + sbbe_std_mc

#interact1 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc +
#  local_to_market*ln_gdppercap2010_mc + western_brand*ln_gdppercap2010_mc +
#  ln_herf_mc*ln_gdppercap2010_mc + ln_ncat_in_country_mc*ln_gdppercap2010_mc + ln_ncountry_in_category_mc*ln_gdppercap2010_mc

#m2=update(m1, interact1)
names(ordered_vars) <- paste0(unlist(sanitize_table(data.frame(ordered_vars))), ' elasticity')

out1=regmodel(formula=m1, dat=elast, model='lmer')
covlabels=unlist(sanitize_table(data.frame(colnames(out1[[1]]$lt[[1]]@pp$X))))
covlabels=c(covlabels[-which(covlabels=='(Intercept)')], 'Constant')

#r2s = sem.model.fits(lapply(out1, function(x) x$lt[[1]]))


notes_base = "Regression of long-term elasticities on explanatory variables and three random effects, for brands, categories, and countries, respectively. Estimated using a linear mixed-effects model, with weights equal to the inverse of the elasticities' standard error, normalized to sum up to 1. Two-sided significance levels reported."

cat("<P style='page-break-before: always'>")
printout(out1, 'lt', omit=NULL, title = tab('DV: long-term elasticities, pooled sample of developed and emerging countries'), vars=ordered_vars,notes=notes_base, covlabels=covlabels)

cat("<P style='page-break-before: always'>")
out2=regmodel(formula=m1, dat=elast[developed==1], model='lmer')
printout(out2, 'lt', omit=NULL, title = tab('DV: long-term elasticities, sample of developed countries'), vars=ordered_vars, notes=paste0(notes_base, ' Model estimated on sample of developed countries only.'), covlabels=covlabels)

cat("<P style='page-break-before: always'>")
out3=regmodel(formula=m1, dat=elast[developed==0], model='lmer')
printout(out3, 'lt', omit=NULL, title = tab('DV: long-term elasticities, sample of emerging countries'), vars=ordered_vars, notes=paste0(notes_base, ' Model estimated on sample of emerging countries only.'), covlabels=covlabels)

# interaction model
m2 = ~1+ (1|brand) + (1|category) + (1|country) + developed + necessity + I(necessity*developed) + ln_market_growth_mc + I(ln_market_growth_mc*developed) + ln_herf_mc + I(ln_herf_mc*developed) + local_to_market + I(local_to_market*developed) + western_brand + I(western_brand*developed) + sbbe_std_mc + I(sbbe_std_mc*developed)
cat("<P style='page-break-before: always'>")
out4=regmodel(formula=m2, dat=elast, model='lmer')

covlabels=unlist(sanitize_table(data.frame(colnames(out4[[1]]$lt[[1]]@pp$X))))
covlabels=c(covlabels[-which(covlabels=='(Intercept)')], 'Constant')

printout(out4, 'lt', omit=NULL, title = tab('DV: long-term elasticities, pooled sample of developed and emerging countries with interactions'), vars=ordered_vars, notes=paste0(notes_base), covlabels=covlabels)

```

```{r randomcombined4, echo = FALSE, results='asis'}

m1 = ~1+ (1|brand) + (1|category) + as.factor(country) + necessity + ln_market_growth_mc + ln_herf_mc + local_to_market + western_brand + sbbe_std_mc
#ln_ncat_in_country_mc + ln_ncountry_in_category_mc

cat("<P style='page-break-before: always'>")
out5=regmodel(formula=m1, dat=elast, model='lmer')
covlabels=unlist(sanitize_table(data.frame(colnames(out5[[1]]$lt[[1]]@pp$X))))
covlabels=c(covlabels[-which(covlabels=='(Intercept)')], 'Constant')
printout(out5, 'lt', omit=NULL, title = tab('DV: long-term elasticities, with country-fixed effects'),vars=ordered_vars, notes="Regression of long-term elasticities on country fixed-effects (baseline: Australia), explanatory variables and two random effects for brands and categories. Estimated using a linear mixed-effects model, with weights equal to the inverse of the elasticities' standard error, normalized to sum up to 1. Two-sided signifiance levels reported.", covlabels=covlabels)

```

```{r correltabinfra, echo=FALSE, results='asis'}

m1 = ~1+ (1|brand) + (1|category) + as.factor(country) + necessity + ln_market_growth_mc + ln_herf_mc + local_to_market + western_brand + sbbe_std_mc
out5=regmodel(formula=m1, dat=elast, model='lmer')

res=rbindlist(lapply(seq(along=out5), function(x) {
 varname=names(out5)[x]
 coefs=data.frame(coef(summary(out5[[x]]$lt[[1]])))
 coefs$country=gsub('as.factor[(]country[)]', '', rownames(coefs))
 coefs=data.table(coefs)[country%in%unique(elast$country)]
 coefs=rbindlist(list(coefs, data.table(0,0,0,'australia')))
 setnames(coefs, c('fe','se','t','country'))
 return(coefs[, ':=' (se=NULL,t=NULL, varname=varname)])
}))

fixedeffects=dcast(res,country~varname, value.var='fe')

tmp <- merge(fixedeffects, gci, by = c('country'))
tmp[, ':=' (airseatkm=NULL, country=NULL)]

setcolorder(tmp, c(ordered_vars, 'overall_infra', 'roadqual','railroadqual','portqual','airqual','electricityqual','fixedphone','mobilephone'))

out=corstars(as.matrix(tmp))

out=data.frame(corstars(as.matrix(tmp)))
out=out[-c(1:4),c(1:4)]

tmp=sanitize_table(out)
colnames(tmp)[1:4]<-paste0(colnames(tmp)[1:4], c(' fixed-effect'))

cat("<P style='page-break-before: always'>")

kable(tmp, caption = tab('Correlations of infrastructure pillars with marketing-mix elasticities'),
      format='html', initial.zero = FALSE) %>%
        kable_styling() %>% footnote(general=paste0('Note: Table reports, for each marketing mix instrument, the correlations between the infrastructure pillar of the Global Competititveness Report (2010/2011 data, see https://www.weforum.org/reports/global-competitiveness-report-2010-2011), and the country-fixed effects reported in Table ', tableno-1, '. Significance levels: *p<.1, **p<.05, ***p<.01, ****p<.001.'))

```

# Appendix

```{r reset, echo=FALSE,results='asis'}
tableno<<-0
figureno<<-0
cat("<P style='page-break-before: always'>")
  
```

```{r sample_overview, echo=FALSE, results='asis'}

tmp=elast[, list(active_in_countries=length(unique(country)), active_in_categories=length(unique(category)), headquarter_location=unique(global_country), headquarter_region=unique(country_of_origin)), by = c('brand')]
setorderv(tmp, c('active_in_countries','active_in_categories'),order=-1L)

tmp[, ':=' (brand=stri_trans_totitle(brand), headquarter_location=stri_trans_totitle(headquarter_location), headquarter_region=stri_trans_totitle(headquarter_region))]
tmp=sanitize_table(tmp)


kable(tmp, caption = tab('Overview of selected brands, ordered by the number of countries and categories it is active in', prefix ='A'))
```

```{r elast_by_category, echo=F,results='asis'}
  tmp=elast[!is.na(elastlt), list(elast = sum(elastlt/elastlt_se)/sum(1/elastlt_se)), by=c('variable', 'category')]

  tmp=dcast(tmp,category~variable,value.var='elast')
  setcolorder(tmp, c('category', ordered_vars))
  
  tmp=sanitize_table(tmp)
  setorder(tmp, Category)
  cat("<P style='page-break-before: always'>")
  kable(tmp, digits=3, caption = tab('Long-term elasticities (by category)', prefix='A'), format='html', initial.zero = FALSE) %>%
        kable_styling() %>% footnote(general=paste0('Note: Table reports weighted long-term elasticities (weights equal to inverse standard errors, normalized to sum up to 1). Categories ordered alphabetically.'))
  
```	

```{r elast_by_country, echo=F,results='asis'}
  tmp=elast[!is.na(elastlt), list(elast = sum(elastlt/elastlt_se)/sum(1/elastlt_se)), by=c('variable', 'country')]

  tmp=dcast(tmp,country~variable,value.var='elast')
  setcolorder(tmp, c('country', ordered_vars))
  
  tmp=sanitize_table(tmp)
  setorder(tmp, Country)
  cat("<P style='page-break-before: always'>")
  kable(tmp, digits=3, caption = tab('Long-term elasticities (by country)', prefix='A'), format='html', initial.zero = FALSE) %>%
        kable_styling() %>% footnote(general=paste0('Note: Table reports weighted long-term elasticities (weights equal to inverse standard errors, normalized to sum up to 1). Countries ordered alphabetically.'))
  
```	

```{r rq4_growth, echo=FALSE,results='asis'}
tmp=unique(elast, by = c('market_id')) # t-tests on growth rates

t_tests <- lapply(unique(elast$category), function(var) {
    tmpdat = tmp[category == var]
    teststat=t.test(tmpdat[country_class=='hinc']$market_growth, tmpdat[country_class=='linc']$market_growth)
    
    tabl = data.frame(category=var, mean1=teststat$estimate[1], mean2=teststat$estimate[2], t=teststat$statistic, p=teststat$p.value)
                
    return(list(summary=tabl))
})

out=rbindlist(lapply(t_tests, function(x) x$summary))

percent <- function(x, digits = 1, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}

out[, ':=' (mean1=percent(mean1-1), mean2=percent(mean2-1))]
out[, category:=as.character(category)]
out=sanitize_table(out)
setorder(out, Category)
setnames(out, 'mean1', 'developed countries')
setnames(out, 'mean2', 'emerging countries')
cat("<P style='page-break-before: always'>")
kable(out, format='html',caption = tab('Average category growth rates for developed and emerging countries',prefix='A'),digits=3) %>% kable_styling() %>% footnote(general=paste0('Note: Table reports average category growth rates, and the results of a t-test of statistical significance of the difference in growth rates between developed and emerging countries. Categories are ordered alphabetically.'))
  
```

```{r VIFS, echo=FALSE,results='asis'}
m1 = ~1+ necessity + ln_market_growth_mc + ln_herf_mc + local_to_market + western_brand + sbbe_std_mc

interact1 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc +
  local_to_market*ln_gdppercap2010_mc + western_brand*ln_gdppercap2010_mc

m2=update(m1, interact1)

m<-lm(update(elast~., m1), data=elast[variable=='llen'])
m2<-lm(update(elast~., m2), data=elast[variable=='llen'])

frame1=data.frame(vif(m))
colnames(frame1) <- c('VIF')
frame1$variable=rownames(frame1)
rownames(frame1)<-NULL
frame1=frame1[, c('variable','VIF')]
frame1=sanitize_table(frame1)
cat("<P style='page-break-before: always'>")
kable(frame1,format='html', caption = tab('VIFs in a model without interactions', prefix='A'))%>% kable_styling() %>% footnote(general=paste0('Note: VIFs calculated in regression models using the variables listed above (i.e., excluding brand, category, and country effects).'))

frame2=data.frame(vif(m2))
colnames(frame2) <- c('VIF')
frame2$variable=rownames(frame2)
rownames(frame2)<-NULL
frame2=frame2[, c('variable','VIF')]
frame2=sanitize_table(frame2)

kable(frame2, format='html',caption = tab('VIFs in a model with interactions', prefix='A'))%>% kable_styling() %>% footnote(general=paste0('Note: VIFs calculated in regression models using the variables listed above (i.e., excluding brand, category, and country effects).'))


```

```{r shorterm, echo=F,results='asis'}

cat("<P style='page-break-before: always'>")
zval=qnorm(1-.1/2) # 10%-level
  
	tmp=elast[!is.na(elast), list(median_elast = median(elast), 
												  w_elast = sum(elast/elast_se)/sum(1/elast_se), 
												  N_brands= .N, 
												  perc_positive = length(which(elast/elast_se>=(zval)))/.N, 
												  perc_null = length(which(abs(elast/elast_se)<zval))/.N, 
												  perc_negative = length(which(elast/elast_se<=(-zval)))/.N), by=c('variable')]
	tmp=sanitize_table(tmp[match(ordered_vars, variable)])
	kable(tmp, format='html',digits=3, caption = tab('Short-term elasticities by variable', prefix='A')) %>% kable_styling() %>% footnote(general=paste0('Note: Table reports short-term elasticities. Weights, if used, are equal to inverse standard errors of estimated elasticities. Significance tested at p<.1.'))
```	

```{r elast_lt, echo = FALSE, results='asis'}
  
  zval=qnorm(1-.1/2) # 10%-level
 
  tmp=elast[!is.na(elastlt), list(median_elast = median(elastlt), 
												  w_elast = sum(elastlt/elastlt_se)/sum(1/elastlt_se), 
												  N_brands= .N, 
												  perc_positive = length(which(elastlt/elastlt_se>=(zval)))/.N, 
												  perc_null = length(which(abs(elastlt/elastlt_se)<zval))/.N, 
												  perc_negative = length(which(elastlt/elastlt_se<=(-zval)))/.N), by=c('variable')]
	tmp=sanitize_table(tmp[match(ordered_vars, variable)])
	
	kable(tmp, format='html',digits=3, caption = tab('Long-term elasticities by variable', prefix='A')) %>% kable_styling() %>% footnote(general=paste0('Note: Table reports long-term elasticities. Weights, if used, are equal to inverse standard errors of estimated elasticities. Significance tested at p<.1.'))

```

# Estimation details

## Market share attraction model

Elasticities estimated using a market share attraction model (MCI), with

* four marketing mix instruments:
     + llen = line length (number of SKUs)
     + wpswdst = distribution (weighted using past sales in previous three periods)
     + price = rwpspr (deflated using a country's CPI, weighted using past sales in previous three periods)
     + novelty = nov6sh (number of SKUs introduced in past six periods, expressed as a share of total SKUs sold in a given period)
  
* endogeneity controls using Gaussian Copulas (tested at p<.1; removed if n.s.)
* lagged market share to model dynamics
* brand-specific trend
* brand-specific quarterly dummies

Elasticities and corresponding standard errors calculated using the Delta rule.

## Estimation data set

- Number of markets: `r length(unique(elast_all$market_id))`.
- Number of brands: `r nrow(elast_all[, .N, by = c('market_id', 'brand')])`.
- Number of unique brands: `r nrow(elast_all[, .N, by = c('brand')])`.
- Included countries (`r length(unique(elast_all$country))`): `r paste0(unique(elast_all$country),collapse = ', ')`.
- Included categories (`r length(unique(elast_all$category))`): `r paste0(unique(elast_all$category),collapse = ', ')`.

```{r overview2, echo=FALSE, results='asis'}
tmp = elast_all[, list(Nbrands = length(unique(brand))), by = c('market_id', 'category','country')]

tabl = dcast(tmp, category~country, value.var=c('Nbrands'))
#print(xtable(tabl, caption = tab('Overview of categories and countries (with number of brands indicated for each market), in estimation data')), scalebox='0.6',type='html',caption.placement='top')
tabl=sanitize_table(tabl)
setorder(tabl, Category)
kable(tabl, caption = tab('Overview of categories and countries (with number of brands indicated for each market), in estimation data', prefix='A'))

```


