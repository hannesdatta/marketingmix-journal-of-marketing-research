---
title: "GfK Singapore - Results"
output:
  html_document: default
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(stargazer)
library(knitr)
require(xtable)
library(lme4)
library(car)
library(kableExtra)
library(stringi)
library(ggplot2)


options(xtable.comment = FALSE)

# Load data
  #elast <- fread('../externals/elast_results_MCI_wlag_wotrend.csv')
  elast <- fread('../externals/elast_results_MCI_wolag_trend.csv')

# Load auxilary functions
  source('proc_auxilary.R')

# load extra variables
  hdi <- fread('../temp/hdi.csv')
# change taiwan (reported value from China is not reliable)
  hdi[, hdi2010:=ifelse(country=='taiwan', mean(hdi2010[country%in%c('thailand', 'china')]), hdi2010)]
# Load GDP
  gdp <- fread('../temp/gdp.csv')
# Merge
  setkey(hdi, country)
  setkey(elast, country)
  elast[hdi, hdi2010:=i.hdi2010]
  setkey(gdp, country)
  elast[gdp, gdppercap2010:=i.gdppercap2010]

  elast[, country_of_origin_recode := ifelse(country_of_origin%in%c('local','asian_other'), 'asian', country_of_origin)]
  
  # elast asian devel vs. not
  elast[, region_of_origin:=country_of_origin_recode]
  elast[region_of_origin=='asian'& country_class=='hinc', region_of_origin := 'asian-high']
  elast[region_of_origin=='asian'& country_class=='linc', region_of_origin := 'asian-low']
  
  elast[, appliance:=necessity]
  
  
  elast[, developed:=0]
  elast[country%in%c('australia', 'singapore', 'japan', 'new zealand', 'hong kong', 'south korea'), developed := 1]


# take natural log of variables
vars=c('herf','c3','c5','market_growth','hdi2010','gdppercap2010', 'ncat_in_country', 'ncountry_in_category')

for (var in vars) {
  elast[, (paste0('ln_', var)):=log(get(var))]
  
}

# grand-mean centering by variable (llen, etc.) for all explanatory (continuous) variables
for (var in unique(drop(unlist(lapply(vars, grep, colnames(elast), value=T))))) {
  elast[, (paste0(var, '_mc')):=get(var)-mean(get(var)), by = c('variable')]
  }
  
# focal dummies: local_to_market, western (versus asian)

#
elast[, worldbank := '']
elast[country%in%c('india','indonesia', 'vietnam', 'philippines'), worldbank:='lowermid']
elast[country%in%c('china', 'malaysia','thailand'), worldbank:='uppermid']
elast[worldbank=='', worldbank:='high']

options(knitr.kable.NA = '')

### brand selection for analysis
#elast=elast[globalbrand==T] # global brands (active in >=3 countries) only

#elast=elast[ncountries>=2]

source('proc_rename.R')

```

Note: relabeling (e.g., variable names), and capitalization (e.g,. Australia instead of australia) still pending.


```{r devel, echo = FALSE}
tmp=unique(elast, by='country')[, c('country','gdppercap2010','hdi2010'),with=F]
setorderv(tmp, c('gdppercap2010'), order=-1L)

kable(tmp, format='html', caption=tab('Development indicators for countries in sample')) %>%
        kable_styling() %>% footnote(general='Countries ranked by GDP per capita.', alphabet=c("GDP per capita in current USD, 2010 data. Provided by World Bank (NY.GDP.PCAP.CD) for all countries except Taiwan. Data for Taiwan obtained from Datastream (WGDPPEAA~USD).", "Human Development Index (HDI), 2010 data. Taiwan's HDI has been imputed as the mean HDI of Thailand and China.")) %>%
  group_rows("Developed economies", 1, 6) %>%
  group_rows("Emerging economies", 7, 14)

```

```{r table2_category_overview, echo = FALSE}
tmp=data.table(elast)
tmp[, ncountries:=length(unique(country)),by=c('category')]

tmp=tmp[, list(overall_ms=mean(overall_ms), ncountries=mean(ncountries)), by = c('category', 'appliance', 'brand')]

setorderv(tmp, c('category', 'appliance', 'overall_ms'), order=-1L)
tmp[!brand%in%c('unbranded','local'), rank:=1:.N, by = c('category')]
tmp[, brand_include:= rank%in%1:5]

sort_alpha <- function(x) return(x[order(x)])

tmp=tmp[brand_include==T, list(cattype=ifelse(unique(appliance)==1, 'Appliance', 'Electronics'), ncountries=unique(ncountries), exemplary_brand_names=paste0(sort_alpha(stri_trans_totitle(unique(brand))), collapse=', ')), by='category']
setorder(tmp, category)

kable(tmp, format='html', caption=tab('Category overview')) %>%
        kable_styling() %>% footnote(general='Categories shown in alphabetical order. Exemplary brand names are given for the top 5 brands in terms of average market share across countries.')

```

```{r table3_varoperation, echo=F}

tmp = data.table(variable=c('line length', 'etc.'))
kable(tmp, caption=tab('Variable operationalization for market share attraction model'))

```

*(still to be completed!)*

```{r elast_ov, echo = FALSE, results='asis'}
  .vars=c('llen','wpswdst','rwpspr','nov6sh')
	
  zval=qnorm(.95) # zval for .1-level of significance

  
  tmp=elast[!is.na(elastlt), list(welast = sum(elastlt/elastlt_se)/sum(1/elastlt_se), 
												  Neffects= .N, 
												  perccorrectsign = length(which(elastlt/elastlt_se>=ifelse(variable=='rwpspr', -1, 1)*zval))/.N,
												  welast_emerging = sum(elastlt[developed==0]/elastlt_se[developed==0])/sum(1/elastlt_se[developed==0]),
												   welast_developed = sum(elastlt[developed==1]/elastlt_se[developed==1])/sum(1/elastlt_se[developed==1])), by=c('variable')]
  
	kable(tmp[match(.vars, variable)], digits=3, caption = tab('Long-term elasticities by variable, significance tested at p<.1 (|z| >= 1.64)'))

```

```{r elast_hist, echo=F}

elast[, obs_rank:=rank(elastlt), by = c('variable', 'developed')]
setorder(elast,variable, developed, obs_rank)
elast[, ptile := obs_rank/max(obs_rank), by = c('variable', 'developed')]
elast[, group:=cut(ptile, breaks=c(0,.25, .5, .75,1), labels=c('Q1', 'Q2', 'Q3', 'Q4'))]

tmp=elast[, list(qmeans=mean(elastlt)),by=c('variable', 'developed','group')]

for (.var in unique(elast$variable)){
p<-ggplot(tmp[variable==.var], aes(x=group, y=qmeans, fill=ifelse(developed==1, 'developed', 'emerging'))) + theme_bw() + geom_bar(position=position_dodge(), stat="identity") +ggtitle(fig('.var')) +scale_fill_grey() + labs(title = fig(paste0("Mean long-term ", rename.fkt(.var), " elasticities per quartile")))+guides(fill=guide_legend("Development status")) +xlab("Quartiles") + 
           ylab("Elasticity")
print(p)
}

```

`r tab("Variable operationalization")`

Variable name             | Construct                  | Operationalization                                          | References
------------------------- | ------------------- | ---------------------------------------------|----------
necessity                 | Appliance (vs. electronics)| Dummy, equaling 1 for appliances (washing machines, microwaves and refridgerators), 0 if not.
ln_market_growth          | Category growth rate       | Log of a market's average growth rate in the observation period (geometric average)
ln_herf                   | Category concentration     | Log of Herfindahl index
local_to_market           | Local versus foreign brand | Dummy, equaling 1 if brand is local to a market, or not (0 = foreign)
western_brand             | Western versus Asian brand | Dummy variable, equaling 1 if brand is headquartered in North America or Europe (0 for Asia).
sbbe                      | Brand equity               | Sales-based brand equity, obtained from intercept from market share attraction model    | Datta, Ailawadi, and van Heerde (2017)

All continuous variables are mean-centered before model estimation.

# Analysis

```{r continue_with_selection, echo=FALSE}
elast=elast[globalbrand==T]
```

On sample of "global" brands (`r length(unique(elast$brand))` unique brands), active in at least three countries (to be revisited once country-of-origin coding is complete)


```{r randomcombined1, echo = FALSE, results='asis'}
m1 = ~1+ (1|brand) + (1|category) + (1|country) + necessity + ln_market_growth_mc + ln_herf_mc + local_to_market + western_brand + sbbe_std

#interact1 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc +
#  local_to_market*ln_gdppercap2010_mc + western_brand*ln_gdppercap2010_mc +
#  ln_herf_mc*ln_gdppercap2010_mc + ln_ncat_in_country_mc*ln_gdppercap2010_mc + ln_ncountry_in_category_mc*ln_gdppercap2010_mc

#m2=update(m1, interact1)

out1=regmodel(formula=m1, dat=elast, model='lmer')
notes_base = "Regression of long-term elasticities on explanatory variables and three random effects for brands, categories, and countries. Weights are equal to the inverse of the elasticities' standard error."

cat("<P style='page-break-before: always'>")
printout(out1, 'lt', omit=NULL, title = tab('DV: long-term elasticities, pooled sample of developed and emerging countries'), vars=NULL,notes=notes_base)

cat("<P style='page-break-before: always'>")
out2=regmodel(formula=m1, dat=elast[developed==1], model='lmer')
printout(out2, 'lt', omit=NULL, title = tab('DV: long-term elasticities, sample of developed countries'), vars=NULL, notes=paste0(notes_base, ' Model estimated on sample of developed countries only.'))

cat("<P style='page-break-before: always'>")
out3=regmodel(formula=m1, dat=elast[developed==0], model='lmer')
printout(out3, 'lt', omit=NULL, title = tab('DV: long-term elasticities, sample of emerging countries'), vars=NULL, notes=paste0(notes_base, ' Model estimated on sample of emerging countries only.'))

# interaction model
m2 = ~1+ (1|brand) + (1|category) + (1|country) + necessity*developed + ln_market_growth_mc*developed + ln_herf_mc*developed + local_to_market*developed + western_brand*developed + sbbe_std*developed
cat("<P style='page-break-before: always'>")
out4=regmodel(formula=m2, dat=elast, model='lmer')
printout(out4, 'lt', omit=NULL, title = tab('DV: long-term elasticities, pooled sample of developed and emerging countries with interactions'), vars=NULL, notes=paste0(notes_base))

```

Drop random effects for countries, replace by dummy variables.

```{r randomcombined4, echo = FALSE, results='asis'}

m1 = ~1+ (1|brand) + (1|category) + as.factor(country) + necessity + ln_market_growth_mc + ln_herf_mc + local_to_market + western_brand + sbbe_std
#ln_ncat_in_country_mc + ln_ncountry_in_category_mc

cat("<P style='page-break-before: always'>")
out5=regmodel(formula=m1, dat=elast, model='lmer')
printout(out5, 'lt', omit=NULL, title = tab('DV: long-term elasticities, with country-fixed effects'), vars=NULL, notes="Regression of long-term elasticities on explanatory variables, fixed effects for countries, and two random effects for categories and countries. Weights are equal to the inverse of the elasticities' standard error.")

```

# Appendix (legacy tables)

## VIFs

estimating an auxilary regression (elast for llen on variables, without brand/category/country effects), then computing VIFs.

```{r VIFS, echo=FALSE}
m1 = ~1+ln_gdppercap2010_mc + necessity + ln_market_growth_mc + ln_herf_mc + local_to_market + western_brand + ln_ncat_in_country_mc + ln_ncountry_in_category_mc

interact1 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc +
  local_to_market*ln_gdppercap2010_mc + western_brand*ln_gdppercap2010_mc

m2=update(m1, interact1)

m<-lm(update(elast~., m1), data=elast[variable=='llen'])
m2<-lm(update(elast~., m2), data=elast[variable=='llen'])

kable(data.frame(vif(m)), caption = tab('VIFs in a model without interactions'))
kable(data.frame(vif(m2)), caption = tab('VIFs in a model with interactions'))


```

# Elasticities

## Short-term
```{r shorterm, echo=F}
  .vars=c('llen','wpswdst','rwpspr','nov6sh')
	
  zval=qnorm(.95)
  
	tmp=elast[!is.na(elast), list(median_elast = median(elast), 
												  w_elast = sum(elast/elast_se)/sum(1/elast_se), 
												  N_brands= .N, 
												  perc_positive = length(which(elast/elast_se>=(zval)))/.N, 
												  perc_null = length(which(abs(elast/elast_se)<zval))/.N, 
												  perc_negative = length(which(elast/elast_se<=(-zval)))/.N), by=c('variable')]
	kable(tmp[match(.vars, variable)], digits=3, caption = tab('Short-term elasticities by variable, significance tested at p<.1 (|z| >= 1.64)'))
```	

## Long-term
```{r elast_lt, echo = FALSE, results='asis'}
  .vars=c('llen','wpswdst','rwpspr','nov6sh')
	
  zval=qnorm(.95) # zval for .1-level of significance

  tmp=elast[!is.na(elastlt), list(median_elast = median(elastlt), 
												  w_elast = sum(elastlt/elastlt_se)/sum(1/elastlt_se), 
												  N_brands= .N, 
												  perc_positive = length(which(elastlt/elastlt_se>=(zval)))/.N, 
												  perc_null = length(which(abs(elastlt/elastlt_se)<zval))/.N, 
												  perc_negative = length(which(elastlt/elastlt_se<=(-zval)))/.N), by=c('variable')]
	kable(tmp[match(.vars, variable)], digits=3, caption = tab('Long-term elasticities by variable, significance tested at p<.1 (|z| >= 1.64)'))

```


Elasticities estimated using a market share attraction model (MCI), with

* four marketing mix instruments:
     + llen = line length (number of SKUs)
     + wpswdst = distribution (weighted using past sales in previous three periods)
     + price = rwpspr (deflated using a country's CPI, weighted using past sales in previous three periods)
     + novelty = nov6sh (number of SKUs introduced in past six periods, expressed as a share of total SKUs sold in a given period)
  
* endogeneity controls using Gaussian Copulas (tested at p<.1; removed if n.s.)
* lagged market share to model dynamics
* brand-specific trend
* brand-specific quarterly dummies


Elasticities and corresponding standard errors calculated using the Delta rule.


# Estimation data set

- Number of markets: `r length(unique(elast$market_id))`.
- Number of brands: `r nrow(elast[, .N, by = c('market_id', 'brand')])`.
- Number of unique brands: `r nrow(elast[, .N, by = c('brand')])`.
- Included countries (`r length(unique(elast$country))`): `r paste0(unique(elast$country),collapse = ', ')`.
- Included categories (`r length(unique(elast$category))`): `r paste0(unique(elast$category),collapse = ', ')`.



```{r overview2, echo=FALSE, results='asis'}
tmp = elast[, list(Nbrands = length(unique(brand))), by = c('market_id', 'category','country')]

tabl = dcast(tmp, category~country, value.var=c('Nbrands'))
#print(xtable(tabl, caption = tab('Overview of categories and countries (with number of brands indicated for each market), in estimation data')), scalebox='0.6',type='html',caption.placement='top')

kable(tabl, caption = tab('Overview of categories and countries (with number of brands indicated for each market), in estimation data'))

```


## category lifecycles

```{r rq4_growth, echo=FALSE}
tmp=unique(elast, by = c('market_id')) # t-tests on growth rates

t_tests <- lapply(unique(elast$category), function(var) {
    tmpdat = tmp[category == var]
    teststat=t.test(tmpdat[country_class=='hinc']$market_growth, tmpdat[country_class=='linc']$market_growth)
    
    tabl = data.frame(category=var, mean1=teststat$estimate[1], mean2=teststat$estimate[2], t=teststat$statistic, p=teststat$p.value)
                
    return(list(summary=tabl))
})

out=rbindlist(lapply(t_tests, function(x) x$summary))

setnames(out, 'mean1', 'high-income')
setnames(out, 'mean2', 'low-income')
out[, category:=as.character(category)]
setorder(out, category)

kable(out, caption = tab('Average category growth rates for high-income and low-income countries, and t-test for significance'),digits=3)

```

```{r sample_overview, echo=FALSE, results='asis'}

tmp=elast[, list(active_in_countries=length(unique(country)), active_in_categories=length(unique(category)), headquarter_location=unique(global_country), headquarter_region=unique(country_of_origin_recode)), by = c('brand')]
setorderv(tmp, c('active_in_countries','active_in_categories'),order=-1L)
kable(tmp, caption = tab('Overview of selected brands, ordered by the number of countries and categories it is active in'))
```
