---
title: "GfK Singapore - Results"
output:
  html_document: default
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

libs_to_load <- c('data.table', 'stargazer', 'knitr', 'xtable', 'car', 'kableExtra', 'stringi', 'ggplot2', 'ggpubr', 'plyr', 'gridExtra', 'grid', 'lme4', 'sjstats', 'ggthemes') #'blme' 

for (lib in libs_to_load) eval(parse(text=paste('library(', lib, ')')))

options(xtable.comment = FALSE)
options(knitr.kable.NA = '')

# Load data
  brand_panel=fread('../../analysis/temp/preclean_main.csv')
  brand_panel[, ':=' (date = as.Date(date))]
  
# Load auxilary functions
  source('proc_auxilary.R')
  source('proc_rename.R')

  load('app/app_workspace.RData')
  
  elast <- elasticities$ec_main_sur #fread('../externals/elast_results_with_sur.csv') 
  #elast=elast[!grepl('allothers', brand,ignore.case=T)] #|super|amazon
  elast[, list(.N),by=c('category','country','brand')]
    
  # set order of variables to appear in figures and tables
  ordered_vars =  c('lnllen', 'lnrwpspr', 'lnwpswdst')
  ordered_vars = ordered_vars[which(ordered_vars%in%elast$variable)]
  
  names(ordered_vars) <- paste0(unlist(sanitize_table(data.frame(gsub('^ln', '', ordered_vars)))), ' elasticity')
  
  lmerctrl = lmerControl(optimizer ="Nelder_Mead", check.conv.singular="ignore")


winsor_p=.01

notes_sig = 'Significance levels: \\* *p*<.1, \\*\\* *p*<.05, \\*\\*\\* *p*<.01 (two-sided).'
  
for (dframe in grep('^elast$', ls(),value=T)) {
  print(dframe)
  for (.var in c('elast', 'elastlt')) {
    eval(parse(text=paste0(dframe,"[!is.na(get(.var)), paste0('w_', .var) := 1/get(paste0(.var, '_se'))]")))
    # rescale
    eval(parse(text=paste0(dframe,"[!is.na(get(.var)), paste0('w_', .var) := get(paste0('w_', .var))/max(get(paste0('w_', .var)))]")))
    eval(parse(text=paste0(dframe,"[!is.na(get(.var)), paste0('z_', .var) := get(.var)/get(paste0(.var, '_se'))]")))
  }
}  

estimnote = paste0('Elasticities are weighted by inverse standard errors.')
estimnoteshort= 'weighted by inverse standard errors'


notes_base = paste0("^1^ Regression of long-term elasticities on explanatory variables and three random effects, for brands, categories, and countries, respectively. Estimated using a linear mixed-effects model. ", estimnote, " Continuous variables have been mean-centred. Standard errors in parentheses.")

notes_loglik = 'Log-likelihood ratio tests computed relative to preceding models.'

# order of covariates in models
covars = c("(Intercept)", 
           "emerging", "gdppercap_rev","gci_rev","hdi_rev",
           "sbbe_std_mc",
           "I(sbbe_std_mc * emerging)",
           "I(sbbe_std_mc * gdppercap_rev)",
           "I(sbbe_std_mc * gci_rev)",
           "I(sbbe_std_mc * hdi_rev)",
           "ln_herf_mc", "ln_market_growth_mc", "appliance", "ln_gini_mc", "local_to_market", "international", "mean_ms_mc")

sigvalue = .1
zval = qnorm(1-sigvalue/2)

```

# Data

```{r table1_countries, echo = FALSE}
tmp=unique(elast, by='country')[, c('country','gdppercapitacurrent2010','gdpgrowth2010', 'ginicoef','survself', 'tradrat'),with=F]

setorderv(tmp, c('country'))

tmp=sanitize_table(tmp)

kable(tmp, format='html', digits=c(0,0,2,2,2,2), format.args = list(big.mark = ",", format ='f'), initial.zero = FALSE, caption=tab('Development indicators for countries in sample^1^')) %>%
        kable_styling() %>% footnote(number=c('Countries shown in alphabethical order. Sources to be updated.'))
```

<P style='page-break-before: always'>

```{r table2_category_overview, echo = FALSE}
tmp=data.table(elast)
tmp[, ncountries:=length(unique(country)),by=c('category')]

tmp=tmp[!grepl('allothers|unbranded', brand,ignore.case=T), list(brand_ms=mean(brand_ms), ncountries=mean(ncountries)), by = c('category', 'appliance', 'brand')]

setorderv(tmp, c('category', 'appliance', 'brand_ms'), order=-1L)
tmp[!brand%in%c('unbranded','local'), rank:=1:.N, by = c('category')]
tmp[, brand_include:= rank%in%1:5]

tmp=tmp[, list(cattype=ifelse(unique(appliance)==1, 'Appliances', 'Electronics'), ncountries=unique(ncountries), nbrandsdat=length(unique(brand)), exemplary_brand_names=paste0(my_capitalize(unique(brand[brand_include==T])), collapse=', ')), by='category']
tmp=sanitize_table(tmp)
setnames(tmp, 'Top 5 brands', 'Top 5 brands^2^')

try(setorder(tmp, Category),silent=T)

kable(tmp, format='html', caption=tab('Category overview^1^')) %>%
        kable_styling() %>% footnote(number=c('Categories shown in alphabetical order.', 'Top 5 brands are determined on the basis of their average volume share across countries, and are listed in decreasing order of their market share.'))

```

<P style='page-break-before: always'>
# Results

```{r continue_with_selection, echo=FALSE}
elast_all=data.table(elast)
elast=elast[!is.na(country_of_origin)&!country_of_origin==''&!tolower(brand)%in%c('unbranded')]
#elast[,list(.N),by=c('category','country','brand')]

excluded_brands=setdiff(unique(elast_all$brand), unique(elast$brand))
excluded_brands<-unique(gsub('Allothers.*', 'Composite brands (allothers)', excluded_brands))


```

Reported for a sample of `r length(unique(elast$brand))` unique brands (excluding `r paste0(my_capitalize(excluded_brands), collapse=', ')`).


```{r elasts_full, echo=F,results='asis'}

out = lapply(list(st=c('elast', 'z_elast', 'w_elast'), lt = c('elastlt','z_elastlt','w_elastlt')), function(obj) {
  tmp = elast[!is.na(get(obj[1]))][, ':=' (val=get(obj[1]), val_z=get(obj[2]), val_w=get(obj[3]))]
  tmp=tmp[, list(Neffects=.N, 
   						  ftmelast = sum(val*val_w)/sum(val_w),
   						  median_elast = median(val), 
  						  interval90 = paste0('[',paste(sprintf("%.3f",quantile(val, c(.05,.95))),collapse=', '),']')),
  												#  perc_positive = length(which(val_z>=(zval)))/.N, 
  												#  perc_null = length(which(abs(val_z)<zval))/.N, 
  												#  perc_negative = length(which(val_z<=(-zval)))/.N), 
  												by=c('variable')]
  tmp=tmp[match(ordered_vars, variable)]
  setnames(tmp, 'variable', 'mmixinstr')
  return(tmp)
  })
  
iters = list(lt=c('lt', 'Long-term')) #st=c('st', 'Short-term'), 
for (iter in iters) {

  print(kable(sanitize_table(out[[iter[1]]]), digits=3, format='html', format.args = list(big.mark = ","),
        caption=tab(paste0(iter[2], ' elasticities by marketing-mix instrument^1^'),prefix='')) %>% kable_styling() %>% 
        footnote(number=c(paste0('Table reports ', tolower(iter[2]), ' elasticities. The number of observations differs slightly across marketing-mix instruments because some brands in some markets (category/country combinations) do not have variation in these variables.'), estimnote)))
  #cat("<P style='page-break-before: always'>")

  }

```




```{r elast_by_cc, echo=F,results='asis', include=TRUE}

qval=qnorm(1-sigvalue/2)

for (byvar in c('country')) {
  tmp=elast[!is.na(elastlt), list(N=.N,
                                  elast = sum(elastlt*w_elastlt)/sum(w_elastlt),
                                  sig = signstars(sum(elastlt/elastlt_se,na.rm=T)/sqrt(.N)),
                                  percpos = round(100*length(which(abs(elastlt/elast_se)>=qval&elastlt>0))/.N,0),
                                  percneg = round(100*length(which(abs(elastlt/elast_se)>=qval&elastlt<0))/.N,0),
                                  percns = round(100*length(which(abs(elastlt/elast_se)<qval))/.N,0)),
                                  by=c('variable', byvar)]
  tmp[, lbl := paste0(sprintf("%.3f",elast), ' ', sig)]
  				
  tmp2 = melt(tmp, id.vars=c('variable','country'))
  setnames(tmp2, 'variable.1', 'par')
  keeppars=c('N', 'lbl','percpos','percneg','percns')
  tmp2 <- tmp2[par%in%keeppars]
  tmp2[, par:=factor(as.character(par),levels=keeppars)]
  tmp2[, variable:=factor(as.character(variable, levels=ordered))]
  
  
  setnames(tmp2, byvar, 'byvar')
  
  tmp=dcast(tmp2,byvar~variable+par)
  
  
  setnames(tmp, 'byvar', byvar)

  
  tmp=sanitize_table(tmp)
  #setorderv(tmp, colnames(tmp)[1])
  
  cat("<P style='page-break-before: always'>")
  {print(kable(tmp, digits=3, caption = tab(paste0('Long-term elasticities (means by ', byvar, ')^1^'), prefix=''), format='html', initial.zero = FALSE) %>% add_header_above(list(' '=1, 'Line length' =5, 'Price'=5, 'Distribution' = 5)) %>% kable_styling() %>% footnote(number=paste0(estimnote, ' Reported by ', ifelse(byvar=='country', 'countries', 'categories'), ' in alphabetical order.'))) 
  }
}

```	


<P style='page-break-before: always'>


```{r reset, echo=FALSE,results='asis'}
tableno<<-0
figureno<<-0
cat("<P style='page-break-before: always'>")
  
```

# Appendix

```{r sample_origin, echo=FALSE, results='asis'}

cols =  c('country_of_origin')
tmp = elast[, list(.N), by = c('brand',cols)]
tmp = tmp[!grepl('alloth', brand)]
tmp = tmp[, list(nbrands=length(unique(brand)), all_brands=paste(my_capitalize(brand)[order(brand)], collapse=', ')), by = cols]
tmp[country_of_origin==''|is.na(country_of_origin), country_of_origin := 'Country not available']
tmp[, country_of_origin:=my_capitalize(country_of_origin)]

setorderv(tmp, 'nbrands', order=-1L)
setcolorder(tmp, c('country_of_origin', 'nbrands', 'all_brands'))

tmp=sanitize_table(tmp)

kable(tmp, caption = tab('Country-of-origins for brands in sample^1^', prefix ='A'),format='html') %>%
        kable_styling() %>% footnote(number=paste0('Countries are ordered by the number of brands from a given country; brand names are listed alphabetically.'))

```

<P style='page-break-before: always'>
```{r VIFS, echo=FALSE,results='asis', include=FALSE}
if(0){
m1 = ~1+ appliance + ln_market_growth_mc + ln_market_herf_mc + local_to_market  + ln_brand_prindex_mean_mc + brandz

m<-lm(update(elast~., m1), data=elast[variable=='llen'])

frame1=data.frame(vif(m))
colnames(frame1) <- c('VIF')
frame1$variable=rownames(frame1)
rownames(frame1)<-NULL
frame1=frame1[, c('variable','VIF')]
frame1=sanitize_table(frame1)
cat("<P style='page-break-before: always'>")

if(0){
kable(frame1,format='html', caption = tab('Assessing multicollinearity^1^', prefix='A'))%>% kable_styling() %>% footnote(number=paste0('Table reports VIFs values calculated in regression models using main effects for all variables listed above (i.e., excluding brand, category, and country effects).'))
}
}
```

# Robustness checks

```{r, results='asis', echo = FALSE}

r2s=predictions[, list(R2_diff = cor(dlnusales, dlnusales_hat, use='pairwise')^2,
                   R2_lev = cor(lnusales, lnusales_hat, use='pairwise')^2),
            by = c('type','category','country','brand', 'estim_set')]

tmp = r2s[, lapply(.SD, mean,na.rm=T), by = c('type','estim_set'), .SDcols=grep("R2",colnames(r2s),value=T)]
setnames(tmp, 'type','model')
tmp[, type:=ifelse(estim_set==T, 'within','holdout')]

ord=c('ec_main','ec_main_sur',
                                                  'ec_nommix', grep('ec_only',unique(tmp$model),value=T),
                                                  grep('unrestricted',unique(tmp$model),value=T),
                                                  grep('first|last',unique(tmp$model),value=T),
                                                  grep('chinahk',unique(tmp$model),value=T),
                                                  grep('holdout',unique(tmp$model),value=T)
)
tmp[, ord:=match(model, ord)]
setorder(tmp, ord)
tmp[, ord:=NULL]
tmp[, estim_set:=NULL]
setcolorder(tmp, c('model','type'))

print(kable(tmp, format= 'html', caption = 'Robustness checks'))

```


```{r,echo=FALSE}

tmp = predictions[type=='ec_main' & brand =='samsung' & category=='washing'&country=='india']
tmp[,date:=as.Date(date)]
# selection
with(tmp, plot(date, lnusales, lty=2, type = 'l'))
with(tmp, lines(date, lnusales_hat, lty=1,lwd=2))


```




```{r overview2, echo=FALSE, results='asis'}
#elast_all
tmp = elast[, list(Nbrands = length(unique(brand))), by = c('category','country')]

tabl = dcast.data.table(tmp, category~country, value.var=c('Nbrands'))
rownames(tabl) <- NULL

tabl=sanitize_table(tabl)
setorder(tabl, Category)
kable(tabl, caption = tab('Overview of markets (category/country combination) in the sample (with number of selected brands used in model estimation indicated per cell^1^)', prefix='A'))%>% kable_styling() %>% footnote(number=paste0('Number of brands include the composite brand, which aggregates all brands with market shares lower than 1% in 5 consecutive years (4 years for tablets).'))

```

```{r overview_avgelast, echo=FALSE, results='asis'}
#elast_all
tmp = elast[, list(welast = sum(elastlt*w_elastlt)/sum(w_elastlt)), by = c('category','country', 'variable')]

for (i in ordered_vars) {
  
tabl = dcast.data.table(tmp[variable==i], category~country, value.var=c('welast'))
rownames(tabl) <- NULL

tabl=sanitize_table(tabl)
setorder(tabl, Category)
print(kable(tabl, digits =3, caption = tab(paste0('Mean ', tolower(names(ordered_vars)[ordered_vars==i]), ' by market (category/country combination)^1^'), prefix='A'))%>% kable_styling() %>% footnote(number=paste0('Elasticities weighted by inverse standard errors.')))
}

```

<P style='page-break-before: always'>

```{r attributes, echo = FALSE, results= 'asis'}

# for each category

attributes <- suppressWarnings(melt(brand_panel[!is.na(usalessh), c('category', grep('^attr', colnames(brand_panel),value=T)),with=F], id.vars=c('category')))

attributes[, na:=all(is.na(value)),by=c('category','variable')]

attr = attributes[na==F, list(nobs = .N, meancap=mean(value), sdcap=sd(value), mincap=min(value), maxcap=max(value)),by=c('category','variable')]
setorder(attr,category,variable)
.vars=c('nobs','meancap','sdcap', 'mincap', 'maxcap')
for (.var in .vars) attr[, (.var):=as.character(formatC(get(.var), big.mark=',',digits=ifelse(.var=='nobs', 0, 3), format = 'f'))]

attr<-attr[!grepl('freezernotestimable', variable)]
setnames(attr, 'variable','Attribute')
tabl=sanitize_table(attr)
setorder(tabl, Category)

print(kable(tabl, digits=3, caption = tab('Overview of physical search attributes per category^1^', prefix='A')) %>% kable_styling() %>% footnote(number=c(paste0('The unit of analysis is the brand-month level. Indicator variables are either 0 or 1 at the SKU-month-level; when aggregating them to the brand-month level for the analysis, they are averaged and hence measure the share of a brand\'s SKUs that carry a particular product attribute.'))))
```


<P style='page-break-before: always'>


```{r summarystats_msmodel, echo=FALSE, results= 'asis'}

covars_summary <- gsub('ln', '', c('usales', gsub('rwpspr', 'rwpsprd', ordered_vars)))

tmp=data.table(brand_panel)
nbrands=length(unique(brand_panel$brand))
nmarkets=length(unique(brand_panel$market_id))
nobs=nrow(tmp)

tmp=tmp[, lapply(.SD, function(x) c(median=median(x,na.rm=T),firstqnt=quantile(x,.25,na.rm=T),thirdqnt=quantile(x,.75,na.rm=T))), .SDcols=c(covars_summary)]


tmp[, var:=rep(c('median', 'firstqnt','thirdqnt'),1)]
tmp=melt(tmp, id.var=c('var'))

dtf=dcast(tmp, variable~var)
setcolorder(dtf, c('variable', rep(c('median', 'firstqnt','thirdqnt'),1)))

### add correlation
give_cor <- function(cordat=data.frame(brand_panel[, covars_summary,with=F])) {
  correl=cor(cordat,use='pairwise.complete')
  N=matrix(double(prod(dim(correl))),ncol=ncol(cordat))
  t=N
  p=N
  for (i in 1:nrow(correl)) {
    for (j in 1:ncol(correl)) {
      N[i,j]=length(which(complete.cases(cordat[,c(i,j)])))
      t[i,j]=sqrt(N[i,j]-2)*(correl[i,j]/sqrt(1-correl[i,j]^2))
      p[i,j]=dt(t[i,j], df=N[i,j]-2)
    }
  }
return(list(cor=correl,p=p))
}

correl = give_cor(data.frame(brand_panel[, covars_summary,with=F]))

#sink('../output/tableA4.txt')
#correl$cor
#correl$p
#sink()

dtf=cbind(dtf,correl$cor[,-ncol(correl$cor)])


dtf=sanitize_table(dtf)


print(kable(dtf, format='html', initial.zero = FALSE, digits=3,caption = tab(paste0('Summary statistics and correlations for variables in sales response model^1^'),prefix='A')) %>% kable_styling() %>% footnote(number=c(paste0('Summary statistics and correlations for variables (prior to the log-operation and mean-centering) are computed across ', prettyNum(nobs, big.mark = ','), ' observations in our sample.'),'Converted to USD.')) %>% add_header_above(c(" " = 1, "Summary statistics" = 3, "Correlations" = length(covars_summary)-1)))

```


```{r correl, echo=FALSE, results = 'asis'}

tmp = dcast(elast,category+country+brand~variable, value.var=c('elast', 'elastlt'))

#for (var in grep('elast', colnames(tmp),value=T)) {
#  tmp[, (paste0('mc_', var)):=get(var)-mean(get(var),na.rm=T), by = c('market_id')]
#  }

printtmp=tmp[, grep('elastlt[_]', colnames(tmp),value=T) ,with=F]
setnames(printtmp, gsub('elastlt[_]','',colnames(printtmp)))

setcolorder(printtmp, ordered_vars)

#setnames(printtmp, 'llen', 'llendash')

setnames(printtmp, paste0(rename.fkt(colnames(printtmp)), ' elasticity'))


tmp2=corstars(printtmp, method=c("pearson"),removeTriangle=c('upper'),result='none')
#, caption = tab('Correlation among long-term marketing-mix elasticities', prefix='A'))
kable(tmp2, format='html', caption=tab('Correlation among long-term marketing-mix elasticities',prefix='A')) %>%
        kable_styling() 



```


```{r elast_by_cc2, echo=F,results='asis', include=TRUE}

qval=qnorm(1-sigvalue/2)

for (byvar in c('category')) {
  tmp=elast[!is.na(elastlt), list(N=.N,
                                  elast = sum(elastlt*w_elastlt)/sum(w_elastlt),
                                  sig = signstars(sum(elastlt/elastlt_se,na.rm=T)/sqrt(.N)),
                                  percpos = round(100*length(which(abs(elastlt/elast_se)>=qval&elastlt>0))/.N,0),
                                  percneg = round(100*length(which(abs(elastlt/elast_se)>=qval&elastlt<0))/.N,0),
                                  percns = round(100*length(which(abs(elastlt/elast_se)<qval))/.N,0)),
                                  by=c('variable', byvar)]
  tmp[, lbl := paste0(sprintf("%.3f",elast), ' ', sig)]
  				
  tmp2 = melt(tmp, id.vars=c('variable',byvar))
  setnames(tmp2, 'variable.1', 'par')
  keeppars=c('N', 'lbl','percpos','percneg','percns')
  tmp2 <- tmp2[par%in%keeppars]
  tmp2[, par:=factor(as.character(par),levels=keeppars)]
  tmp2[, variable:=factor(as.character(variable, levels=ordered))]
  
  
  setnames(tmp2, byvar, 'byvar')
  
  tmp=dcast.data.table(tmp2,byvar~variable+par)
  
  
  setnames(tmp, 'byvar', byvar)
  
  
  tmp=sanitize_table(tmp)
  setorderv(tmp, colnames(tmp)[1])
  
  cat("<P style='page-break-before: always'>")
  {print(kable(tmp, digits=3, caption = tab(paste0('Long-term elasticities (means by ', byvar, ')^1^'), prefix=''), format='html', initial.zero = FALSE) %>% add_header_above(list(' '=1, 'Line length' =5, 'Price'=5, 'Distribution' = 5)) %>% kable_styling() %>% footnote(number=paste0(estimnote, ' Reported by ', ifelse(byvar=='country', 'countries', 'categories'), ' in alphabetical order.'))) 
  }
}


```	


