---
title: "GfK Singapore - Results"
output:
  html_document: default
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

libs_to_load <- c('data.table', 'stargazer', 'knitr', 'xtable', 'car', 'kableExtra', 'stringi', 'ggplot2', 'ggpubr', 'plyr', 'gridExtra', 'grid', 'lme4', 'sjstats', 'ggthemes') #'blme' 

for (lib in libs_to_load) eval(parse(text=paste('library(', lib, ')')))

options(xtable.comment = FALSE)
options(knitr.kable.NA = '')

# Load data
  brand_panel=fread('../../analysis/temp/preclean_main.csv')
  brand_panel[, ':=' (date = as.Date(date))]
  
# Load auxilary functions
  source('proc_auxilary.R')
  source('proc_rename.R')

  #elast <- fread('../externals/elast_results_salesresponse_max3_p10_cop_sur.csv') 
  elast = fread('../temp/elast_updated.csv')
  elast[, elastlt:=elast6]
  elast[, elastlt_se:=elast6_sd]
  elast[, elast:=elast6]
  elast[, elast_se:=elast6_sd]
  elast <- elast[!elast6_sd==0]
  #setnames(elast, 'varname', 'variable')
  #source('preclean.R')
  
  elast <- copy(elast)
 
  
# Keep only brands that are common in first/last dataset
  #firstobs = with(elast_firstobs, unique(paste(market_id,brand)))
  #lastobs = with(elast_lastobs, unique(paste(market_id,brand)))
  #bothobs = intersect(firstobs, lastobs)
  
 
  # set order of variables to appear in figures and tables
ordered_vars = c('rwpspr', 'wpswdst','llen')
ordered_vars = ordered_vars[which(ordered_vars%in%elast$variable)]

names(ordered_vars) <- paste0(unlist(sanitize_table(data.frame(gsub('^ln', '', ordered_vars)))), ' elasticity')

lmerctrl = lmerControl(optimizer ="Nelder_Mead", check.conv.singular="ignore")


winsor_p=.01

notes_sig = 'Significance levels: \\* *p*<.1, \\*\\* *p*<.05, \\*\\*\\* *p*<.01 (two-sided).'
  
for (dframe in grep('^elast', ls(),value=T)) {
  print(dframe)
  for (.var in c('elast', 'elastlt')) {
    eval(parse(text=paste0(dframe,"[!is.na(get(.var)), paste0('w_', .var) := 1/get(paste0(.var, '_se'))]")))
    # rescale
    eval(parse(text=paste0(dframe,"[!is.na(get(.var)), paste0('w_', .var) := get(paste0('w_', .var))/max(get(paste0('w_', .var)))]")))
    eval(parse(text=paste0(dframe,"[!is.na(get(.var)), paste0('z_', .var) := get(.var)/get(paste0(.var, '_se'))]")))
  }
}  

estimnote = paste0('Elasticities are weighted by inverse standard errors.')
estimnoteshort= 'weighted by inverse standard errors'


notes_base = paste0("^1^ Regression of long-term elasticities on explanatory variables and three random effects, for brands, categories, and countries, respectively. Estimated using a linear mixed-effects model. ", estimnote, " Continuous variables have been mean-centred. Standard errors in parentheses.")

notes_loglik = 'Log-likelihood ratio tests computed relative to preceding models.'

# order of covariates in models
covars = c("(Intercept)", 
           "emerging", "gdppercap_rev","gci_rev","hdi_rev",
           "sbbe_std_mc",
           "I(sbbe_std_mc * emerging)",
           "I(sbbe_std_mc * gdppercap_rev)",
           "I(sbbe_std_mc * gci_rev)",
           "I(sbbe_std_mc * hdi_rev)",
           "ln_herf_mc", "ln_market_growth_mc", "appliance", "ln_gini_mc", "local_to_market", "international", "mean_ms_mc")

sigvalue = .1
zval = qnorm(1-sigvalue/2)

```

```{r, echo = FALSE}
#`r fig('Conceptual framework (see Word document)')`

#`r tab('Expected Effects on Marketing Elasticities (see Word document)')`
```

# Data

```{r table1_countries, echo = FALSE}
tmp=unique(elast, by='country')[, c('country','gci_00.03_gdppercap_s','gci_overall_s','hdi2010', 'developed'),with=F]
setorderv(tmp, c('developed', 'gci_00.03_gdppercap_s'), order=-1L)
first_emerging=match(0,tmp$developed)
tmp[, developed:=NULL]

tmp=sanitize_table(tmp)
colnames(tmp)[2]<-paste0(colnames(tmp)[2], '^2^')
colnames(tmp)[3]<-paste0(colnames(tmp)[3], '^2^')
colnames(tmp)[4]<-paste0(colnames(tmp)[4], '^3^')

kable(tmp, format='html', digits=2, format.args = list(big.mark = ","), initial.zero = FALSE, caption=tab('Development indicators for countries in sample^1^')) %>%
        kable_styling() %>% footnote(number=c('Countries ranked by GDP per capita.', "GDP per capita is in current USD, based on IMF World Economic Outlook Database (April 2010). The Global Competitiveness Index captures microeconomic and macroeconomic foundations of national competitiveness. Both measures are extracted from the World Economic Forum's Global Competitiveness Report (2010/2011, available at https://www.weforum.org/reports/global-competitiveness-report-2010-2011).", "Human Development Index (HDI), capturing a country's living standard, healthcare quality and knowledge base. Measure obtained from the UN Development Programme (2010, http://hdr.undp.org/en/content/human-development-index-hdi). Taiwan's HDI has been imputed as the mean HDI of Thailand and China.")) %>%
  group_rows("Developed economies", 1, first_emerging-1) %>%
  group_rows("Emerging economies", first_emerging, 14)

```

<P style='page-break-before: always'>

```{r table2_category_overview, echo = FALSE}
tmp=data.table(elast)
tmp[, ncountries:=length(unique(country)),by=c('category')]

tmp=tmp[!grepl('allothers|unbranded', brand,ignore.case=T), list(brand_ms=mean(brand_ms), ncountries=mean(ncountries)), by = c('category', 'appliance', 'brand')]

setorderv(tmp, c('category', 'appliance', 'brand_ms'), order=-1L)
tmp[!brand%in%c('unbranded','local'), rank:=1:.N, by = c('category')]
tmp[, brand_include:= rank%in%1:5]

tmp=tmp[, list(cattype=ifelse(unique(appliance)==1, 'Appliances', 'Electronics'), ncountries=unique(ncountries), nbrandsdat=length(unique(brand)), exemplary_brand_names=paste0((unique(brand[brand_include==T])), collapse=', ')), by='category']
tmp=sanitize_table(tmp)
setnames(tmp, 'Top 5 brands', 'Top 5 brands^2^')

try(setorder(tmp, Category),silent=T)

kable(tmp, format='html', caption=tab('Category overview^1^')) %>%
        kable_styling() %>% footnote(number=c('Categories shown in alphabetical order.', 'Top 5 brands are determined on the basis of their average volume share across countries, and are listed in decreasing order of their market share.'))

```

<P style='page-break-before: always'>

`r tab('Variable operationalization')`

**Panel A. Variables in sales response model**

Variable             | Operationalization
-------------------- | ------------------------------------------------------------------
Sales                | Unit sales for brand *i* in period *t*.
Price                | Average price of brand *i*, computed as a sales-weighted^1^ average across its SKUs sold in period *t*, expressed in local currency and adjusted by a country's consumer price index^2^.
Distribution         | Average distribution of brand *i*, computed as a sales-weighted^1^ average across its SKUs' store-weighted distribution in period *t* (0 = no market coverage, 100 = full market coverage).
Line length          | Number of unique SKUs sold by brand *i* in period *t*.


**Panel B. Variables in market share attraction model^3^**

Variable                  | Operationalization                                    
-------------------- | ------------------------------------------------------------------
... | ...

<P style='page-break-before: always'>
# Results

```{r continue_with_selection, echo=FALSE}
elast_all=data.table(elast)
elast=elast[!is.na(country_of_origin)&!tolower(brand)%in%c('unbranded')]
excluded_brands=setdiff(unique(elast_all$brand), unique(elast$brand))
excluded_brands<-unique(gsub('Allothers.*', 'Composite brands (allothers)', excluded_brands))


```

Reported for a sample of `r length(unique(elast$brand))` unique brands (excluding `r paste0(my_capitalize(excluded_brands), collapse=', ')`).


```{r elasts_full, echo=F,results='asis'}

out = lapply(list(st=c('elast', 'z_elast', 'w_elast'), lt = c('elastlt','z_elastlt','w_elastlt')), function(obj) {
  tmp = elast[!is.na(get(obj[1]))][, ':=' (val=get(obj[1]), val_z=get(obj[2]), val_w=get(obj[3]))]
  tmp=tmp[, list(Neffects=.N, 
   						  ftmelast = sum(val*val_w)/sum(val_w),
   						  median_elast = median(val), 
  						  interval90 = paste0('[',paste(sprintf("%.3f",quantile(val, c(.05,.95))),collapse=', '),']')),
  												#  perc_positive = length(which(val_z>=(zval)))/.N, 
  												#  perc_null = length(which(abs(val_z)<zval))/.N, 
  												#  perc_negative = length(which(val_z<=(-zval)))/.N), 
  												by=c('variable')]
  tmp=tmp[match(ordered_vars, variable)]
  setnames(tmp, 'variable', 'mmixinstr')
  return(tmp)
  })
  
iters = list(lt=c('lt', 'Long-term')) #st=c('st', 'Short-term'), 
for (iter in iters) {

  print(kable(sanitize_table(out[[iter[1]]]), digits=3, format='html', format.args = list(big.mark = ","),
        caption=tab(paste0(iter[2], ' elasticities by marketing-mix instrument^1^'),prefix='')) %>% kable_styling() %>% 
        footnote(number=c(paste0('Table reports ', tolower(iter[2]), ' elasticities. The number of observations differs slightly across marketing-mix instruments because some brands in some markets (category/country combinations) do not have variation in these variables.'), estimnote)))
  #cat("<P style='page-break-before: always'>")

  }

```

```{r elasts_by_dekimpe, echo=F,results='asis'}

out = lapply(list(st=c('elast', 'z_elast', 'w_elast'), lt = c('elastlt','z_elastlt','w_elastlt')), function(obj) {
  tmp = elast[!is.na(get(obj[1]))][, ':=' (val=get(obj[1]), val_z=get(obj[2]), val_w=get(obj[3]))]
  tmp=tmp[, list(Neffects=.N, 
   						  ftmelast = sum(val*val_w)/sum(val_w),
   						  median_elast = median(val), 
  						  interval90 = paste0('[',paste(sprintf("%.3f",quantile(val, c(.05,.95))),collapse=', '),']')),
  												#  perc_positive = length(which(val_z>=(zval)))/.N, 
  												#  perc_null = length(which(abs(val_z)<zval))/.N, 
  												#  perc_negative = length(which(val_z<=(-zval)))/.N), 
  												by=c('variable', 'ur_dv','ur_focalmmix')]
 # tmp=tmp[match(ordered_vars, variable)]
  setnames(tmp, 'variable', 'mmixinstr')
  tmp[, ur_dv_lbl := ifelse(ur_dv==1, 'ur1_sales_persistent', 'ur0_sales_temporary')]
  tmp[, ur_focalmmix_lbl := ifelse(ur_focalmmix==1, 'ur1_mmix_sustained', 'ur0_mmix_temporary')]
  
  return(tmp)
  })
  
tmp=lapply(ordered_vars, function(x) {
  dcast(out$lt[mmixinstr==x], ur_dv_lbl~ur_focalmmix_lbl,value.var='ftmelast')
})

#dcast(out$lt,dekimpe_classification~mmixinstr,value.var='ftmelast')

for (iter in seq(along=tmp)) {

  print(kable(sanitize_table(tmp[[iter]]), digits=3, format='html', format.args = list(big.mark = ","),
        caption=tab(paste0(gsub('city', 'cities', names(ordered_vars)[iter]), ' by temporary vs. permanent effort/response ^1^'),prefix='')) %>% kable_styling() %>% 
        footnote(number=c(paste0('Table reports ', tolower(paste0(gsub('city', 'cities', names(ordered_vars)[iter]))), '.'), estimnote)))
  #cat("<P style='page-break-before: always'>")

  }

```


```{r elast_by_cc, echo=F,results='asis', include=TRUE}

for (byvar in c('country')) {
  tmp=elast[!is.na(elastlt), list(elast = sum(elastlt*w_elastlt)/sum(w_elastlt),
                                  sig = signstars(sum(elastlt/elastlt_se,na.rm=T)/sqrt(.N))), by=c('variable', byvar)]
  tmp[, lbl := paste0(sprintf("%.3f",elast), ' ', sig)]
  											
  setnames(tmp, byvar, 'byvar')
  
  tmp=dcast(tmp,byvar~variable,value.var='lbl')
  setnames(tmp, 'byvar', byvar)
  setcolorder(tmp, c(byvar, ordered_vars))
  
  tmp=sanitize_table(tmp)
  setorderv(tmp, colnames(tmp)[1])
  
  cat("<P style='page-break-before: always'>")
  {print(kable(tmp, digits=3, caption = tab(paste0('Long-term elasticities (means by ', byvar, ')^1^'), prefix=''), format='html', initial.zero = FALSE) %>%
        kable_styling() %>% footnote(number=paste0(estimnote, ' Reported by ', ifelse(byvar=='country', 'countries', 'categories'), ' in alphabetical order.')))
  }
}

```	


```{r elasticities_overview, echo = FALSE, results='asis'}
out= NULL

for (i in 1:2) {
  if (i==1) obj=c('elast', 'w_elast', 'z_elast')
  if (i==2) obj=c('elastlt','w_elastlt', 'z_elastlt')
  
  tmp = elast[!is.na(get(obj[1]))][, ':=' (val=get(obj[1]), 
                                           val_w=get(obj[2]),
                                           val_z=get(obj[3]))]

  # different t-tests

  diff_tests=lapply(c(ttest='ttest', wls='wls',re='re'), function(tvalrep) {
    
    if (tvalrep=='wls') {
    # OLS-based p values   
    diff_tests=rbindlist(lapply(unique(elast$variable), function(.var) {
      data.table(variable=.var, effect=c('constant', 'emerging'), summary(lm(val~1+emerging, weights=val_w,data=tmp[variable==.var]))$coefficients)
    }))
          taddition = paste0('Tests on differences carried out by regressing elasticities (', estimnoteshort, ') on an intercept and an emerging-country indicator. The reported t-value is obtained from the estimate of the emerging-country indicator.')

          }
  
    if (tvalrep=='re') {
    # random effects based p values
      diff_tests=rbindlist(lapply(unique(tmp$variable), function(.var) {
      data.table(variable=.var, effect=c('constant', 'emerging'), summary(lmer(val~1+(1|category) + (1|country) + (1|brand) + emerging, weights=val_w,control = lmerctrl, data=tmp[variable==.var]))$coefficients)[, p:=2*(1-pnorm(abs(get('t value'))))]
    }))
      taddition = paste0('Tests on differences carried out by regressing elasticities (', estimnoteshort, ') on an intercept, an emerging-country indicator and three random effects, for brands, categories, and countries, respectively. The reported t-value is obtained from the estimate of the emerging-country indicator.')

          }
  
   if (tvalrep=='ttest') {
     
  # random effects based p values
    diff_tests=rbindlist(lapply(unique(tmp$variable), function(.var) {
      xemerg=tmp[variable==.var&emerging==1]$val
      xdevel=tmp[variable==.var&emerging==0]$val
      
      tout = t.test(xemerg,xdevel)
      
    data.table(variable=.var, effect=c('emerging'), NA, NA, tout$statistic, tout$p.value)
    }))
    
    taddition = paste0('Tests on differences carried out using a two-sided t-test.')
   }

  setnames(diff_tests, c('variable', 'effect', 'diff_est', 'diff_se', 'diff_t','diff_p'))
  diff_tests=diff_tests[effect=='emerging'][, effect:=NULL]
  diff_tests[,testtype:=tvalrep]
  return(list(diff_tests=diff_tests, notes=taddition))
  })
  
  
  ttests=melt(rbindlist(lapply(diff_tests, function(x) x$diff_tests))[, ':=' (var=variable,variable=NULL)], id.vars=c('var','testtype'))
  
  ttests=dcast(ttests, var~testtype+variable)
  setnames(ttests, 'var', 'variable')
  
  notes<-lapply(diff_tests, function(x) x$notes)
  
  
  tmp = merge(tmp, ttests, by = c('variable'))

  
  tmp=tmp[, list(Neffects= .N, 
                 all_ftmelast = sum(val*val_w)/sum(val_w),
					 		   all_3sig = signstars(sum(val_z,na.rm=T)/sqrt(.N)),
											  
								 dev_Neffects= length(which(!is.na(val[developed==1]))),
			           dev_ftmelast = sum(val[developed==1]*val_w[developed==1])/sum(val_w[developed==1]),
								 dev_3sig = signstars(sum(val_z[developed==1])/sqrt(length(which(!is.na(val[developed==1]))))),
								 
								 em_Neffects= length(which(!is.na(val[developed==0]))),
			           em_ftmelast = sum(val[developed==0]*val_w[developed==0])/sum(val_w[developed==0]),
								 em_3sig = signstars(sum(val_z[developed==0])/sqrt(length(which(!is.na(val[developed==0]))))),
								 wls_t = unique(wls_diff_t), wls_sig = psignstars(unique(wls_diff_p))
								 ), by=c('variable')]

  tmp=tmp[match(ordered_vars, variable)]
  setnames(tmp, 'variable', 'mmixinstr')
  
  out[[i]]<-tmp
  }
  
names(out)<-c('st','lt')

#iters = list(st=c('st', 'Short-term'), lt=c('lt', 'Long-term'))
iters = list(lt=c('lt', 'Long-term'))
for (iter in iters) {
  print(kable(sanitize_table(out[[iter[1]]]), digits=3, format='html', format.args = list(big.mark = ","),
        caption=tab(paste0('Differences in ', tolower(iter[2]), ' elasticities between developed and emerging markets^1^'))) %>% kable_styling() %>% 
        footnote(number=c(paste0(notes_sig, ' The number of observations differs slightly across marketing-mix instruments because some brands in some markets (category/country combinations) do not have variation in these variables.'),estimnote, 'Significance tested using meta-analytic p-value.', notes[2])) %>% add_header_above(c(" " = 1, "All countries" = 3, "Developed markets" = 3, "Emerging markets" = 3, 'Tests on differences' =2)))
}
  
```

<P style='page-break-before: always'>


```{r reset, echo=FALSE,results='asis'}
tableno<<-0
figureno<<-0
cat("<P style='page-break-before: always'>")
  
```

# Appendix

```{r sample_origin, echo=FALSE, results='asis'}

cols =  c('country_of_origin')
tmp = elast[, list(.N), by = c('brand',cols)]
tmp = tmp[, list(nbrands=length(unique(brand)), all_brands=paste(brand[order(brand)], collapse=', ')), by = cols]
tmp[country_of_origin==''|is.na(country_of_origin), country_of_origin := 'Country not available']
tmp[, country_of_origin:=my_capitalize(country_of_origin)]

setorderv(tmp, 'nbrands', order=-1L)
setcolorder(tmp, c('country_of_origin', 'nbrands', 'all_brands'))

tmp=sanitize_table(tmp)

kable(tmp, caption = tab('Country-of-origins for brands in sample^1^', prefix ='A'),format='html') %>%
        kable_styling() %>% footnote(number=paste0('Countries are ordered by the number of brands from a given country; brand names are listed alphabetically.'))

```

<P style='page-break-before: always'>
```{r VIFS, echo=FALSE,results='asis', include=FALSE}
if(0){
m1 = ~1+ appliance + ln_market_growth_mc + ln_market_herf_mc + local_to_market  + ln_brand_prindex_mean_mc + brandz

m<-lm(update(elast~., m1), data=elast[variable=='llen'])

frame1=data.frame(vif(m))
colnames(frame1) <- c('VIF')
frame1$variable=rownames(frame1)
rownames(frame1)<-NULL
frame1=frame1[, c('variable','VIF')]
frame1=sanitize_table(frame1)
cat("<P style='page-break-before: always'>")

if(0){
kable(frame1,format='html', caption = tab('Assessing multicollinearity^1^', prefix='A'))%>% kable_styling() %>% footnote(number=paste0('Table reports VIFs values calculated in regression models using main effects for all variables listed above (i.e., excluding brand, category, and country effects).'))
}
}
```


```{r overview2, echo=FALSE, results='asis'}
tmp = elast_all[, list(Nbrands = length(unique(brand))), by = c('market_id', 'category','country')]

tabl = dcast(tmp, category~country, value.var=c('Nbrands'))

tabl=sanitize_table(tabl)
setorder(tabl, Category)
kable(tabl, caption = tab('Overview of markets (category/country combination) in the sample (with number of selected brands used in model estimation indicated per cell^1^)', prefix='A'))%>% kable_styling() %>% footnote(number=paste0('Number of brands include the composite brand, which aggregates all brands with market shares lower than 1% in 5 consecutive years (4 years for tablets).'))

```

<P style='page-break-before: always'>

```{r attributes, echo = FALSE, results= 'asis'}

# for each category

attributes <- suppressWarnings(melt(brand_panel[!is.na(usalessh), c('category', grep('^attr', colnames(brand_panel),value=T)),with=F], id.vars=c('category')))

attributes[, na:=all(is.na(value)),by=c('category','variable')]

attr = attributes[na==F, list(nobs = .N, meancap=mean(value), sdcap=sd(value), mincap=min(value), maxcap=max(value)),by=c('category','variable')]
setorder(attr,category,variable)
.vars=c('nobs','meancap','sdcap', 'mincap', 'maxcap')
for (.var in .vars) attr[, (.var):=as.character(formatC(get(.var), big.mark=',',digits=ifelse(.var=='nobs', 0, 3), format = 'f'))]

attr<-attr[!grepl('freezernotestimable', variable)]
setnames(attr, 'variable','Attribute')
tabl=sanitize_table(attr)
setorder(tabl, Category)

print(kable(tabl, digits=3, caption = tab('Overview of physical search attributes per category^1^', prefix='A')) %>% kable_styling() %>% footnote(number=c(paste0('The unit of analysis is the brand-month level. Indicator variables are either 0 or 1 at the SKU-month-level; when aggregating them to the brand-month level for the analysis, they are averaged and hence measure the share of a brand\'s SKUs that carry a particular product attribute.'))))
```


<P style='page-break-before: always'>


```{r summarystats_msmodel, echo=FALSE, results= 'asis'}

covars_summary <- gsub('ln', '', c('usalessh', gsub('rwpspr', 'rwpsprd', ordered_vars)))

tmp=data.table(brand_panel)
nbrands=length(unique(brand_panel$brand))
nmarkets=length(unique(brand_panel$market_id))
nobs=nrow(tmp)

tmp=tmp[, lapply(.SD, function(x) c(median=median(x,na.rm=T),firstqnt=quantile(x,.25,na.rm=T),thirdqnt=quantile(x,.75,na.rm=T))), .SDcols=c(covars_summary)]


tmp[, var:=rep(c('median', 'firstqnt','thirdqnt'),1)]
tmp=melt(tmp, id.var=c('var'))

dtf=dcast(tmp, variable~var)
setcolorder(dtf, c('variable', rep(c('median', 'firstqnt','thirdqnt'),1)))

### add correlation
give_cor <- function(cordat=data.frame(brand_panel[, covars_summary,with=F])) {
  correl=cor(cordat,use='pairwise.complete')
  N=matrix(double(prod(dim(correl))),ncol=ncol(cordat))
  t=N
  p=N
  for (i in 1:nrow(correl)) {
    for (j in 1:ncol(correl)) {
      N[i,j]=length(which(complete.cases(cordat[,c(i,j)])))
      t[i,j]=sqrt(N[i,j]-2)*(correl[i,j]/sqrt(1-correl[i,j]^2))
      p[i,j]=dt(t[i,j], df=N[i,j]-2)
    }
  }
return(list(cor=correl,p=p))
}

correl = give_cor(data.frame(brand_panel[, covars_summary,with=F]))

#sink('../output/tableA4.txt')
#correl$cor
#correl$p
#sink()

dtf=cbind(dtf,correl$cor[,-ncol(correl$cor)])


dtf=sanitize_table(dtf)


print(kable(dtf, format='html', initial.zero = FALSE, digits=3,caption = tab(paste0('Summary statistics and correlations for variables in sales response model^1^'),prefix='A')) %>% kable_styling() %>% footnote(number=c(paste0('Summary statistics and correlations for variables (prior to the log-operation and mean-centering) are computed across ', prettyNum(nobs, big.mark = ','), ' observations in our sample.'),'Converted to USD.')) %>% add_header_above(c(" " = 1, "Summary statistics" = 3, "Correlations" = length(covars_summary)-1)))

```


```{r correl, echo=FALSE, results = 'asis'}

tmp = dcast(elast,market_id+brand~variable, value.var=c('elast', 'elastlt'))

#for (var in grep('elast', colnames(tmp),value=T)) {
#  tmp[, (paste0('mc_', var)):=get(var)-mean(get(var),na.rm=T), by = c('market_id')]
#  }

printtmp=tmp[, grep('elastlt[_]', colnames(tmp),value=T) ,with=F]
setnames(printtmp, gsub('elastlt[_]','',colnames(printtmp)))

setcolorder(printtmp, ordered_vars)

#setnames(printtmp, 'llen', 'llendash')

setnames(printtmp, paste0(rename.fkt(colnames(printtmp)), ' elasticity'))


tmp2=corstars(printtmp, method=c("pearson"),removeTriangle=c('upper'),result='none')
#, caption = tab('Correlation among long-term marketing-mix elasticities', prefix='A'))
kable(tmp2, format='html', caption=tab('Correlation among long-term marketing-mix elasticities',prefix='A')) %>%
        kable_styling() 



```


```{r elast_by_cc2, echo=F,results='asis', include=TRUE}

for (byvar in c('category')) {
  tmp=elast[!is.na(elastlt), list(elast = sum(elastlt*w_elastlt)/sum(w_elastlt),
                                  sig = signstars(sum(elastlt/elastlt_se,na.rm=T)/sqrt(.N))), by=c('variable', byvar)]
  tmp[, lbl := paste0(sprintf("%.3f",elast), ' ', sig)]
  											
  setnames(tmp, byvar, 'byvar')
  
  tmp=dcast(tmp,byvar~variable,value.var='lbl')
  
  setnames(tmp, 'byvar', byvar)
  setcolorder(tmp, c(byvar, ordered_vars))
  
  tmp=sanitize_table(tmp)
  setorderv(tmp, colnames(tmp)[1])
  
  cat("<P style='page-break-before: always'>")
  {print(kable(tmp, digits=3, caption = tab(paste0('Long-term elasticities (means by ', byvar, ')^1^'), prefix='A'), format='html', initial.zero = FALSE) %>%
        kable_styling() %>% footnote(number=paste0(estimnote, ' Reported by ', ifelse(byvar=='country', 'countries', 'categories'), ' in alphabetical order.')))
  }
}


```	


```{r newanalysis_robust, results = 'asis', include = TRUE, echo=FALSE}
if(0){
# formulas for models

elast_backup = data.table(elast)

elast_backup[!is.na(elastlt), mean_ms_mc := mean_ms-mean(mean_ms,na.rm=T), by = c('variable')]

elast_backup[, international:=ifelse(ncountries>=2,1,0)]

elast_backup[, gdppercap_rev := -ln_gci_00.03_gdppercap_s_mc]
elast_backup[, gci_rev := -ln_gci_overall_s_mc]
elast_backup[, hdi_rev := -ln_hdi2010_mc]

upd_models = list(
  main = .~1 + emerging + sbbe_std_mc + I(sbbe_std_mc*emerging)+ (1|country) + (1|category) + (1|brand) + ln_herf_mc + ln_market_growth_mc + appliance + ln_gini_mc + local_to_market,
  
marketshare = .~1 + emerging + sbbe_std_mc + I(sbbe_std_mc*emerging)+ (1|country) + (1|category) + (1|brand) + ln_herf_mc + ln_market_growth_mc + appliance + ln_gini_mc + local_to_market + mean_ms_mc,

international = .~1 + emerging + sbbe_std_mc + I(sbbe_std_mc*emerging)+ (1|country) + (1|category) + (1|brand) + ln_herf_mc + ln_market_growth_mc + appliance + ln_gini_mc + local_to_market + international,

gdp = .~1 + gdppercap_rev + sbbe_std_mc + I(sbbe_std_mc*gdppercap_rev)+ (1|brand) + (1|category) + (1|country) + ln_herf_mc + ln_market_growth_mc + appliance + ln_gini_mc + local_to_market,

gci = .~1 + gci_rev + sbbe_std_mc + I(sbbe_std_mc*gci_rev)+ (1|country) + (1|category) + (1|brand) + ln_herf_mc + ln_market_growth_mc + appliance + ln_gini_mc + local_to_market,

hdi = .~1 + hdi_rev + sbbe_std_mc + I(sbbe_std_mc*hdi_rev)+ (1|country) + (1|category) + (1|brand) + ln_herf_mc + ln_market_growth_mc + appliance + ln_gini_mc + local_to_market
)

out=regmodel(formula=c(upd_models), dat=elast_backup, model='lmer')

outlagx = regmodel(formula=list(lagx=upd_models$main), dat=elast_laggedx, model='lmer')

elast_backup[is.na(gamma_lagms), gamma_lagms:=0]
elast_backup[, elastlt := beta/(1-gamma_lagms)]

out2=regmodel(formula=list(lambda=upd_models$main), dat=elast_backup, model='lmer')

outsim=regmodel(formula=list(simulated=upd_models$main), dat=elast_simulated, model='lmer')


outx = NULL

  for (mod in names(out)) {
    outx[[mod]]$variable=out[[mod]]$variable
    outx[[mod]]$st=c(out[[mod]]$st$main, out[[mod]]$st$gdp, out[[mod]]$st$gci, out[[mod]]$st$hdi, out[[mod]]$st$marketshare, out[[mod]]$st$international, out2[[mod]]$st$lambda, outlagx[[mod]]$st$lagx, outsim[[mod]]$st$simulated)
    outx[[mod]]$lt=c(out[[mod]]$lt$main, out[[mod]]$lt$gdp, out[[mod]]$lt$gci, out[[mod]]$lt$hdi, out[[mod]]$lt$marketshare, out[[mod]]$lt$international, out2[[mod]]$lt$lambda, outlagx[[mod]]$lt$lagx, outsim[[mod]]$lt$simulated)
  }

#sink('test.htm')
for (i in seq(along=ordered_vars)) {
  cat("<P style='page-break-before: always'>")

  printout(outx, 'lt', title = tab(paste0('Robustness checks for long-term ', tolower(gsub('ity', 'ities', gsub('Line length', 'Line-length', names(ordered_vars[i])))), ''), prefix='A'), vars=ordered_vars[i],  notes=paste0(gsub('term elasticities', 'term elasticities (all models; except beta/(1-gamma) in model 4)', notes_base), ' Model (1) is the focal model; models (2)-(4) replace the emerging market indicator by alternative (continuous) metrics that measure a country\'s degree of development; because these metrics are increasing with a country\'s degree of development, they have been reverse-coded in model estimation, so that coefficients between model (1) and models (2)-(4) can directly be compared. Model (5) controls for a brand\'s market share, while model (6) controls for international brands (indicator variable, 1 for brands active in more than 1 country, 0 otherwise). Model (7) replaces long-term elasticities by beta/(1-gamma). Elasticities in model (8) are calculated from an alternative market share attraction model, allowing for marketing-mix and brand-specific dynamics by adding lagged marketing mix variable (but removing the common carry-over parameter); elasticities in model (9) are dynamically simulated, see Web Appendix B for the details.'), covariate_choices = covars, table.layout.overwrite=c('-c#m-t-a-n'),
           colnames_overwrite=c('Main model', 'Log GDP', 'Log GCI','Log HDI', 'Controlling for marketshare', 'Controlling for international brands','DV is beta/(1-gamma)', 'Marketing-mix and brand-specific dynamics', 'Dynamic simulation'), colsep_overwrite = rep(1,9))
}

#sink()
}
```
