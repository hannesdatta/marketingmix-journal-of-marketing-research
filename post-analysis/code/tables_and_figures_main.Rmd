---
title: "Main tables"
subtitle: "Cross-National Differences in Market Response: Line-Length, Price, and Distribution Elasticities in Fourteen Indo-Pacific Rim Economies"
output:
  html_document: default
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(xtable.comment = FALSE)
options(knitr.kable.NA = '')

# load packages
library(data.table)
library(stargazer)
library(knitr)
library(xtable)
library(car)
library(kableExtra)
library(stringi)
library(ggplot2)
library(lmtest)
library(sandwich)
library(gridExtra)
library(ggthemes)

# Load data set
brand_panel=fread('../../analysis/temp/preclean_main.csv')
brand_panel[, ':=' (date = as.Date(date))]

# Load auxiliary functions
source('proc_auxilary.R')
source('proc_rename.R')

# Load results
load('../output/workspace.RData')

# set order of variables to appear in figures and tables
ordered_vars =  c('llen', 'rwpspr', 'wpswdst')
ordered_vars = ordered_vars[which(ordered_vars%in%elast$variable)]

names(ordered_vars) <- paste0(unlist(sanitize_table(data.frame(gsub('^ln', '', ordered_vars)))), ' elasticity')

# Notes for tables
notes_sig = 'Significance levels: \\* *p*<.1, \\*\\* *p*<.05, \\*\\*\\* *p*<.01 (two-sided).'
estimnote = paste0('Elasticities are weighted by inverse standard errors.')

# Significance levels
sigvalue = .1
zval = qnorm(1-sigvalue/2)

elast=elast[!is.na(country_of_origin)&!country_of_origin==''&!tolower(brand)%in%c('unbranded')]

stopifnot(any(grepl('super|amazon', elast$brand))==F)


```


Reported generated for `r length(unique(elast$brand))` unique brands.


```{r table1_countries, echo=FALSE, warning=FALSE}
tmp=unique(elast, by='country')[, c('country','penn_popavg', 'penn_percapitargdpeavg', 'penn_growthrgdpeavg', 'ginicoef','pdi', 'uai','mas'),with=F]

setorderv(tmp, c('country'))

tmp=sanitize_table(tmp)

kable(tmp, format='html', digits=c(0,2, 0,2 ,2,0,0,0), format.args = list(big.mark = ",", format ='f'), initial.zero = FALSE, caption=tab('Development indicators for countries in sample^1^')) %>%
        kable_styling() %>% footnote(number=c('Countries shown in alphabethical order. Sources to be updated.'))
```

```{r table2_category_overview, echo=FALSE, warning=FALSE}
tmp=data.table(elast)
tmp[, ncountries:=length(unique(country)),by=c('category')]

tmp=tmp[!grepl('allothers|unbranded', brand,ignore.case=T), list(brand_ms=mean(brand_ms), ncountries=mean(ncountries)), by = c('category', 'appliance', 'brand')]

setorderv(tmp, c('category', 'appliance', 'brand_ms'), order=-1L)
tmp[!brand%in%c('unbranded','local'), rank:=1:.N, by = c('category')]
tmp[, brand_include:= rank%in%1:3]

tmp=tmp[, list(cattype=ifelse(unique(appliance)==1, 'Appliances', 'Electronics'), ncountries=unique(ncountries), nbrandsdat=length(unique(brand)), exemplary_brand_names=paste0(my_capitalize(unique(brand[brand_include==T])), collapse=', ')), by='category']
tmp[, category:=tolower(category)]
tmp=sanitize_table(tmp)
setnames(tmp, 'Top 5 brands', 'Top 3 brands^2^')

tmp[, sort_category:=tolower(get('Category'))]
setorder(tmp, sort_category)
tmp[, sort_category:=NULL]

kable(tmp, format='html', caption=tab('Category overview^1^')) %>%
        kable_styling() %>% footnote(number=c('Categories shown in alphabetical order.', 'Top 5 brands are determined on the basis of their average volume share across countries, and are listed in decreasing order of their market share.'))

```

     

```{r elast_by_cc, echo=F, message=FALSE, warning=FALSE, include=TRUE, results='asis'}

elast[, novar:='pooled']

out = lapply(list(st=c('elast', 'elast_se'), lt = c('elastlt','elastlt_se')), function(obj) {
  
  tmp_elast = elast[!is.na(get(obj[1]))][, ':=' (val=get(obj[1]), val_se=get(obj[2]))]
  tmp_elast[, val_w := 1/val_se]
  
for (byvar in c('country', 'category', 'novar')) {
  tmp=tmp_elast[, list(N=.N,
                                  elast = sum(val*val_w)/sum(val_w),
                                  sig = signstars(sum(val/val_se,na.rm=T)/sqrt(.N)),
                                  percpos = 100*length(which(abs(val/val_se)>=zval&val>0))/.N,
                                  percneg = 100*length(which(abs(val/val_se)>=zval&val<0))/.N,
                                  percns = 100*length(which(abs(val/val_se)<zval))/.N),
                                  by=c('variable', byvar)]
  
  tmp[, lbl := paste0(sprintf("%.3f",elast), ' ', sig)]
  
  tmp2 = melt(tmp, id.vars=c('variable',byvar))
  tmp2[grepl('^perc', variable.1), value:=round_percent(as.numeric(value)),by=c('variable', byvar)]
  
  #round
  
  setnames(tmp2, 'variable.1', 'par')
  keeppars=c('N', 'lbl','percpos','percneg','percns')
  tmp2 <- tmp2[par%in%keeppars]
  tmp2[, par:=factor(as.character(par),levels=keeppars)]
  tmp2[, variable:=factor(as.character(variable, levels=ordered))]
  
  
  setnames(tmp2, byvar, 'byvar')
  
  tmp=dcast(tmp2,byvar~variable+par)
  
  
  setnames(tmp, 'byvar', byvar)

  
  tmp=sanitize_table(tmp)
  
  tmp[, varorder:=tolower(get(colnames(tmp)[1]))]
  setorder(tmp, varorder)
  tmp[, varorder:=NULL]
  
  cat("<P style='page-break-before: always'>")
  
  type_of_elast = 'Long-term'
  if (obj[1]=='elast') type_of_elast = 'Short-term'
  {print(kable(tmp, digits=3, caption = tab(paste0(type_of_elast, ' elasticities (means by ', byvar, ')^1^'), prefix=''), format='html', initial.zero = FALSE) %>% add_header_above(list(' '=1, 'Line length' =5, 'Price'=5, 'Distribution' = 5)) %>% kable_styling() %>% footnote(number=paste0(estimnote, ' Reported by ', ifelse(byvar=='country', 'countries', 'categories'), ' in alphabetical order.'))) 
  }
}})


```	

```{r, results = 'asis', echo = FALSE}

model_formula <- . ~ 1 + sbbe_round1_mc+`brand_from_jp-us-ch-ge-sw`+ln_rwpspr_windex_mc+ln_wpswdst_windex_mc+ln_llen_windex_mc+ln_nov6sh_windex_mc+ln_market_herf_mc+ln_market_meangrowth_mc+appliance+ln_penn_growthrgdpeyravg_mc+ln_ginicoef_mc+ln_penn_percapitargdpeyravg_mc+ln_penn_popyravg_mc+ln_uai_mc+ln_pdi_mc+ln_mas_mc

tmp = data.table(elast)

dv_name='elastlt'
tmp[, ':=' (dv = get(dv_name), dv_se = get(paste0(dv_name,'_se')), w_dv = 1/get(paste0(dv_name,'_se')))]

# winsorizations
tmp[!is.na(dv), percentile:=ecdf(dv)(dv), by = c('variable')]
perc_extract = 0.01 # check w/ marnik

tmp[, perc_low := quantile(dv, probs = perc_extract), by = c('variable')]
tmp[, perc_high := quantile(dv, probs = 1-perc_extract), by = c('variable')]
    
tmp[percentile<perc_extract, dv:=perc_low]
tmp[percentile>(1-perc_extract), dv:=perc_high]
  

model_results <- lapply(ordered_vars, function(var) {
  estim_data = tmp[grepl(var, variable)]
  m<-lm(update.formula(dv~1, model_formula), data = estim_data, weights = w_dv)
 
  # predictions
  avail=setdiff(1:nrow(estim_data), m$na.action)
  pred=data.table(estim_data[, c('brand','brand_id','category','country', 'dv')][avail], variable=var, dv_pred=predict(m))
     
  
  r2= rsq(m)
  loglik = logLik(m)
  aic=AIC(m)
  bic=BIC(m)
  m <- coeftest(m, vcov = vcovCL, cluster = ~ brand + category + country, fix = T, type = 'HC1')
  
  return(list(model=m, r2=r2, aic=aic, bic=bic, loglik=loglik, predictions=pred))
})   



r2s = c('R-squared', sub('^(-)?0[.]', '\\1.', formatC(unlist(lapply(model_results, function(x) x$r2)), digits=3, format='f', flag='#')))
aic = c('AIC', sub('^(-)?0[.]', '\\1.', formatC(unlist(lapply(model_results, function(x) x$aic)), digits=2, format='f', flag='#')))
bic = c('BIC', sub('^(-)?0[.]', '\\1.', formatC(unlist(lapply(model_results, function(x) x$bic)), digits=2, format='f', flag='#')))
obs = c('Observations', formatC(unlist(lapply(model_results, function(x) nrow(x$predictions)))))
loglik = c('LL', sub('^(-)?0[.]', '\\1.', formatC(unlist(lapply(model_results, function(x) x$loglik)), digits=2, format='f', flag='#')))
lbllist = list(r2s,aic, bic, loglik, obs)
    
    
stargazer(lapply(model_results, function(x) x$model), type='html', add.lines=lbllist,
                        column.labels = ordered_vars)
    

```

# Allocation tables

## by country

```{r, echo = FALSE}

# Load distribution predictions from model

dt = model_results$`Distribution elasticity`$predictions
setkey(dt, category, country, brand)
tmp = unique(elast[,c('avgsales','avgbrandgrowth', 'brand','category','country'),with=F], by = c('category','country','brand'))
dt <- merge(dt, tmp, by = c('category','country','brand'),all.x=T)

source('confidential_data.R')

# Keep selected brand/category
dt <- dt[brand== brand_choice1 & category == 'washing']

dt[, avgsales:=avgsales*scaling_constant]

dt[, relelast:=100*abs(dv_pred)/sum(abs(dv_pred))]
dt[, relsales:=100*avgsales/sum(avgsales)]
dt[, elast_x_size:=abs(dv_pred)*avgsales*avgbrandgrowth]
dt[, optimal:=100*elast_x_size/sum(elast_x_size)]

tmp = dt[, c('country', 'avgsales', 'dv_pred',  'avgbrandgrowth', 'relsales','relelast', 'optimal'),with=F]
library(stringr)
tmp[, country:= str_to_title(country)]
setorder(tmp, country)

setnames(tmp, 'country', 'Country', skip_absent = T)
setnames(tmp, 'category', 'Category', skip_absent = T)
setnames(tmp, 'avgsales', 'Unit sales')
setnames(tmp, 'dv_pred', 'Distribution elasticity')
setnames(tmp, 'avgbrandgrowth', 'Expected brand growth index')
setnames(tmp, 'relsales', 'Unit sales (%)')
setnames(tmp, 'relelast', 'Distribution elasticity (%)')
setnames(tmp, 'optimal', 'Optimal (%)')

ret=kable(tmp, digits=c(0,0,3,3,1,1,1), 
          caption = tab(paste0('Allocation of Expenditure on Distribution'), prefix='A'),
          format='html',
          initial.zero = FALSE) %>% 
      add_header_above(list(' '=4, 'Allocation proportional to' =3)) %>% kable_styling() %>% footnote(number = paste0('Countries shown in alphabetical order. Predicted distribution elasticities shown for a leading brand in the washing machines category. Unit sales are a brand’s average unit sales in the data, scaled by a constant to preserve the anonymity of the brand. The expected brand growth index is computed as the annual percentage change in unit sales for the chosen brand, averaged over the last three years in the data. The “optimal” allocation is based on the decision rule developed in Fischer et al. (2011).'))

ret
```

## by category

```{r, echo = FALSE}

# Load distribution predictions from model
dt = model_results$`Distribution elasticity`$predictions

setkey(dt, category, country, brand)
tmp = unique(elast[,c('avgsales','avgbrandgrowth', 'brand','category','country'),with=F], by = c('category','country','brand'))
dt <- merge(dt, tmp, by = c('category','country','brand'),all.x=T)

# Keep selected brand/category
dt <- dt[brand== brand_choice2 & country == 'indonesia']

dt[, avgsales:=avgsales*scaling_constant]

dt[, relelast:=100*abs(dv_pred)/sum(abs(dv_pred))]
dt[, relsales:=100*avgsales/sum(avgsales)]
dt[, elast_x_size:=abs(dv_pred)*avgsales*avgbrandgrowth]
dt[, optimal:=100*elast_x_size/sum(elast_x_size)]

tmp = dt[, c('category', 'avgsales', 'dv_pred',  'avgbrandgrowth', 'relsales','relelast', 'optimal'),with=F]
library(stringr)
tmp[, category:= replace_categories(category)]
setorder(tmp, category)

setnames(tmp, 'category', 'Category')
setnames(tmp, 'avgsales', 'Unit sales')
setnames(tmp, 'dv_pred', 'Distribution elasticity')
setnames(tmp, 'avgbrandgrowth', 'Expected brand growth index')
setnames(tmp, 'relsales', 'Unit sales (%)')
setnames(tmp, 'relelast', 'Distribution elasticity (%)')
setnames(tmp, 'optimal', 'Optimal (%)')

ret=kable(tmp, digits=c(0,0,3,3,1,1,1), 
          caption = tab(paste0('Allocation of Expenditure on Distribution'), prefix='A'),
          format='html',
          initial.zero = FALSE) %>% 
      add_header_above(list(' '=4, 'Allocation proportional to' =3)) %>% kable_styling() %>% footnote(number = paste0('Categories shown in alphabetical order. Predicted distribution elasticities shown for a leading brand active in multiple categories in Indonesia. Unit sales are a brand’s average unit sales in the data, scaled by a constant to preserve the anonymity of the brand. The expected brand growth index is computed as the annual percentage change in unit sales for the chosen brand, averaged over the last three years in the data. The “optimal” allocation is based on the decision rule developed in Fischer et al. (2011).'))

ret
```

# Figures

## Marketing elasticities

```{r echo=FALSE, message=FALSE}

dt = rbindlist(lapply(model_results, function(x) x$predictions))
dt <- dt[brand%in%brand_choice3 & category == 'phones_smart']

dt[, abs_val:=dv_pred]
dt[grepl('pr$', variable), abs_val:=-(dv_pred)]
dt[, rel_val:=abs_val/sum(abs_val), by =c('category','country','brand')]
    
tmp = dcast.data.table(dt, category+country+brand~variable, value.var='abs_val')

tmp2 = tmp[, lapply(.SD, mean,na.rm=T),by=country, .SDcol=ordered_vars]
eval(parse(text=paste0('tmp2[, sum:=', paste0(ordered_vars,collapse='+'),']')))

tmp3 = melt(tmp2, id.vars='country')

setkey(tmp3, country, variable)
setkey(dt, country, variable)
    
tmp3[dt, printvar:=i.dv_pred]


format_number <- function(x) {
  sub('^(-)?0[.]', '\\1.', formatC(x, digits=3,
          flag="", format="f"))
}

    
tmp3[, printvar2:=format_number(printvar)]
tmp3$country<-str_to_title(tmp3$country) 

levs=unlist(tmp3[variable=='sum',1])[order(tmp3[variable=='sum']$value)]
    
tmp3[, country:=factor(as.character(country), levels = levs)]

tmp[, variable_label:=as.character('')]

tmp3[, variable_label:=names(ordered_vars)[match(variable, unlist(ordered_vars))]]

tmp3[, variable_label:=factor(variable_label, levels=rev(unique(names(ordered_vars))))]
levels(tmp3$variable_label) <- gsub(' elasticity', '', tmp3$variable_label)
    
tmp3[, sortval:=value[variable=='sum'], by=c('country')]
    

sorted_country =as.character(unique(tmp3[order(tmp3$sortval)]$country))

tmp3[, country:=factor(country,levels=(sorted_country))]

pl <- ggplot(tmp3[!variable %in% 'sum'],
       aes(
         fill = variable_label,
         y = value,
         x = country,
         label = printvar2
       )) + geom_bar(position = "stack", stat = "identity")  + scale_fill_grey(start = .6, end = .9) + coord_flip() +
  theme_bw() + ylab('Magnitude of Marketing Elasticities') +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  xlab('Country') +
  theme(legend.position = 'bottom') + guides(fill = guide_legend(reverse = TRUE)) +
  labs(fill = 'Elasticities', caption = '') +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

pl

png('../output/JMR.19.0501.R2_figure3.png', res=300, units='in', height=4, width=6)
print(pl)
dev.off()

pdf('../output/JMR.19.0501.R2_figure3.pdf', height=5, width=7)
print(pl)
dev.off()

```

