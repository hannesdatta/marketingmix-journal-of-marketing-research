---
title: "GfK Singapore - WLS"
output:
  html_document: default
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(stargazer)
library(knitr)
#require(xtable)
#require(texreg)
library(lme4)

options(xtable.comment = FALSE)

# Load data
  elast <- fread('../externals/elast_results_MCI_wlag_wotrend.csv')
  #elast <- fread('../externals/elast_results_MCI_wolag_trend.csv')

# Load auxilary functions
  source('proc_auxilary.R')

# load extra variables
  hdi <- fread('../temp/hdi.csv')
# change taiwan (reported value from China is not reliable)
  hdi[, hdi2010:=ifelse(country=='taiwan', mean(hdi2010[country%in%c('thailand', 'china')]), hdi2010)]
# Load GDP
  gdp <- fread('../temp/gdp.csv')
# Merge
  setkey(hdi, country)
  setkey(elast, country)
  elast[hdi, hdi2010:=i.hdi2010]
  setkey(gdp, country)
  elast[gdp, gdppercap2010:=i.gdppercap2010]


# take natural log of variables
vars=c('herf','c3','c5','market_growth','hdi2010','gdppercap2010', 'ncat_in_country', 'ncountry_in_category')

for (var in vars) {
  elast[, (paste0('ln_', var)):=log(get(var))]
  
}

# grand-mean centering by variable (llen, etc.) for all explanatory (continuous) variables
for (var in unique(drop(unlist(lapply(vars, grep, colnames(elast), value=T))))) {
  elast[, (paste0(var, '_mc')):=get(var)-mean(get(var)), by = c('variable')]
  }
  
# focal dummies: local_to_market, western (versus asian)

#
elast[, worldbank := '']
elast[country%in%c('india','indonesia', 'vietnam', 'philippines'), worldbank:='lowermid']
elast[country%in%c('china', 'malaysia','thailand'), worldbank:='uppermid']
elast[worldbank=='', worldbank:='high']


### keep global brands, >2 countries >3 countries
elast=elast[globalbrand==T]
#elast=elast[ncountries>=2]


```

- all analyses conducted with WLS, whereby weights correspond to inverse standard errors of estimated short- or long-term elasticities.
- all continuous variables are logged (and mean-centered when entering as interactions)

# sample overview

```{r sample_overview, echo=FALSE, results='asis'}

tmp=elast[, list(ncountries=length(unique(country)), ncategories=length(unique(category))), by = c('brand')]
setorderv(tmp, c('ncountries','ncategories'),order=-1L)
print(xtable(tmp, caption=tab('Overview of selected brands')), type='html',caption.placement='top')

```

# degree of development

- GDP per capita in 2010, in USD
- Human Development Index in 2010 (imputed for Taiwan as mean of China and Thailand)

```{r devel, echo = FALSE}
tmp=unique(elast, by='country')[, c('country','gdppercap2010','hdi2010'),with=F]
setorderv(tmp, c('gdppercap2010'), order=-1L)
kable(tmp, caption=tab('Development indicators for countries in sample'))
```
# Descriptives

(to be done)

# Combined analysis

Using WLS, with random effects for countries, categories, and brands.

(to be done)

# investigate different versions of an emerging country variable

Following regressions are all estimated by OLS, using brand and category fixed effects (not shown in regression tables).

## log GDP per cap

```{r rq1_regs, echo = FALSE, results='asis'}

out=regmodel(formula=~1+ln_gdppercap2010 + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')
```

## Human Development Index
```{r hdireg, echo = FALSE, results='asis'}

out=regmodel(formula=~1+ln_hdi2010 + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')
```

## 2 classes: Taiwan as high-income
```{r twoclasses, echo = FALSE, results='asis'}

out=regmodel(formula=~1+I(country_class=='linc') + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')
```

## 2 classes: Taiwan as low-income

```{r twoclasses2, echo = FALSE, results='asis'}
elast[,linc_recode:=ifelse(country_class=='linc'|country=='taiwan', 1,0)]

out=regmodel(formula=~1+linc_recode + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')
```


## 3 classes by worldbank

```{r rq2bb, echo = FALSE}
tmp=elast[, list(.N, gdp_per_cap=mean(gdppercap2010), hdi=mean(hdi2010)), by = c('worldbank','country')][, N:=NULL]
setorderv(tmp, 'gdp_per_cap', order=-1L)
kable(tmp, caption=tab('Country classification: Worldbank'))
```

```{r threeclass, echo = FALSE, results='asis'}

out=regmodel(formula=~1+worldbank + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')
```

## 3 classes by worldbank, with Taiwan as lowermid instead of high
```{r threeclass2, echo = FALSE, results='asis'}
elast[, worldbank_recode:=worldbank]
elast[country=='taiwan', worldbank_recode:='uppermid']

out=regmodel(formula=~1+worldbank_recode + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')
```


# interaction analysis (continuing with log GDP)

Following regressions are all estimated by OLS, using brand and category fixed effects (not shown in regression tables). Continuous variables logged. All terms entering in interactions have been grand-mean centered. 

Note: Interaction terms displayed with : instead of *. 

# 1. local versus foreign brands

```{r cootable, echo = FALSE}
tmp=elast[, list(N=length(unique(brand))), by = c('market_id', 'local_to_market')]
tmp=dcast(tmp, market_id ~ local_to_market, value.var='N')
setnames(tmp, c('market_id', 'nonlocal', 'local'))
tmp[is.na(local), local:=0]
tmp[is.na(nonlocal), nonlocal:=0]

tmp[, classific :='NA']
tmp[local==0&nonlocal>0, classific:='markets with no local brand']
tmp[local>0&nonlocal==0, classific:='markets with no foreign brand']
tmp[local>0&nonlocal>0, classific:='mixed markets']

tmp=tmp[, list(N=.N), by = c('classific')]

kable(tmp, caption=tab('Markets with local and foreign brands'))
```

```{r r1a, echo = FALSE, results='asis'}

out=regmodel(formula=~1+ln_gdppercap2010_mc*local_to_market + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')

```

## 2. country of origin (Asia versus Western)

```{r r1b, echo = FALSE, results='asis'}

out=regmodel(formula=~1+ln_gdppercap2010_mc*western_brand + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='[(]brand|category')

```

## 3. cross-country presence

X = number of countries a brand is active in a focal category

```{r r2, echo = FALSE, results='asis'}
out=regmodel(formula=~1+ln_gdppercap2010_mc*ln_ncountry_in_category_mc + as.factor(category) + as.factor(brand), dat=elast)

printres(out, omit='brand|category')

```
## 4. within-country representation

X = number of categories a brand is active in a focal country.

```{r r3, echo = FALSE, results='asis'}
out=regmodel(formula=~1+ln_gdppercap2010_mc*ln_ncat_in_country_mc + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')
```

## 5. growth rate

X = growth rate

```{r r5growth, echo = FALSE, results='asis'}

out=regmodel(formula=~1+ln_gdppercap2010_mc*ln_market_growth_mc + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')
```

## 6. concentration

### 6a. Herfindahl index

```{r r5aherf, echo = FALSE, results='asis'}

out=regmodel(formula=~1+ln_gdppercap2010_mc*ln_herf_mc + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')
```

### 6b. C3

```{r r4ac3, echo = FALSE, results='asis'}

out=regmodel(formula=~1+ln_gdppercap2010_mc*ln_c3_mc + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')
```

### 6c. C5

C5 scaled between 0 and 100. Logged.

```{r r4ac5, echo = FALSE, results='asis'}

out=regmodel(formula=~1+ln_gdppercap2010_mc*ln_c5_mc + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')
```

### 7. Necessity

X = Necessity dummy, equaling 1 for washing, microwave and cooling.

```{r r7, echo = FALSE, results='asis'}

out=regmodel(formula=~1+ln_gdppercap2010_mc*necessity + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')
```

