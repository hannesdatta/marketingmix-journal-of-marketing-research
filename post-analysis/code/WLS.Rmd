---
title: "GfK Singapore - WLS"
output:
  html_document: default
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(stargazer)
library(knitr)
require(xtable)
#require(texreg)
library(lme4)

options(xtable.comment = FALSE)

# Load data
  #elast <- fread('../externals/elast_results_MCI_wlag_wotrend.csv')
  elast <- fread('../externals/elast_results_MCI_wolag_trend.csv')

# Load auxilary functions
  source('proc_auxilary.R')

# load extra variables
  hdi <- fread('../temp/hdi.csv')
# change taiwan (reported value from China is not reliable)
  hdi[, hdi2010:=ifelse(country=='taiwan', mean(hdi2010[country%in%c('thailand', 'china')]), hdi2010)]
# Load GDP
  gdp <- fread('../temp/gdp.csv')
# Merge
  setkey(hdi, country)
  setkey(elast, country)
  elast[hdi, hdi2010:=i.hdi2010]
  setkey(gdp, country)
  elast[gdp, gdppercap2010:=i.gdppercap2010]

  elast[, country_of_origin_recode := ifelse(country_of_origin%in%c('local','asian_other'), 'asian', country_of_origin)]
  
  
# take natural log of variables
vars=c('herf','c3','c5','market_growth','hdi2010','gdppercap2010', 'ncat_in_country', 'ncountry_in_category')

for (var in vars) {
  elast[, (paste0('ln_', var)):=log(get(var))]
  
}

# grand-mean centering by variable (llen, etc.) for all explanatory (continuous) variables
for (var in unique(drop(unlist(lapply(vars, grep, colnames(elast), value=T))))) {
  elast[, (paste0(var, '_mc')):=get(var)-mean(get(var)), by = c('variable')]
  }
  
# focal dummies: local_to_market, western (versus asian)

#
elast[, worldbank := '']
elast[country%in%c('india','indonesia', 'vietnam', 'philippines'), worldbank:='lowermid']
elast[country%in%c('china', 'malaysia','thailand'), worldbank:='uppermid']
elast[worldbank=='', worldbank:='high']


### brand selection for analysis
elast=elast[globalbrand==T] # global brands (active in >=3 countries) only

#elast=elast[ncountries>=2]

```

- all analyses conducted with WLS, whereby weights correspond to inverse standard errors of estimated short- or long-term elasticities.
- all continuous variables are logged (and mean-centered when entering as interactions)

# Sample

## Selected brands

```{r sample_overview, echo=FALSE, results='asis'}

tmp=elast[, list(ncountries=length(unique(country)), ncategories=length(unique(category))), by = c('brand')]
setorderv(tmp, c('ncountries','ncategories'),order=-1L)
print(xtable(tmp, caption=tab('Overview of selected brands')), type='html',caption.placement='top')

```

## Elasticities for selected brands

Significance tested at p<.1 (|z| >= 1.64)

```{r elast_ov, echo = FALSE, results='asis'}
  .vars=c('llen','wpswdst','rwpspr','nov6sh')
	
  zval=qnorm(.95)
  
	tmp=elast[!is.na(elast), list(median_elast = median(elast), 
												  w_elast = sum(elast/elast_se)/sum(1/elast_se), 
												  N_brands= .N, 
												  perc_positive = length(which(elast/elast_se>=(zval)))/.N, 
												  perc_null = length(which(abs(elast/elast_se)<zval))/.N, 
												  perc_negative = length(which(elast/elast_se<=(-zval)))/.N), by=c('variable')]
	kable(tmp[match(.vars, variable)], caption = tab('Short-term elasticities by variable'))
	
  tmp=elast[!is.na(elastlt), list(median_elast = median(elastlt), 
												  w_elast = sum(elastlt/elastlt_se)/sum(1/elastlt_se), 
												  N_brands= .N, 
												  perc_positive = length(which(elastlt/elastlt_se>=(zval)))/.N, 
												  perc_null = length(which(abs(elastlt/elastlt_se)<zval))/.N, 
												  perc_negative = length(which(elastlt/elastlt_se<=(-zval)))/.N), by=c('variable')]
	kable(tmp[match(.vars, variable)], caption = tab('Long-term elasticities by variable'))

```


# degree of development

- GDP per capita in 2010, in USD
- Human Development Index in 2010 (imputed for Taiwan as mean of China and Thailand)

```{r devel, echo = FALSE}
tmp=unique(elast, by='country')[, c('country','gdppercap2010','hdi2010'),with=F]
setorderv(tmp, c('gdppercap2010'), order=-1L)
kable(tmp, caption=tab('Development indicators for countries in sample'))
```

# Descriptives

(to be done)

# Investigate different versions of an emerging country variable (GDP versus HDI)

Following regressions are all estimated by OLS, using brand and category fixed effects (not shown in regression tables).

## log GDP per cap

```{r rq1_regs, echo = FALSE, results='asis'}

out=regmodel(formula=~1+ln_gdppercap2010 + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')
```

## Human Development Index (HDI)

@JB: is HDI used much in the literature?

```{r hdireg, echo = FALSE, results='asis'}

out=regmodel(formula=~1+ln_hdi2010 + as.factor(category) + as.factor(brand), 
                     dat=elast)

printres(out, omit='brand|category')
```

# interaction analysis (continuing with log GDP)

Following regressions are all estimated by OLS, using brand and category fixed effects (not shown in regression tables). Continuous variables logged. All terms entering in interactions have been grand-mean centered. 

Note: Interaction terms displayed with : instead of *. 

# 1. local versus foreign brands

```{r cootable, echo = FALSE}
tmp=elast[, list(N=length(unique(brand))), by = c('market_id', 'local_to_market')]
tmp=dcast(tmp, market_id ~ local_to_market, value.var='N')
setnames(tmp, c('market_id', 'nonlocal', 'local'))
tmp[is.na(local), local:=0]
tmp[is.na(nonlocal), nonlocal:=0]

tmp[, classific :='NA']
tmp[local==0&nonlocal>0, classific:='markets with no local brand']
tmp[local>0&nonlocal==0, classific:='markets with no foreign brand']
tmp[local>0&nonlocal>0, classific:='mixed markets']

tmp=tmp[, list(N=.N), by = c('classific')]

kable(tmp, caption=tab('Markets with local and foreign brands'))
```

```{r r1a, echo = FALSE, results='asis'}

out=regmodel(formula=list(m1=~1+ln_gdppercap2010_mc+local_to_market + as.factor(category),
                          m2=~1+ln_gdppercap2010_mc*local_to_market + as.factor(category)), 
                     dat=elast)

printres(out, omit='category')
```

## 2. country of origin

# 2a. Western versus Asia

```{r r1b, echo = FALSE, results='asis'}

out=regmodel(formula=list(m1=~1+ln_gdppercap2010_mc+western_brand + as.factor(category),
                          m2=~1+ln_gdppercap2010_mc*western_brand + as.factor(category)), 
                     dat=elast)

printres(out, omit='category')

```

# 2b. US versus Europe, versus Asia (baseline)

```{r r1b2, echo = FALSE, results='asis'}

out=regmodel(formula=list(m1=~1+ln_gdppercap2010_mc+country_of_origin_recode + as.factor(category),
                          m2=~1+ln_gdppercap2010_mc*country_of_origin_recode + as.factor(category)), 
                     dat=elast)

printres(out, omit='category')

```

## 3. cross-country presence

X = number of countries a brand is active in a focal category

```{r r2, echo = FALSE, results='asis'}
out=regmodel(formula=list(m1=~1+ln_gdppercap2010_mc+ln_ncountry_in_category_mc + as.factor(category), 
                          m2=~1+ln_gdppercap2010_mc*ln_ncountry_in_category_mc + as.factor(category)), dat=elast)

printres(out, omit='[(]category')

```
## 4. within-country representation

X = number of categories a brand is active in a focal country.

```{r r3, echo = FALSE, results='asis'}
out=regmodel(formula=list(m1=~1+ln_gdppercap2010_mc+ln_ncat_in_country_mc + as.factor(category),
                          m2=~1+ln_gdppercap2010_mc*ln_ncat_in_country_mc + as.factor(category)),
                     dat=elast)

printres(out, omit='category')
```

## 5. growth rate

X = growth rate

```{r r5growth, echo = FALSE, results='asis'}

out=regmodel(formula=list(m1=~1+ln_gdppercap2010_mc+ln_market_growth_mc + as.factor(brand),
                          m2=~1+ln_gdppercap2010_mc*ln_market_growth_mc + as.factor(brand)),
                     dat=elast)

printres(out, omit='brand')
```

## 6. concentration

### 6a. Herfindahl index

```{r r5aherf, echo = FALSE, results='asis'}

out=regmodel(formula=list(m1=~1+ln_gdppercap2010_mc+ln_herf_mc + as.factor(brand),
                          m2=~1+ln_gdppercap2010_mc*ln_herf_mc + as.factor(brand)),
                     dat=elast)

printres(out, omit='brand')
```

### 6b. C5

C5 scaled between 0 and 100. Logged.

```{r r4ac5, echo = FALSE, results='asis'}

out=regmodel(formula=list(m1=~1+ln_gdppercap2010_mc+ln_c5_mc + as.factor(category), 
                          m2=~1+ln_gdppercap2010_mc*ln_c5_mc + as.factor(category)),
                     dat=elast)

printres(out, omit='category')
```

### 7. Necessity

X = Necessity dummy, equaling 1 for washing, microwave and cooling.

@JB: do you have an idea how to obtain a continous measure for necessity? Alternatively, can you come up with other interesting category-level variables that are worth including? 

```{r r7, echo = FALSE, results='asis'}

out=regmodel(formula=list(m1=~1+ln_gdppercap2010_mc+necessity + as.factor(brand), 
                          m2=~1+ln_gdppercap2010_mc*necessity + as.factor(brand)),
                     dat=elast)

printres(out, omit='brand')
```


# Combined analysis

## Using WLS, without any fixed effects

### with Western brand

```{r combined1, echo = FALSE, results='asis'}

basemodel = ~1+ln_gdppercap2010_mc
category_factors=. ~ . + necessity + ln_market_growth_mc + ln_herf_mc
brand_factors=. ~ . + local_to_market + western_brand + ln_ncat_in_country_mc + ln_ncountry_in_category_mc
interact1 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc +
  local_to_market*ln_gdppercap2010_mc + western_brand*ln_gdppercap2010_mc
interact2 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc + ln_herf_mc*ln_gdppercap2010_mc +
  local_to_market*ln_gdppercap2010_mc + western_brand*ln_gdppercap2010_mc + ln_ncat_in_country_mc*ln_gdppercap2010_mc + ln_ncountry_in_category_mc*ln_gdppercap2010_mc

m2=update(basemodel, category_factors)
m3=update(m2, brand_factors)
m4=update(m3, interact1)
m5=update(m4, interact2)

models = list(m1=basemodel, m2, m3, m4, m5)

out=regmodel(formula=models,
                     dat=elast)

printres(out, omit=NULL, vars=c('llen'),title='line length', pagebreak=T)
printres(out, omit=NULL, vars=c('nov6sh'),title='novelty', pagebreak=T)
printres(out, omit=NULL, vars=c('rwpspr'),title='price', pagebreak=T)
printres(out, omit=NULL, vars=c('wpswdst'),title='distribution', pagebreak=T)
```

### with Europe/US brand

```{r combined2, echo = FALSE, results='asis'}

basemodel = ~1+ln_gdppercap2010_mc
category_factors=. ~ . + necessity + ln_market_growth_mc + ln_herf_mc
brand_factors=. ~ . + local_to_market + country_of_origin_recode + ln_ncat_in_country_mc + ln_ncountry_in_category_mc
interact1 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc +
  local_to_market*ln_gdppercap2010_mc + country_of_origin_recode*ln_gdppercap2010_mc
interact2 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc + ln_herf_mc*ln_gdppercap2010_mc +
  local_to_market*ln_gdppercap2010_mc + country_of_origin_recode*ln_gdppercap2010_mc + ln_ncat_in_country_mc*ln_gdppercap2010_mc + ln_ncountry_in_category_mc*ln_gdppercap2010_mc

m2=update(basemodel, category_factors)
m3=update(m2, brand_factors)
m4=update(m3, interact1)
m5=update(m4, interact2)

models = list(m1=basemodel, m2, m3, m4, m5)

out=regmodel(formula=models,
                     dat=elast)

printres(out, omit=NULL, vars=c('llen'),title='line length', pagebreak=T)
printres(out, omit=NULL, vars=c('nov6sh'),title='novelty', pagebreak=T)
printres(out, omit=NULL, vars=c('rwpspr'),title='price', pagebreak=T)
printres(out, omit=NULL, vars=c('wpswdst'),title='distribution', pagebreak=T)
```

## random effects for countries, categories, and brands.

## Using WLS, without any fixed effects

### with Western brand

```{r randomcombined1, echo = FALSE, results='asis'}

basemodel = ~1+ln_gdppercap2010_mc + (1|brand) + (1|category) + (1|country)
category_factors=. ~ . + necessity + ln_market_growth_mc + ln_herf_mc
brand_factors=. ~ . + local_to_market + western_brand + ln_ncat_in_country_mc + ln_ncountry_in_category_mc
interact1 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc +
  local_to_market*ln_gdppercap2010_mc + western_brand*ln_gdppercap2010_mc
interact2 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc + ln_herf_mc*ln_gdppercap2010_mc +
  local_to_market*ln_gdppercap2010_mc + western_brand*ln_gdppercap2010_mc + ln_ncat_in_country_mc*ln_gdppercap2010_mc + ln_ncountry_in_category_mc*ln_gdppercap2010_mc

m2=update(basemodel, category_factors)
m3=update(m2, brand_factors)
m4=update(m3, interact1)
m5=update(m4, interact2)

models = list(m1=basemodel, m2, m3, m4, m5)

out=regmodel(formula=models,
                     dat=elast, model='lmer')

printres(out, omit=NULL, vars=c('llen'),title='line length with random effects', pagebreak=T)
printres(out, omit=NULL, vars=c('nov6sh'),title='novelty with random effects', pagebreak=T)
printres(out, omit=NULL, vars=c('rwpspr'),title='price with random effects', pagebreak=T)
printres(out, omit=NULL, vars=c('wpswdst'),title='distribution with random effects', pagebreak=T)
```

### with Europe/US brand

```{r randomcombined2, echo = FALSE, results='asis'}

basemodel = ~1+ln_gdppercap2010_mc + (1|brand) + (1|category) + (1|country)
category_factors=. ~ . + necessity + ln_market_growth_mc + ln_herf_mc
brand_factors=. ~ . + local_to_market + country_of_origin_recode + ln_ncat_in_country_mc + ln_ncountry_in_category_mc
interact1 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc +
  local_to_market*ln_gdppercap2010_mc + country_of_origin_recode*ln_gdppercap2010_mc
interact2 = . ~ . + necessity*ln_gdppercap2010_mc + ln_market_growth_mc*ln_gdppercap2010_mc + ln_herf_mc*ln_gdppercap2010_mc +
  local_to_market*ln_gdppercap2010_mc + country_of_origin_recode*ln_gdppercap2010_mc + ln_ncat_in_country_mc*ln_gdppercap2010_mc + ln_ncountry_in_category_mc*ln_gdppercap2010_mc

m2=update(basemodel, category_factors)
m3=update(m2, brand_factors)
m4=update(m3, interact1)
m5=update(m4, interact2)

models = list(m1=basemodel, m2, m3, m4, m5)

out=regmodel(formula=models,
                     dat=elast, model='lmer')

printres(out, omit=NULL, vars=c('llen'),title='line length with random effects', pagebreak=T)
printres(out, omit=NULL, vars=c('nov6sh'),title='novelty with random effects', pagebreak=T)
printres(out, omit=NULL, vars=c('rwpspr'),title='price with random effects', pagebreak=T)
printres(out, omit=NULL, vars=c('wpswdst'),title='distribution with random effects', pagebreak=T)
```

